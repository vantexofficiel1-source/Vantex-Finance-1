<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VANTEX - Syst√®me de Paiement</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE ‚Äî initialisation unique
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyBWiWzqdhEsdnOt-KLs8SGbBHHksWpXzmE",
  authDomain: "vantex-officiel.firebaseapp.com",
  projectId: "vantex-officiel",
  storageBucket: "vantex-officiel.firebasestorage.app",
  messagingSenderId: "51998982285",
  appId: "1:51998982285:web:8f71e34a0e595b9a73e2c4",
  measurementId: "G-EJN7ZNJEB7"
};

// √âviter le double-init si le script est recharg√©
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();
console.log('üî• Firebase connect√©');

// ‚îÄ‚îÄ √âcriture sur Firebase ‚îÄ‚îÄ
window.saveToFirebase = async function(collection, data) {
    try {
        const docId = data.id ? data.id.toString() : Date.now().toString();
        await db.collection(collection).doc(docId).set(data);
    } catch (e) { console.error('‚ùå saveToFirebase:', e); }
};

window.deleteFromFirebase = async function(collection, id) {
    try {
        await db.collection(collection).doc(id.toString()).delete();
    } catch (e) { console.error('‚ùå deleteFromFirebase:', e); }
};

window.deleteByEmailFromFirebase = async function(collection, email) {
    try {
        const snapshot = await db.collection(collection).where('accountEmail', '==', email).get();
        const batch = db.batch();
        snapshot.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
    } catch (e) { console.error('‚ùå deleteByEmailFromFirebase:', e); }
};

// ‚îÄ‚îÄ Lecture depuis Firebase ‚îÄ‚îÄ
window.getFromFirebase = async function(collection) {
    try {
        const snapshot = await db.collection(collection).get();
        const items = [];
        snapshot.forEach(doc => {
            const data = { id: doc.id, ...doc.data() };
            if (!data.deleted) items.push(data);
        });
        return items;
    } catch (e) { console.error('‚ùå getFromFirebase:', e); return []; }
};

// ‚îÄ‚îÄ Intercepteur localStorage ‚Üí Firebase (√©criture automatique) ‚îÄ‚îÄ
const originalSetItem = localStorage.setItem.bind(localStorage);
window._originalSetItem = originalSetItem;  // ‚úÖ Expos√© pour usage interne
localStorage.setItem = function(key, value) {
    originalSetItem(key, value);
    try {
        if (key === 'vantex_accounts')
            JSON.parse(value).forEach(acc => saveToFirebase('accounts', acc));
        else if (key === 'vantex_transactions')
            JSON.parse(value).forEach(tx => saveToFirebase('transactions', tx));
        else if (key === 'vantex_transfers')
            JSON.parse(value).forEach(tr => saveToFirebase('transfers', tr));
        else if (key === 'vantex_notifications')
            JSON.parse(value).forEach(n => saveToFirebase('notifications', n));
        else if (key === 'vantex_settings')
            saveToFirebase('settings', { id: 'global', ...JSON.parse(value) });
        else if (key === 'vantex_transfer_settings')
            saveToFirebase('settings', { id: 'transfer', ...JSON.parse(value) });
        else if (key === 'vantex_admin')
            saveToFirebase('settings', { id: 'admin', ...JSON.parse(value) });
    } catch(e) { console.error('‚ùå localStorage sync:', e); }
};

// ‚îÄ‚îÄ Chargement initial + restauration session ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', async function() {
    console.log('üîÑ Chargement Firebase...');
    try {
        const fbAcc = await getFromFirebase('accounts');
        if (fbAcc.length > 0) originalSetItem('vantex_accounts', JSON.stringify(fbAcc));

        const fbTx = await getFromFirebase('transactions');
        if (fbTx.length > 0) {
            const local  = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
            const ids    = new Set(local.map(t => String(t.id)));
            const merged = [...local, ...fbTx.filter(t => !ids.has(String(t.id)))];
            originalSetItem('vantex_transactions', JSON.stringify(merged));
        }

        const fbTr = await getFromFirebase('transfers');
        if (fbTr.length > 0) originalSetItem('vantex_transfers', JSON.stringify(fbTr));

        const fbNf = await getFromFirebase('notifications');
        if (fbNf.length > 0) originalSetItem('vantex_notifications', JSON.stringify(fbNf));

        // PARAM√àTRES (settings, transfer_settings, admin)
        try {
            const fbSettings = await db.collection('settings').get();
            fbSettings.forEach(doc => {
                const d = doc.data();
                if (d.id === 'global') {
                    const { id, ...s } = d;
                    originalSetItem('vantex_settings', JSON.stringify(s));
                } else if (d.id === 'transfer') {
                    const { id, ...s } = d;
                    originalSetItem('vantex_transfer_settings', JSON.stringify(s));
                } else if (d.id === 'admin') {
                    const { id, ...s } = d;
                    originalSetItem('vantex_admin', JSON.stringify(s));
                }
            });
        } catch(e) { console.log('settings load:', e); }

        console.log('‚úÖ Chargement termin√©');

        // Splash minimum 4 secondes, puis retrait avec fade
        const splash = document.getElementById('vx-session-splash');
        const splashStart = Date.now();
        const MIN_SPLASH = 4000; // 4 secondes minimum

        function hideSplash() {
            const elapsed = Date.now() - splashStart;
            const remaining = Math.max(0, MIN_SPLASH - elapsed);
            setTimeout(() => {
                if (splash) {
                    splash.style.transition = 'opacity 0.5s ease';
                    splash.style.opacity = '0';
                    setTimeout(() => splash.remove(), 500);
                }
            }, remaining);
        }

        // Restauration automatique de session au rechargement
        const savedSession = localStorage.getItem('vantex_session');
        if (savedSession) {
            try {
                const session = JSON.parse(savedSession);
                if (session && session.type === 'client' && session.email) {
                    const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
                    const account = accounts.find(a => a.email === session.email);
                    if (account && account.status !== 'blocked') {
                        window._sessionToRestore = account;
                    }
                }
            } catch(e) {}
        }



        hideSplash();
    } catch(e) { console.error('‚ùå Chargement initial:', e); }
});

// ‚îÄ‚îÄ Temps r√©el : onSnapshot (tous appareils mis √† jour instantan√©ment) ‚îÄ‚îÄ
db.collection('accounts').onSnapshot(snapshot => {
    const accounts = [];
    snapshot.forEach(doc => { const d = doc.data(); if (!d.deleted) accounts.push(d); });
    if (!accounts.length) return;
    originalSetItem('vantex_accounts', JSON.stringify(accounts));

    if (window.currentUser) {
        const updated = accounts.find(a => a.email === window.currentUser.email);
        if (updated) {
            if (updated.status === 'blocked') {
                alert('‚ö†Ô∏è Votre compte a √©t√© suspendu. Contactez l\'administrateur.');
                localStorage.removeItem('vantex_session');
                window.currentUser = null;
                document.getElementById('loginScreen').style.display  = 'flex';
                document.getElementById('clientInterface').style.display = 'none';
                return;
            }
            const changed = updated.balance !== window.currentUser.balance;
            const currencyChanged = updated.currency !== window.currentUser.currency;
            window.currentUser = updated;
            if (changed || currencyChanged) {
                const el = document.getElementById('clientBalance');
                if (el && window.balanceVisible !== false) {
                    el.textContent = (typeof formatCurrency === 'function' ? formatCurrency(updated.balance) : updated.balance) + ' ' + (updated.currency || 'GNF');
                }
                // Re-sync Firebase puis mettre √† jour le r√©sum√© avec donn√©es fra√Æches
                if (typeof window._refreshFinanceSummary === 'function') { window._refreshFinanceSummary(); } else if (typeof updateFinanceSummary === 'function') { updateFinanceSummary(); }
                if (typeof drawSparkline === 'function') drawSparkline();
            }
        }
    }
    const adminPanel = document.getElementById('adminPanel');
    if (adminPanel && adminPanel.style.display !== 'none') {
        if (typeof loadAccountsTable === 'function') loadAccountsTable();
        if (typeof loadDashboard     === 'function') loadDashboard();
    }
}, err => console.warn('accounts listener:', err.message));

db.collection('transactions').onSnapshot(snapshot => {
    const txs = [];
    snapshot.forEach(doc => txs.push(doc.data()));
    if (!txs.length) return;
    originalSetItem('vantex_transactions', JSON.stringify(txs));
    if (window.currentUser && typeof loadClientTransactions === 'function') loadClientTransactions();
}, err => console.warn('transactions listener:', err.message));

db.collection('transfers').onSnapshot(snapshot => {
    const trs = [];
    snapshot.forEach(doc => trs.push(doc.data()));
    originalSetItem('vantex_transfers', JSON.stringify(trs));
    if (window.currentUser && typeof loadClientTransactions === 'function') loadClientTransactions();
    const adminPanel = document.getElementById('adminPanel');
    if (adminPanel && adminPanel.style.display !== 'none') {
        if (typeof loadTransfersTable === 'function') loadTransfersTable();
    }
}, err => console.warn('transfers listener:', err.message));

db.collection('notifications').onSnapshot(snapshot => {
    const notifs = [];
    snapshot.forEach(doc => { const d = doc.data(); if (d.active !== false) notifs.push(d); });
    originalSetItem('vantex_notifications', JSON.stringify(notifs));

    // Si le client est connect√©, relancer la boucle de notification imm√©diatement
    if (window.currentUser && typeof startClientNotifLoop === 'function') {
        startClientNotifLoop();
    }
}, err => console.warn('notifications listener:', err.message));

// Settings (param√®tres admin, frais, mot de passe)
db.collection('settings').onSnapshot(snapshot => {
    snapshot.forEach(doc => {
        const d = doc.data();
        if (d.id === 'global')    { const { id, ...s } = d; originalSetItem('vantex_settings', JSON.stringify(s)); }
        else if (d.id === 'transfer') { const { id, ...s } = d; originalSetItem('vantex_transfer_settings', JSON.stringify(s)); }
        else if (d.id === 'admin') {
                    const { id, ...s } = d;
                    // Merger avec les champs s√©curit√© existants pour ne pas les √©craser
                    const existing = JSON.parse(localStorage.getItem('vantex_admin') || '{}');
                    const merged = {
                        ...s,
                        password2:        s.password2        || existing.password2        || '',
                        securityQuestion: s.securityQuestion || existing.securityQuestion || '',
                        securityAnswer:   s.securityAnswer   || existing.securityAnswer   || '',
                        totpSecret:       s.totpSecret       || existing.totpSecret       || 'JBSWY3DPEHPK3PXP',
                        totpConfigured:   s.totpConfigured   || existing.totpConfigured   || false,
                        loginAttempts:    existing.loginAttempts || 0,
                        blockedUntil:     existing.blockedUntil  || null,
                    };
                    originalSetItem('vantex_admin', JSON.stringify(merged));
                }
    });
}, err => console.warn('settings listener:', err.message));

console.log('‚úÖ Firebase sync temps r√©el multi-appareils actif');
</script> <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #0066CC;
            --light-blue: #B8E0E8;
            --dark-text: #1a1a1a;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --success: #4CAF50;
            --danger: #f44336;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);

            /* ‚îÄ‚îÄ Th√®me client personnalisable ‚îÄ‚îÄ */
            --cl-bg:        #0a0e1a;
            --cl-card:      #0d1b3e;
            --cl-card2:     #0a2a6e;
            --cl-accent:    #1a3abf;
            --cl-accent2:   #2550e8;
            --cl-green:     #00e5a0;
            --cl-red:       #ff6b6b;
            --cl-nav:       #0a0e1a;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light-gray);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
            background: 
                linear-gradient(135deg, rgba(10,30,80,0.88) 0%, rgba(0,80,160,0.80) 50%, rgba(10,30,80,0.92) 100%),
                url('https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=1200&q=80') center/cover no-repeat;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0,120,255,0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0,200,255,0.10) 0%, transparent 50%);
            pointer-events: none;
        }

        .login-container::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0066ff, #00c8ff, #0066ff);
        }

        .login-box {
            background: rgba(255,255,255,0.97);
            padding: 30px 28px;
            border-radius: 22px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.1);
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.5s ease;
            position: relative;
            z-index: 1;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo h1 {
            color: var(--primary-blue);
            font-size: 32px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-text);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,102,204,0.3);
        }

        .user-type-switch {
            text-align: center;
            margin-top: 20px;
        }

        .user-type-switch button {
            background: none;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
        }

        /* Client Interface */
        .client-container {
            display: none;
            min-height: 100vh;
            background: #f0f4f8;
            position: relative;
        }

        .client-bg-photo {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 240px;
            background: 
                linear-gradient(160deg, rgba(0,30,100,0.92) 0%, rgba(0,80,200,0.85) 60%, rgba(0,150,200,0.80) 100%),
                url('https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=1200&q=80') center/cover no-repeat;
            z-index: 0;
        }

        .header {
            background: transparent;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: none;
            position: relative;
            z-index: 1;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }

        .logo-icon {
            width: 35px;
            height: 35px;
            background: var(--primary-blue);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .notification-btn, .user-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification-btn {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .notification-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-avatar {
            background: rgba(255,255,255,0.25);
            color: white;
            font-weight: 700;
            font-size: 14px;
            border: 2px solid rgba(255,255,255,0.5);
        }

        .welcome {
            position: relative;
            z-index: 1;
            padding: 14px 16px 0px;
            background: transparent;
        }

        .welcome h2 {
            font-size: 17px;
            color: white;
            margin-bottom: 2px;
            font-weight: 700;
            text-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }

        .last-login-badge {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 0;
        }

        /* Carte premium */
        .balance-card {
            background: linear-gradient(135deg, #0a1e5e 0%, #0055b3 55%, #0099cc 100%);
            margin: 12px;
            padding: 22px 20px 20px;
            border-radius: 22px;
            box-shadow: 0 12px 40px rgba(0,80,180,0.35);
            position: relative;
            z-index: 1;
            overflow: hidden;
            color: white;
        }

        /* Cercles d√©coratifs */
        .balance-card::before {
            content: '';
            position: absolute;
            top: -40px; right: -40px;
            width: 160px; height: 160px;
            background: rgba(255,255,255,0.07);
            border-radius: 50%;
        }
        .balance-card::after {
            content: '';
            position: absolute;
            bottom: -30px; left: -20px;
            width: 120px; height: 120px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }

        .balance-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.75);
            font-size: 12px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .checkmark {
            color: #4dff91;
            font-size: 14px;
        }

        .balance-amount {
            font-size: 34px;
            font-weight: 800;
            color: white;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
            transition: filter 0.3s ease, opacity 0.3s ease;
        }

        .account-subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            margin-bottom: 18px;
        }

        /* Graphique sparkline */
        .sparkline-wrap {
            margin-bottom: 20px;
        }
        .sparkline-label {
            font-size: 10px;
            color: rgba(255,255,255,0.55);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Raccourcis redessin√©s */
        .action-buttons {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            margin-bottom: 4px;
        }

        .action-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 8px 8px;
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.25s;
            font-size: 11px;
            color: white;
            flex: 1;
            min-width: 0;
            backdrop-filter: blur(4px);
        }

        .action-btn:hover, .action-btn:active {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .action-btn .btn-icon {
            width: 38px;
            height: 38px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .action-btn.full-width {
            grid-column: unset;
            flex: none;
            width: 100%;
        }

        .transactions-section {
            padding: 16px 16px 0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 14px;
            color: var(--dark-text);
        }

        /* Groupe de date */
        .tx-date-group {
            font-size: 11px;
            font-weight: 700;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 8px 4px 6px;
        }

        .no-transactions {
            background: white;
            padding: 40px 20px;
            border-radius: 15px;
            text-align: center;
            color: #666;
        }

        .no-transactions-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .transaction-item {
            background: white;
            padding: 14px 16px;
            border-radius: 14px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: box-shadow 0.2s;
        }

        .transaction-item:active {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .transaction-info h4 {
            margin-bottom: 3px;
            color: var(--dark-text);
            font-size: 14px;
        }

        .transaction-date {
            color: #999;
            font-size: 12px;
        }

        .transaction-amount {
            font-size: 16px;
            font-weight: 700;
        }

        .transaction-amount.positive { color: #27ae60; }
        .transaction-amount.negative { color: #e74c3c; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--cl-nav);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
            z-index: 100;
        }
        /* Couvrir la barre blanche du bas sur iOS/Android */
        .bottom-nav::after {
            content: '';
            position: absolute;
            bottom: calc(-1 * env(safe-area-inset-bottom, 20px));
            left: 0;
            right: 0;
            height: calc(env(safe-area-inset-bottom, 20px) + 10px);
            background: var(--cl-nav);
        }

        .nav-item {
            color: white;
            text-align: center;
            cursor: pointer;
            flex: 1;
            padding: 3px;
            transition: all 0.3s;
        }

        .nav-item:hover {
            opacity: 0.8;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
        }

        .nav-label {
            font-size: 11px;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           ADMIN PANEL ‚Äî DESIGN PREMIUM
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .admin-container {
            display: none;
            min-height: 100vh;
            background: #f0f2f5;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        /* SIDEBAR */
        .admin-sidebar {
            position: fixed;
            top: 0; left: 0;
            width: 240px;
            height: 100vh;
            background: linear-gradient(180deg, #0a1628 0%, #0d2147 60%, #0a1e5e 100%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.25);
            transition: transform 0.3s;
        }
        .admin-sidebar-logo {
            padding: 24px 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .admin-sidebar-logo .logo-icon-admin {
            width: 40px; height: 40px;
            background: linear-gradient(135deg,#0055b3,#00aaff);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }
        .admin-sidebar-logo span {
            font-size: 18px; font-weight: 800;
            color: white; letter-spacing: 1px;
        }
        .admin-sidebar-logo small {
            display: block; font-size: 10px;
            color: rgba(255,255,255,0.4);
            letter-spacing: 1.5px; text-transform: uppercase;
        }
        .admin-nav {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }
        .admin-nav-section {
            padding: 6px 16px 4px;
            font-size: 10px;
            color: rgba(255,255,255,0.3);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
            margin-top: 8px;
        }
        .admin-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 20px;
            margin: 2px 10px;
            border-radius: 10px;
            cursor: pointer;
            color: rgba(255,255,255,0.55);
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            border: none;
            background: transparent;
            width: calc(100% - 20px);
            text-align: left;
        }
        .admin-nav-item:hover {
            background: rgba(255,255,255,0.07);
            color: rgba(255,255,255,0.9);
        }
        .admin-nav-item.active {
            background: linear-gradient(135deg, rgba(0,85,179,0.6), rgba(0,153,204,0.4));
            color: white;
            box-shadow: 0 4px 15px rgba(0,85,179,0.3);
        }
        .admin-nav-item .nav-icon-admin {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05);
            flex-shrink: 0;
            font-size: 15px;
        }
        .admin-nav-item.active .nav-icon-admin {
            background: rgba(255,255,255,0.15);
        }
        .admin-sidebar-footer {
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }
        .admin-logout-btn {
            width: 100%;
            padding: 11px 16px;
            background: rgba(231,76,60,0.15);
            border: 1px solid rgba(231,76,60,0.3);
            border-radius: 10px;
            color: #ff6b6b;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: flex; align-items: center; gap: 10px;
            transition: all 0.2s;
        }
        .admin-logout-btn:hover {
            background: rgba(231,76,60,0.25);
        }

        /* MAIN CONTENT */
        .admin-main {
            margin-left: 240px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .admin-topbar {
            background: white;
            padding: 0 28px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 0 #e8eaf0;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .admin-topbar-title {
            font-size: 18px;
            font-weight: 800;
            color: #0a1628;
        }
        .admin-topbar-title span {
            font-size: 13px;
            font-weight: 500;
            color: #999;
            margin-left: 8px;
        }
        .admin-topbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .admin-badge {
            background: linear-gradient(135deg,#0055b3,#0099cc);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        .admin-avatar {
            width: 36px; height: 36px;
            background: linear-gradient(135deg,#0a1e5e,#0055b3);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 800;
        }
        .admin-content {
            padding: 28px;
            flex: 1;
        }

        /* TABS */
        .admin-tabs { display: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }
        .stat-card {
            background: white;
            padding: 22px 24px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        .stat-icon {
            width: 52px; height: 52px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }
        .stat-label {
            font-size: 12px;
            color: #999;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 900;
            color: #0a1628;
            line-height: 1;
        }

        /* FORM CARDS */
        .form-card {
            background: white;
            padding: 24px 28px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            margin-bottom: 20px;
        }
        .form-card h3 {
            margin-bottom: 18px;
            color: #0a1628;
            font-size: 16px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 14px;
            border-bottom: 2px solid #f0f2f5;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 7px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 11px 14px;
            border: 2px solid #e8eaf0;
            border-radius: 10px;
            font-size: 14px;
            transition: border 0.2s;
            box-sizing: border-box;
            outline: none;
            background: #fafbfc;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #0055b3;
            background: white;
        }

        /* TABLES */
        .table-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .table-header {
            padding: 18px 24px;
            border-bottom: 2px solid #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .table-header h3 {
            font-size: 15px;
            font-weight: 800;
            color: #0a1628;
            margin: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #f8f9fb;
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #eee;
        }
        td {
            padding: 13px 16px;
            border-bottom: 1px solid #f5f5f7;
            font-size: 13px;
            color: #333;
        }
        tr:hover td { background: #fafbff; }
        tr:last-child td { border-bottom: none; }

        /* BUTTONS */
        .btn { border-radius: 10px; font-weight: 700; padding: 11px 22px; border: none; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg,#0055b3,#0099cc); color: white; box-shadow: 0 4px 14px rgba(0,85,179,0.3); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,85,179,0.4); }
        .btn-small { padding: 6px 12px; border: none; border-radius: 7px; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.2s; }
        .btn-small:hover { opacity: 0.85; transform: translateY(-1px); }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #2980b9; color: white; }

        /* BADGES */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .status-active { background: #e8f5e9; color: #27ae60; }
        .status-blocked { background: #ffebee; color: #e74c3c; }
        .status-pending { background: #fff8e1; color: #f39c12; }

        /* MOBILE SIDEBAR TOGGLE */
        .admin-menu-btn {
            display: none;
            background: none; border: none;
            font-size: 22px; cursor: pointer;
            color: #0a1628;
        }
        @media (max-width: 768px) {
            .admin-sidebar { transform: translateX(-100%); }
            .admin-sidebar.open { transform: translateX(0); }
            .admin-main { margin-left: 0; }
            .admin-menu-btn { display: block; }
            .admin-content { padding: 16px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .stat-value { font-size: 22px; }
        }

        /* Modal */
        /* Modal Profil Client */
        /* ‚ïê‚ïê‚ïê PROFIL MODAL ‚Äî Bottom Sheet sombre ‚ïê‚ïê‚ïê */
        .profile-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(2, 6, 20, 0.82);
            z-index: 9999;
            justify-content: center;
            align-items: flex-end;
            backdrop-filter: blur(8px);
        }
        .profile-modal-overlay.active {
            display: flex;
        }
        .profile-modal-box {
            background: linear-gradient(180deg, #0c1535 0%, #080f25 100%);
            border-radius: 28px 28px 0 0;
            border: 1px solid rgba(100,160,255,0.18);
            border-bottom: none;
            padding: 0;
            width: 100%;
            max-width: 480px;
            position: relative;
            box-shadow: 0 -12px 60px rgba(0, 20, 80, 0.8);
            animation: slideUpProfile 0.32s cubic-bezier(0.34,1.2,0.64,1);
            overflow: hidden;
            max-height: 92vh;
            overflow-y: auto;
        }
        @keyframes slideUpProfile {
            from { transform: translateY(100%); opacity: 0; }
            to   { transform: translateY(0);    opacity: 1; }
        }
        .profile-close-btn {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: 3px solid #080f25;
            border-radius: 50%;
            color: white;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(231,76,60,0.55);
            z-index: 10;
            font-weight: 700;
        }
        .profile-info-row {
            padding: 16px 24px;
            border-bottom: 1px solid rgba(100,160,255,0.09);
        }
        .profile-info-row:last-of-type { border-bottom: none; }
        .profile-info-label {
            font-size: 12px;
            color: rgba(255,255,255,0.38);
            margin-bottom: 5px;
            font-weight: 500;
            letter-spacing: 0.2px;
        }
        .profile-info-value {
            font-size: 17px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.2px;
        }
        .profile-logout-btn {
            border: 1.5px solid rgba(231,76,60,0.55);
            color: #e74c3c;
            background: rgba(231,76,60,0.07);
            padding: 15px 28px;
            border-radius: 14px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }
        .profile-logout-btn:hover {
            background: rgba(231,76,60,0.12);
            border-color: #e74c3c;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--dark-text);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #e8f5e9;
            color: var(--success);
        }

        .alert-error {
            background: #ffebee;
            color: var(--danger);
        }

        @media (max-width: 768px) {
            .action-buttons {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .admin-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .balance-amount {
                font-size: 36px;
            }
        }
        @keyframes fadeInOut {
            from { opacity: 0; transform: translateY(-8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
</style>
</head>
<body>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESTAURATION IMM√âDIATE DE SESSION ‚Äî s'ex√©cute avant tout
// Emp√™che le flash de l'√©cran de connexion au rechargement
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function() {
    try {
        const saved = localStorage.getItem('vantex_session');
        if (!saved) return;
        const session = JSON.parse(saved);
        if (!session || !session.type) return;

        // Splash toujours affich√© au d√©marrage (avec ou sans session)
        const splash = document.createElement('div');
        splash.id = 'vx-session-splash';
        splash.style.cssText = [
            'position:fixed;top:0;left:0;width:100%;height:100%;',
            'background:radial-gradient(ellipse at 30% 20%,#0d1b4b 0%,#050d2e 55%,#020818 100%);',
            'z-index:999999;display:flex;flex-direction:column;',
            'align-items:center;justify-content:center;gap:20px;'
        ].join('');
        splash.innerHTML = [
            '<style>',
            '@keyframes vxPulse{0%,100%{transform:scale(1);box-shadow:0 8px 30px rgba(21,101,192,0.5)}50%{transform:scale(1.04);box-shadow:0 12px 40px rgba(21,101,192,0.8)}}',
            '@keyframes vxFadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}',
            '@keyframes vxBar{0%{width:0%}100%{width:100%}}',
            '</style>',
            '<div style="animation:vxPulse 2s ease-in-out infinite;width:100px;height:100px;',
            'background:linear-gradient(135deg,#1a56db,#2563eb);',
            'border-radius:26px;display:flex;align-items:center;justify-content:center;',
            'box-shadow:0 8px 30px rgba(21,101,192,0.5);">',
            '<span style="color:white;font-size:52px;font-weight:900;font-family:Georgia,serif;">V</span></div>',
            '<div style="animation:vxFadeUp 0.8s ease 0.3s both;text-align:center;">',
            '<p style="color:white;font-size:22px;font-weight:900;letter-spacing:4px;font-family:Georgia,serif;margin-bottom:6px;">VANTEX</p>',
            '<div style="width:50px;height:2px;background:rgba(100,160,255,0.4);border-radius:2px;margin:0 auto;overflow:hidden;">',
            '<div style="height:100%;background:linear-gradient(90deg,#60a5fa,#00d4ff);border-radius:2px;animation:vxBar 3.5s linear forwards;"></div>',
            '</div></div>'
        ].join('');
        document.documentElement.appendChild(splash);
    } catch(e) {}
})();
</script>
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div style="text-align:center; margin-bottom:20px;">
                <div id="secretLogoBtn" style="width:60px; height:60px; background:var(--primary-blue); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 14px; cursor:pointer;" onclick="handleSecretClick()">
                    <span style="color:white; font-size:26px; font-weight:900;">V</span>
                </div>
                <h1 style="color:#1a1a2e; font-size:17px; font-weight:800; margin-bottom:4px;">VANTEX - Votre espace client</h1>
            </div>
            <div id="loginAlert" class="alert"></div>
            <form id="loginForm">

                <!-- Identifiant unique ‚Äî email, t√©l√©phone OU num√©ro de compte -->
                <div class="form-group" style="margin-bottom:14px;">
                    <label style="color:#555;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;">Identifiant</label>
                    <input type="text" id="loginEmail" required
                        placeholder="Email, t√©l√©phone ou n¬∞ de compte"
                        autocomplete="username"
                        style="background:#f8f9fb;border:2px solid #e8ecf0;border-radius:12px;padding:13px 16px;font-size:14px;width:100%;box-sizing:border-box;outline:none;margin-top:6px;transition:border-color 0.2s;"
                        onfocus="this.style.borderColor='var(--primary-blue)'" onblur="this.style.borderColor='#e8ecf0'">
                    <p style="color:#aaa;font-size:11px;margin:5px 0 0 2px;">Entrez votre email, num√©ro de t√©l√©phone ou num√©ro de compte</p>
                </div>

                <!-- Code PIN -->
                <div class="form-group" style="margin-bottom:14px;">
                    <label style="color:#555;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;">Code PIN</label>
                    <input type="password" id="loginPassword" required
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        autocomplete="current-password"
                        style="background:#f8f9fb;border:2px solid #e8ecf0;border-radius:12px;padding:13px 16px;font-size:14px;width:100%;box-sizing:border-box;outline:none;margin-top:6px;transition:border-color 0.2s;"
                        onfocus="this.style.borderColor='var(--primary-blue)'" onblur="this.style.borderColor='#e8ecf0'">
                </div>

                <button type="submit" style="width:100%;padding:15px;background:var(--primary-blue);color:white;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;margin-top:4px;letter-spacing:0.5px;box-shadow:0 4px 16px rgba(0,85,204,0.35);">
                    Se connecter ‚Üí
                </button>
            </form>
            <div class="user-type-switch" style="display:none;">
                <button onclick="switchToAdmin()" style="color: #999;">Connexion Administration</button>
            </div>
        </div>
    </div>

    <!-- Client Interface -->
    <div class="client-container" id="clientInterface" style="background:var(--cl-bg);min-height:100vh;">

        <!-- Spinner -->
        <div id="loadingSpinner" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,14,26,0.85);z-index:99999;align-items:center;justify-content:center;flex-direction:column;">
            <div style="width:48px;height:48px;border:3px solid rgba(255,255,255,0.1);border-top:3px solid #00d4ff;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
            <p id="spinnerText" style="margin-top:14px;color:rgba(255,255,255,0.7);font-size:14px;">Chargement...</p>
        </div>

        <!-- Notification banner -->
        <div id="clientNotifBanner" style="display:none;margin:0 16px;border-radius:12px;padding:12px 16px;font-size:14px;font-weight:600;animation:fadeInOut 0.4s ease;">
            <span id="clientNotifText"></span>
        </div>

        <!-- HEADER -->
        <div style="display:flex;justify-content:space-between;align-items:center;padding:18px 20px 10px;">
            <!-- Logo VANTEX Finance -->
            <div style="display:flex;align-items:center;gap:10px;">
                <div style="width:38px;height:38px;background:linear-gradient(135deg,#1a56db,#2563eb);border-radius:11px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px rgba(26,86,219,0.45);">
                    <span style="color:white;font-size:20px;font-weight:900;font-family:Georgia,serif;">V</span>
                </div>
                <div>
                    <p style="color:white;font-size:15px;font-weight:900;letter-spacing:1.5px;margin:0;font-family:Georgia,serif;">VANTEX</p>
                    <p style="color:rgba(100,160,255,0.8);font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;margin:0;">Finance</p>
                </div>
            </div>
            <!-- Avatar -->
            <div style="display:flex;align-items:center;gap:12px;">
                <div onclick="showProfileModal()" style="cursor:pointer;width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#1a2744,#0052cc);border:2px solid rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:15px;" id="userAvatar">AT</div>
            </div>
        </div>

        <!-- CARTE SOLDE PRINCIPALE -->
        <div style="margin:10px 16px;background:linear-gradient(135deg,var(--cl-card) 0%,var(--cl-card2) 50%,var(--cl-card) 100%);border-radius:24px;padding:24px 22px 20px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.08);box-shadow:0 20px 60px rgba(0,0,80,0.5);">

            <!-- Grille de fond subtile -->
            <div style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:40px 40px;border-radius:24px;"></div>

            <!-- Ligne label + bouton masquer -->
            <!-- Bonjour + Nom dans la carte -->
            <div style="margin-bottom:14px;position:relative;z-index:1;">
                <p style="color:rgba(255,255,255,0.5);font-size:12px;margin:0 0 2px;" id="welcomeMsg">Bonjour üëã</p>
                <p style="color:white;font-size:18px;font-weight:800;margin:0;letter-spacing:0.3px;" id="userName">‚Äî</p>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;position:relative;z-index:1;">
                <span style="color:rgba(255,255,255,0.55);font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;">Solde Total</span>
                <button onclick="toggleBalance()" id="balanceEyeBtn" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);border-radius:20px;padding:5px 14px;color:rgba(255,255,255,0.8);font-size:12px;font-weight:600;cursor:pointer;backdrop-filter:blur(4px);">
                    <svg id="eyeOpenIcon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align:middle;margin-right:4px;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    <svg id="eyeClosedIcon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align:middle;margin-right:4px;display:none;"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                    Masquer
                </button>
            </div>

            <!-- Montant + fl√®che -->
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;position:relative;z-index:1;">
                <span id="clientBalance" style="font-size:32px;font-weight:900;color:white;letter-spacing:-1px;transition:filter 0.3s,opacity 0.3s;">0 GNF</span>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00e5a0" stroke-width="2.5"><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg>
            </div>

            <!-- % semaine -->
            <p style="color:#00e5a0;font-size:13px;font-weight:600;margin:0 0 2px;position:relative;z-index:1;" id="weekPercent">+0% cette semaine</p>
            <p style="color:rgba(255,255,255,0.4);font-size:12px;margin:0 0 16px;position:relative;z-index:1;" id="accountTypeLabel">Compte courant ¬∑ <span id="accountNumMasked">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 0000</span></p>

            <!-- BANDEAU D√âFILANT -->
            <div style="position:relative;z-index:1;margin:14px -22px -20px;overflow:hidden;border-top:1px solid rgba(255,255,255,0.07);padding:10px 0;border-radius:0 0 24px 24px;background:rgba(0,0,0,0.15);">
                <div style="position:absolute;left:0;top:0;bottom:0;width:30px;background:linear-gradient(90deg,rgba(8,15,40,0.9),transparent);z-index:2;pointer-events:none;"></div>
                <div style="position:absolute;right:0;top:0;bottom:0;width:30px;background:linear-gradient(270deg,rgba(8,15,40,0.9),transparent);z-index:2;pointer-events:none;"></div>
                <div style="display:flex;animation:vantexTicker 28s linear infinite;white-space:nowrap;will-change:transform;">
                    <span style="display:inline-flex;align-items:center;gap:7px;padding:0 28px;color:rgba(255,255,255,0.65);font-size:12px;font-style:italic;letter-spacing:0.2px;"><span style="color:#00e5a0;font-size:14px;">‚ú¶</span> Chaque d√©cision financi√®re construit votre avenir.</span>
                    <span style="display:inline-flex;align-items:center;gap:7px;padding:0 28px;color:rgba(255,255,255,0.65);font-size:12px;font-style:italic;letter-spacing:0.2px;"><span style="color:#4da6ff;font-size:14px;">‚ú¶</span> G√©rez vos finances en toute s√©r√©nit√©.</span>
                    <span style="display:inline-flex;align-items:center;gap:7px;padding:0 28px;color:rgba(255,255,255,0.65);font-size:12px;font-style:italic;letter-spacing:0.2px;"><span style="color:#00e5a0;font-size:14px;">‚ú¶</span> Fiable aujourd'hui, solide pour demain.</span>
                    <span style="display:inline-flex;align-items:center;gap:7px;padding:0 28px;color:rgba(255,255,255,0.65);font-size:12px;font-style:italic;letter-spacing:0.2px;"><span style="color:#4da6ff;font-size:14px;">‚ú¶</span> Votre s√©curit√© financi√®re est notre priorit√©.</span>
                    <!-- Duplication pour boucle sans saut -->
                    <span style="display:inline-flex;align-items:center;gap:7px;padding:0 28px;color:rgba(255,255,255,0.65);font-size:12px;font-style:italic;letter-spacing:0.2px;"><span style="color:#00e5a0;font-size:14px;">‚ú¶</span> Chaque d√©cision financi√®re construit votre avenir.</span>
                    <span style="display:inline-flex;align-items:center;gap:7px;padding:0 28px;color:rgba(255,255,255,0.65);font-size:12px;font-style:italic;letter-spacing:0.2px;"><span style="color:#4da6ff;font-size:14px;">‚ú¶</span> G√©rez vos finances en toute s√©r√©nit√©.</span>
                    <span style="display:inline-flex;align-items:center;gap:7px;padding:0 28px;color:rgba(255,255,255,0.65);font-size:12px;font-style:italic;letter-spacing:0.2px;"><span style="color:#00e5a0;font-size:14px;">‚ú¶</span> Fiable aujourd'hui, solide pour demain.</span>
                    <span style="display:inline-flex;align-items:center;gap:7px;padding:0 28px;color:rgba(255,255,255,0.65);font-size:12px;font-style:italic;letter-spacing:0.2px;"><span style="color:#4da6ff;font-size:14px;">‚ú¶</span> Votre s√©curit√© financi√®re est notre priorit√©.</span>
                </div>
                <style>@keyframes vantexTicker{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}</style>
            </div>
        </div>

        <!-- 3 BOUTONS ACTION -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:12px 16px;">
            <button onclick="showIban()" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:18px;padding:18px 10px;cursor:pointer;text-align:center;backdrop-filter:blur(4px);transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.06)'">
                <div style="width:44px;height:44px;background:rgba(255,255,255,0.1);border-radius:50%;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </div>
                <div style="color:white;font-size:13px;font-weight:700;">IBAN</div>
                <div style="color:rgba(255,255,255,0.45);font-size:10px;margin-top:2px;">Voir et partager</div>
            </button>
            <button onclick="openTransferModal()" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:18px;padding:18px 10px;cursor:pointer;text-align:center;backdrop-filter:blur(4px);transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.06)'">
                <div style="width:44px;height:44px;background:rgba(255,255,255,0.1);border-radius:50%;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </div>
                <div style="color:white;font-size:13px;font-weight:700;">Virement</div>
                <div style="color:rgba(255,255,255,0.45);font-size:10px;margin-top:2px;">Envoyer de l'argent</div>
            </button>
            <button onclick="showVirtualCard()" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:18px;padding:18px 10px;cursor:pointer;text-align:center;backdrop-filter:blur(4px);transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.06)'">
                <div style="width:44px;height:44px;background:rgba(255,255,255,0.1);border-radius:50%;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                </div>
                <div style="color:white;font-size:13px;font-weight:700;">Carte</div>
                <div style="color:rgba(255,255,255,0.45);font-size:10px;margin-top:2px;">G√©rer mes plafonds</div>
            </button>
        </div>

        <!-- R√âSUM√â DU MOIS -->
        <div style="margin:4px 16px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:20px;padding:20px;backdrop-filter:blur(4px);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h3 style="color:white;font-size:16px;font-weight:700;margin:0;">R√©sum√© du mois</h3>
                <button onclick="loadClientTransactions();document.getElementById('transactionsList').scrollIntoView({behavior:'smooth'})" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);border-radius:20px;padding:6px 14px;color:rgba(255,255,255,0.8);font-size:12px;font-weight:600;cursor:pointer;">Voir transactions ‚Ä∫</button>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div>
                    <p style="color:rgba(255,255,255,0.45);font-size:12px;margin:0 0 4px;">D√©penses</p>
                    <p style="color:#ff6b6b;font-size:15px;font-weight:700;margin:0;" id="monthExpense">‚Äî 0</p>
                </div>
                <div>
                    <p style="color:rgba(255,255,255,0.45);font-size:12px;margin:0 0 4px;">Revenus</p>
                    <p style="color:#00e5a0;font-size:15px;font-weight:700;margin:0;" id="monthIncome">+ 0</p>
                </div>
                <div>
                    <p style="color:rgba(255,255,255,0.45);font-size:12px;margin:0 0 4px;">Solde net</p>
                    <p style="color:white;font-size:15px;font-weight:700;margin:0;" id="monthNet">+ 0</p>
                </div>
                <div>
                    <p style="color:rgba(255,255,255,0.45);font-size:12px;margin:0 0 4px;">Total d√©pens√©</p>
                    <p style="color:white;font-size:15px;font-weight:700;margin:0;" id="monthTotal">+ 0</p>
                </div>
            </div>
            <!-- S√©curit√© -->
            <div style="margin-top:16px;padding-top:14px;border-top:1px solid rgba(255,255,255,0.07);">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                    <div>
                        <p style="color:rgba(255,255,255,0.5);font-size:11px;margin:0 0 2px;display:flex;align-items:center;gap:5px;">
                            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#00e5a0" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            Compte s√©curis√©
                        </p>
                        <p style="color:rgba(255,255,255,0.35);font-size:10px;margin:0;display:flex;align-items:center;gap:5px;">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                            Connexion chiffr√©e ¬∑ <span id="lastLoginBadge">Derni√®re activit√© : ‚Äî</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORIQUE -->
        <div style="margin:0 16px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:20px;padding:16px;margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h3 style="color:white;font-size:15px;font-weight:700;margin:0;">Historique des transactions</h3>
            </div>
            <div style="display:flex;align-items:center;background:rgba(255,255,255,0.07);border-radius:12px;padding:10px 14px;margin-bottom:12px;gap:8px;border:1px solid rgba(255,255,255,0.08);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="txSearchInput" placeholder="Rechercher..." oninput="filterTransactions()"
                    style="border:none;outline:none;flex:1;font-size:13px;color:white;background:transparent;">
                <select id="txFilterType" onchange="filterTransactions()" style="border:none;outline:none;font-size:12px;color:rgba(255,255,255,0.6);background:transparent;cursor:pointer;">
                    <option value="all">Tout</option>
                    <option value="credit">Entr√©es</option>
                    <option value="debit">Sorties</option>
                </select>
            </div>
            <div id="transactionsList">
                <div style="text-align:center;padding:30px 0;color:rgba(255,255,255,0.3);">
                    <div style="font-size:32px;margin-bottom:8px;">üìã</div>
                    <p style="font-size:13px;margin:0;">Aucune transaction</p>
                </div>
            </div>
        </div>

        <div style="height:80px;"></div>

        <!-- NAV BAS -->
        <div class="bottom-nav" style="background:var(--cl-nav);border-top:1px solid rgba(255,255,255,0.08);">
            <div class="nav-item" style="color:white;">
                <div class="nav-icon">üè†</div>
                <div class="nav-label" style="color:rgba(255,255,255,0.7);">Portefeuille</div>
            </div>
            <div class="nav-item" onclick="openTransferModal()" style="color:white;cursor:pointer;">
                <div class="nav-icon">üí∏</div>
                <div class="nav-label" style="color:rgba(255,255,255,0.7);">Virement</div>
            </div>
            <div class="nav-item" onclick="showVirtualCard()" style="color:white;cursor:pointer;">
                <div class="nav-icon">üí≥</div>
                <div class="nav-label" style="color:rgba(255,255,255,0.7);">Carte</div>
            </div>
            <div class="nav-item" onclick="showProfileModal()" style="color:white;cursor:pointer;">
                <div class="nav-icon">üë§</div>
                <div class="nav-label" style="color:rgba(255,255,255,0.7);">Mon compte</div>
            </div>
            <div class="nav-item" onclick="openClientChat()" style="color:white;cursor:pointer;position:relative;">
                <div class="nav-icon">üí¨</div>
                <div class="nav-label" style="color:rgba(255,255,255,0.7);">Assistant</div>
                <span id="clientUnreadDot" style="display:none;position:absolute;top:4px;right:10px;width:9px;height:9px;background:#e74c3c;border-radius:50%;border:2px solid #0a0e1a;"></span>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-container" id="adminPanel">

        <!-- SIDEBAR -->
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="admin-sidebar-logo">
                <div class="logo-icon-admin">üè¶</div>
                <div>
                    <span>VANTEX</span>
                    <small>Administration</small>
                </div>
            </div>
            <nav class="admin-nav">
                <div class="admin-nav-section">Principal</div>
                <button class="admin-nav-item active" onclick="switchTab('dashboard', this)">
                    <div class="nav-icon-admin">üìä</div> Tableau de bord
                </button>
                <button class="admin-nav-item" onclick="switchTab('accounts', this)">
                    <div class="nav-icon-admin">üë•</div> Gestion des comptes
                </button>
                <div class="admin-nav-section">Op√©rations</div>
                <button class="admin-nav-item" onclick="switchTab('recharge', this)">
                    <div class="nav-icon-admin">üí∞</div> Recharger / D√©biter
                </button>
                <button class="admin-nav-item" onclick="switchTab('transfers', this)">
                    <div class="nav-icon-admin">üí∏</div> Virements
                </button>
                <button class="admin-nav-item" onclick="switchTab('transactions', this)">
                    <div class="nav-icon-admin">üßæ</div> Transactions
                </button>
                <div class="admin-nav-section">Configuration</div>
                <button class="admin-nav-item" onclick="switchTab('settings', this)">
                    <div class="nav-icon-admin">‚öôÔ∏è</div> Param√®tres
                </button>
                <button class="admin-nav-item" onclick="switchTab('notifications', this)">
                    <div class="nav-icon-admin">üîî</div> Notifications
                </button>
                <button class="admin-nav-item" onclick="switchTab('security', this)">
                    <div class="nav-icon-admin">üîí</div> S√©curit√©
                </button>
                <button class="admin-nav-item" onclick="switchTab('support', this)" id="supportNavBtn">
                    <div class="nav-icon-admin">üí¨</div> Support client
                    <span id="adminUnreadBadge" style="display:none;background:#e74c3c;color:white;border-radius:10px;padding:1px 7px;font-size:11px;font-weight:700;margin-left:auto;">0</span>
                </button>
                <button class="admin-nav-item" onclick="switchTab('theme', this)">
                    <div class="nav-icon-admin">üé®</div> Th√®me client
                </button>
            </nav>
            <div class="admin-sidebar-footer">
                <button class="admin-logout-btn" onclick="logoutAdmin()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    D√©connexion
                </button>
            </div>
        </aside>

        <!-- MAIN -->
        <div class="admin-main">

            <!-- TOPBAR -->
            <div class="admin-topbar">
                <div style="display:flex;align-items:center;gap:12px;">
                    <button class="admin-menu-btn" onclick="document.getElementById('adminSidebar').classList.toggle('open')">‚ò∞</button>
                    <div class="admin-topbar-title" id="adminPageTitle">Tableau de bord <span>Vue d'ensemble</span></div>
                </div>
                <div class="admin-topbar-right">
                    <div class="admin-badge">üü¢ En ligne</div>
                    <div class="admin-avatar">AD</div>
                </div>
            </div>

            <div class="admin-content">

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:#e8f4fd;">üë•</div>
                        <div>
                            <div class="stat-label">Total Comptes</div>
                            <div class="stat-value" id="totalAccounts">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:#e8f5e9;">‚úÖ</div>
                        <div>
                            <div class="stat-label">Comptes Actifs</div>
                            <div class="stat-value" id="activeAccounts" style="color:#27ae60;">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:#fce4ec;">üè¶</div>
                        <div>
                            <div class="stat-label">Comptes G√©r√©s</div>
                            <div class="stat-value" id="totalBalance" style="color:#c2185b;font-size:20px;">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:#fff8e1;">‚ö°</div>
                        <div>
                            <div class="stat-label">Transactions Aujourd'hui</div>
                            <div class="stat-value" id="todayTransactions" style="color:#f39c12;">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div id="accountsTab" class="tab-content">
                <div class="form-card">
                    <h3>‚ûï Cr√©er un nouveau compte</h3>
                    <div id="createAccountAlert" class="alert"></div>
                    <form id="createAccountForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom</label>
                                <input type="text" id="newAccountLastName" required>
                            </div>
                            <div class="form-group">
                                <label>Pr√©nom</label>
                                <input type="text" id="newAccountFirstName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="newAccountEmail" required>
                            </div>
                            <div class="form-group">
                                <label>T√©l√©phone</label>
                                <input type="tel" id="newAccountPhone" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pays</label>
                                <select id="newAccountCountry" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;">
                                    <option value="">-- S√©lectionner un pays --</option>
                                    <option value="Guin√©e">üá¨üá≥ Guin√©e</option>
                                    <option value="France">üá´üá∑ France</option>
                                    <option value="C√¥te d'Ivoire">üá®üáÆ C√¥te d'Ivoire</option>
                                    <option value="S√©n√©gal">üá∏üá≥ S√©n√©gal</option>
                                    <option value="Mali">üá≤üá± Mali</option>
                                    <option value="Burkina Faso">üáßüá´ Burkina Faso</option>
                                    <option value="B√©nin">üáßüáØ B√©nin</option>
                                    <option value="Togo">üáπüá¨ Togo</option>
                                    <option value="Niger">üá≥üá™ Niger</option>
                                    <option value="Cameroun">üá®üá≤ Cameroun</option>
                                    <option value="Gabon">üá¨üá¶ Gabon</option>
                                    <option value="Congo">üá®üá¨ Congo</option>
                                    <option value="RD Congo">üá®üá© RD Congo</option>
                                    <option value="Maroc">üá≤üá¶ Maroc</option>
                                    <option value="Alg√©rie">üá©üáø Alg√©rie</option>
                                    <option value="Tunisie">üáπüá≥ Tunisie</option>
                                    <option value="Belgique">üáßüá™ Belgique</option>
                                    <option value="Suisse">üá®üá≠ Suisse</option>
                                    <option value="Canada">üá®üá¶ Canada</option>
                                    <option value="√âtats-Unis">üá∫üá∏ √âtats-Unis</option>
                                    <option value="Autre">üåç Autre</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mot de passe</label>
                                <input type="password" id="newAccountPassword" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Solde initial</label>
                                <input type="number" id="newAccountBalance" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>Devise du compte</label>
                                <select id="newAccountCurrency" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;">
                                    <option value="GNF">üá¨üá≥ GNF ‚Äî Franc Guin√©en</option>
                                    <option value="XOF">üåç XOF ‚Äî Franc CFA</option>
                                    <option value="EUR">üá™üá∫ EUR ‚Äî Euro</option>
                                    <option value="USD">üá∫üá∏ USD ‚Äî Dollar US</option>
                                    <option value="GBP">üá¨üáß GBP ‚Äî Livre Sterling</option>
                                    <option value="CAD">üá®üá¶ CAD ‚Äî Dollar Canadien</option>
                                    <option value="CHF">üá®üá≠ CHF ‚Äî Franc Suisse</option>
                                    <option value="MAD">üá≤üá¶ MAD ‚Äî Dirham</option>
                                    <option value="DZD">üá©üáø DZD ‚Äî Dinar Alg√©rien</option>
                                    <option value="NGN">üá≥üá¨ NGN ‚Äî Naira</option>
                                    <option value="ZAR">üáøüá¶ ZAR ‚Äî Rand</option>
                                    <option value="BRL">üáßüá∑ BRL ‚Äî Real Br√©silien</option>
                                    <option value="ARS">üá¶üá∑ ARS ‚Äî Peso Argentin</option>
                                    <option value="AED">üá¶üá™ AED ‚Äî Dirham √âmirati</option>
                                    <option value="CNY">üá®üá≥ CNY ‚Äî Yuan</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Progression automatique (%)</label>
                                <input type="number" id="newAccountProgress" value="100" min="0" max="100">
                                <small style="color: #666; font-size: 12px;">Pourcentage pour les virements de ce compte</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Message d'erreur si √©chec (optionnel)</label>
                            <input type="text" id="newAccountErrorMsg" placeholder="Ex: V√©rification des informations requise">
                        </div>
                        <button type="submit" class="btn btn-primary">Cr√©er le compte</button>
                    </form>
                </div>

                <div class="table-container">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
                        <h3 style="margin:0;">üìã Liste des comptes</h3>
                        <button onclick="deleteAllAccountsExcept()" style="padding:10px 18px;background:linear-gradient(135deg,#c0392b,#e74c3c);color:white;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px;box-shadow:0 4px 14px rgba(231,76,60,0.4);">
                            üóëÔ∏è Supprimer tous les comptes
                        </button>
                    </div>
                    <table id="accountsTable">
                        <thead>
                            <tr>
                                <th>Nom du client</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recharge Tab -->
            <div id="rechargeTab" class="tab-content">
                <div class="form-card">
                    <h3>üí∞ Recharger un compte</h3>
                    <div id="rechargeAlert" class="alert"></div>
                    <form id="rechargeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>S√©lectionner le compte</label>
                                <select id="rechargeAccountSelect" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;">
                                    <option value="">-- Choisir un compte --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Montant</label>
                                <input type="number" id="rechargeAmount" required min="1" step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Envoy√© par (nom de l'exp√©diteur)</label>
                                <input type="text" id="rechargeSender" placeholder="Ex: Jean Dupont, Soci√©t√© XYZ...">
                            </div>
                            <div class="form-group">
                                <label>Note (optionnel)</label>
                                <input type="text" id="rechargeNote" placeholder="Ex: Recharge mensuelle">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Recharger</button>
                    </form>
                </div>

                <div class="form-card">
                    <h3>üìâ D√©biter un compte</h3>
                    <div id="debitAlert" class="alert"></div>
                    <form id="debitForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>S√©lectionner le compte</label>
                                <select id="debitAccountSelect" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;">
                                    <option value="">-- Choisir un compte --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Montant</label>
                                <input type="number" id="debitAmount" required min="1" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Note (optionnel)</label>
                            <input type="text" id="debitNote" placeholder="Ex: Retrait">
                        </div>
                        <div id="debitFeeInfo" style="display:none; background:#fff3cd; padding:12px; border-radius:10px; margin-bottom:15px; border-left:4px solid #ffc107;">
                            <p style="margin:0; color:#856404; font-size:13px;">
                                üí∞ Montant : <strong id="debitBaseAmount">0</strong><br>
                                üí∏ Frais (2%) : <strong id="debitFeeAmount">0</strong><br>
                                <span style="font-size:14px;">Total d√©bit√© : <strong id="debitTotalAmount">0</strong></span>
                            </p>
                        </div>
                        <button type="submit" class="btn btn-primary">D√©biter</button>
                    </form>
                </div>
            </div>

            <!-- Transfers Tab -->
            <div id="transfersTab" class="tab-content">
                <div class="form-card">
                    <h3>‚öôÔ∏è Param√®tres des virements</h3>
                    <p style="color: #666; margin-bottom: 15px;">Configurez le comportement automatique des virements</p>
                    <div class="form-row">
        <div class="form-group">
            <label>üí∞ Frais de transaction virements (%)</label>
            <input type="number" id="transactionFeePercent" min="0" max="100" step="0.1" value="2" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
            <small style="color: #666; font-size: 13px;">Frais appliqu√©s aux virements admin (0 = gratuit)</small>
        </div>
        <div class="form-group">
            <label>üí∏ Frais c√¥t√© client (%)</label>
            <input type="number" id="clientFeePercent" min="0" max="100" step="0.1" value="2" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
            <small style="color: #666; font-size: 13px;">Pourcentage affich√© au client lors du virement (modifiable √† volont√©)</small>
        </div>
    </div>
    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Progression automatique (%)</label>
                            <input type="number" id="autoProgress" min="0" max="100" value="100" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
                            <small style="color: #666; font-size: 13px;">Les nouveaux virements s'arr√™teront automatiquement √† ce pourcentage</small>
                        </div>
                        <div class="form-group">
                            <label>Message d'erreur (si progression < 100%)</label>
                            <input type="text" id="autoErrorMessage" placeholder="Ex: V√©rification des informations bancaires requise" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
                            <small style="color: #666; font-size: 13px;">Ce message sera affich√© si la progression ne va pas √† 100%</small>
                        </div>
                    </div>
                    
                    <button onclick="saveTransferSettings()" class="btn btn-primary">üíæ Enregistrer les param√®tres</button>
                </div>
                
                <div class="form-card">
                    <h3>üí∏ Historique des virements internationaux</h3>
                    <p style="color: #666; margin-bottom: 20px;">Liste de tous les virements effectu√©s par les clients</p>
                    <button onclick="exportTransfers()" class="btn btn-primary" style="margin-bottom: 20px;">üì• Exporter en CSV</button>
                </div>
                <div class="table-container">
                    <table id="transfersTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Montant</th>
                                <th>B√©n√©ficiaire</th>
                                <th>IBAN</th>
                                <th>Banque</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transfersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactionsTab" class="tab-content">
                <div class="form-card">
                    <h3>üìä Historique des transactions</h3>
                    <button onclick="exportTransactions()" class="btn btn-primary" style="margin-bottom: 20px;">üì• Exporter en CSV</button>
                </div>
                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Compte</th>
                                <th>Type</th>
                                <th>Montant</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="form-card">
                    <h3>‚öôÔ∏è Param√®tres du syst√®me</h3>
                    <div id="settingsAlert" class="alert"></div>
                    <div class="form-group">
                        <label>Nom de l'application</label>
                        <input type="text" id="appName" value="VANTEX" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
                    </div>
                    <div class="form-group">
                        <label>Devise par d√©faut (pour les nouveaux comptes)</label>
                        <input type="text" id="defaultCurrency" value="GNF" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
                    </div>
                    <button onclick="saveAppSettings()" class="btn btn-primary" style="margin-top: 10px;">üíæ Enregistrer les param√®tres</button>
                    <button onclick="clearAllData()" class="btn btn-danger" style="background: var(--danger); margin-top: 20px;">üóëÔ∏è R√©initialiser toutes les donn√©es</button>
                </div>

                <div class="form-card">
                    <h3>üí± G√©rer les devises des comptes</h3>
                    <p style="color: #666; margin-bottom: 15px;">Changer la devise d'un compte sp√©cifique :</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>S√©lectionner le compte</label>
                            <select id="accountCurrencySelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;">
                                <option value="">-- Choisir un compte --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nouvelle devise</label>
                            <input type="text" id="newCurrencyForAccount" placeholder="Ex: USD, EUR, GNF" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
                        </div>
                    </div>
                    <button onclick="changeAccountCurrency()" class="btn btn-primary">üí± Changer la devise principale</button>
                </div>

                <div class="form-card">
                    <h3>üí± Devises courantes (cliquez pour utiliser)</h3>
                    <p style="color: #666; margin-bottom: 15px;">S√©lectionnez d'abord un compte ci-dessus, puis cliquez sur une devise :</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button onclick="setQuickCurrencyForAccount('GNF')" class="btn-small btn-info">üá¨üá≥ GNF - Franc Guin√©en</button>
                        <button onclick="setQuickCurrencyForAccount('USD')" class="btn-small btn-info">üá∫üá∏ USD - Dollar</button>
                        <button onclick="setQuickCurrencyForAccount('EUR')" class="btn-small btn-info">üá™üá∫ EUR - Euro</button>
                        <button onclick="setQuickCurrencyForAccount('XOF')" class="btn-small btn-info">üåç XOF - Franc CFA</button>
                        <button onclick="setQuickCurrencyForAccount('GBP')" class="btn-small btn-info">üá¨üáß GBP - Livre</button>
                        <button onclick="setQuickCurrencyForAccount('CAD')" class="btn-small btn-info">üá®üá¶ CAD - Dollar Canadien</button>
                        <button onclick="setQuickCurrencyForAccount('CHF')" class="btn-small btn-info">üá®üá≠ CHF - Franc Suisse</button>
                        <button onclick="setQuickCurrencyForAccount('MAD')" class="btn-small btn-info">üá≤üá¶ MAD - Dirham</button>
                        <button onclick="setQuickCurrencyForAccount('NGN')" class="btn-small btn-info">üá≥üá¨ NGN - Naira</button>
                        <button onclick="setQuickCurrencyForAccount('ZAR')" class="btn-small btn-info">üáøüá¶ ZAR - Rand</button>
                    </div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div id="notificationsTab" class="tab-content">
                <div class="form-card">
                    <h3>üîî Cr√©er une notification client</h3>
                    <p style="color:#666; margin-bottom:20px;">La notification s'affichera en boucle (5 sec visible / 5 sec cach√©e) dans le compte du client s√©lectionn√©.</p>
                    <div id="notifAlert" class="alert"></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Compte client</label>
                            <select id="notifAccountSelect" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;">
                                <option value="">-- Choisir un compte --</option>
                                <option value="ALL">üì¢ Tous les comptes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Type de notification</label>
                            <select id="notifType" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;">
                                <option value="info">‚ÑπÔ∏è Information</option>
                                <option value="success">‚úÖ Succ√®s</option>
                                <option value="warning">‚ö†Ô∏è Avertissement</option>
                                <option value="danger">‚ùå Alerte</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Message de la notification</label>
                        <input type="text" id="notifMessage" placeholder="Ex: Votre virement a √©t√© valid√© avec succ√®s !" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;">
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button onclick="createNotification()" class="btn btn-primary" style="flex:1;">üîî Envoyer la notification</button>
                        <button onclick="clearAllNotifications()" class="btn btn-danger" style="flex:1;background:var(--danger);">üóëÔ∏è Supprimer toutes les notifications</button>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom:20px;">üìã Notifications actives</h3>
                    <table id="notificationsTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Type</th>
                                <th>Message</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="notificationsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB TH√àME CLIENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="themeTab" class="tab-content">
                <div class="form-card" style="max-width:700px;">
                    <h3 style="margin-bottom:6px;">üé® Personnalisation du th√®me client</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:24px;">Choisissez un compte ou tous les comptes, puis configurez et appliquez le th√®me.</p>

                    <!-- S√©lection du compte cible -->
                    <div style="margin-bottom:24px;background:#f8f9fa;border-radius:14px;padding:18px;border:2px solid #e8ecff;">
                        <label style="font-weight:700;font-size:14px;display:block;margin-bottom:10px;">üë§ Appliquer √†</label>
                        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                            <select id="themeTargetAccount" style="flex:1;min-width:200px;padding:12px 14px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;background:white;" onchange="onThemeTargetChange()">
                                <option value="ALL">üì¢ Tous les comptes</option>
                            </select>
                            <div id="themeTargetBadge" style="padding:8px 14px;background:#e8f4fd;border-radius:10px;font-size:13px;font-weight:600;color:#1a73e8;white-space:nowrap;">
                                Tous les comptes s√©lectionn√©s
                            </div>
                        </div>
                        <!-- Th√®me actuel du compte s√©lectionn√© -->
                        <div id="currentThemeInfo" style="margin-top:12px;font-size:12px;color:#999;display:none;">
                            <span id="currentThemeLabel">‚Äî</span>
                        </div>
                    </div>

                    <!-- Pr√©sets -->
                    <div style="margin-bottom:28px;">
                        <label style="font-weight:700;font-size:14px;display:block;margin-bottom:12px;">‚ö° Th√®mes pr√©d√©finis</label>
                        <div style="display:flex;flex-wrap:wrap;gap:10px;">
                            <button onclick="applyThemePreset('dark-blue')" style="padding:10px 16px;border-radius:10px;border:2px solid transparent;cursor:pointer;font-weight:700;font-size:13px;background:linear-gradient(135deg,#0a0e1a,#0d1b3e);color:white;">üîµ Bleu nuit</button>
                            <button onclick="applyThemePreset('dark-green')" style="padding:10px 16px;border-radius:10px;border:2px solid transparent;cursor:pointer;font-weight:700;font-size:13px;background:linear-gradient(135deg,#0a1a0f,#0d3e1b);color:white;">üü¢ Vert for√™t</button>
                            <button onclick="applyThemePreset('dark-purple')" style="padding:10px 16px;border-radius:10px;border:2px solid transparent;cursor:pointer;font-weight:700;font-size:13px;background:linear-gradient(135deg,#1a0a2e,#2d0a5e);color:white;">üü£ Violet royal</button>
                            <button onclick="applyThemePreset('dark-red')" style="padding:10px 16px;border-radius:10px;border:2px solid transparent;cursor:pointer;font-weight:700;font-size:13px;background:linear-gradient(135deg,#1a0a0a,#3e0d0d);color:white;">üî¥ Rouge sombre</button>
                            <button onclick="applyThemePreset('dark-gold')" style="padding:10px 16px;border-radius:10px;border:2px solid transparent;cursor:pointer;font-weight:700;font-size:13px;background:linear-gradient(135deg,#1a1500,#3e3000);color:#f4d03f;">üü° Or premium</button>
                            <button onclick="applyThemePreset('light')" style="padding:10px 16px;border-radius:10px;border:2px solid #e0e0e0;cursor:pointer;font-weight:700;font-size:13px;background:linear-gradient(135deg,#f5f7ff,#e8ecff);color:#1a3abf;">‚ö™ Clair</button>
                        </div>
                    </div>

                    <!-- Couleurs personnalis√©es -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:24px;">
                        <div>
                            <label style="font-size:13px;font-weight:600;color:#444;display:block;margin-bottom:8px;">üåë Fond principal</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="color" id="th_bg" value="#0a0e1a" style="width:50px;height:40px;border:none;border-radius:8px;cursor:pointer;padding:2px;">
                                <input type="text" id="th_bg_hex" value="#0a0e1a" maxlength="7" style="flex:1;padding:8px 10px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;font-family:monospace;" oninput="syncColorInput('th_bg','th_bg_hex')">
                            </div>
                        </div>
                        <div>
                            <label style="font-size:13px;font-weight:600;color:#444;display:block;margin-bottom:8px;">üÉè Fond carte principale</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="color" id="th_card" value="#0d1b3e" style="width:50px;height:40px;border:none;border-radius:8px;cursor:pointer;padding:2px;">
                                <input type="text" id="th_card_hex" value="#0d1b3e" maxlength="7" style="flex:1;padding:8px 10px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;font-family:monospace;" oninput="syncColorInput('th_card','th_card_hex')">
                            </div>
                        </div>
                        <div>
                            <label style="font-size:13px;font-weight:600;color:#444;display:block;margin-bottom:8px;">üé¥ Fond carte secondaire</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="color" id="th_card2" value="#0a2a6e" style="width:50px;height:40px;border:none;border-radius:8px;cursor:pointer;padding:2px;">
                                <input type="text" id="th_card2_hex" value="#0a2a6e" maxlength="7" style="flex:1;padding:8px 10px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;font-family:monospace;" oninput="syncColorInput('th_card2','th_card2_hex')">
                            </div>
                        </div>
                        <div>
                            <label style="font-size:13px;font-weight:600;color:#444;display:block;margin-bottom:8px;">üîµ Couleur accent (boutons)</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="color" id="th_accent" value="#1a3abf" style="width:50px;height:40px;border:none;border-radius:8px;cursor:pointer;padding:2px;">
                                <input type="text" id="th_accent_hex" value="#1a3abf" maxlength="7" style="flex:1;padding:8px 10px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;font-family:monospace;" oninput="syncColorInput('th_accent','th_accent_hex')">
                            </div>
                        </div>
                        <div>
                            <label style="font-size:13px;font-weight:600;color:#444;display:block;margin-bottom:8px;">üí† Accent secondaire</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="color" id="th_accent2" value="#2550e8" style="width:50px;height:40px;border:none;border-radius:8px;cursor:pointer;padding:2px;">
                                <input type="text" id="th_accent2_hex" value="#2550e8" maxlength="7" style="flex:1;padding:8px 10px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;font-family:monospace;" oninput="syncColorInput('th_accent2','th_accent2_hex')">
                            </div>
                        </div>
                        <div>
                            <label style="font-size:13px;font-weight:600;color:#444;display:block;margin-bottom:8px;">üü¢ Couleur positive (revenus)</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="color" id="th_green" value="#00e5a0" style="width:50px;height:40px;border:none;border-radius:8px;cursor:pointer;padding:2px;">
                                <input type="text" id="th_green_hex" value="#00e5a0" maxlength="7" style="flex:1;padding:8px 10px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;font-family:monospace;" oninput="syncColorInput('th_green','th_green_hex')">
                            </div>
                        </div>
                        <div>
                            <label style="font-size:13px;font-weight:600;color:#444;display:block;margin-bottom:8px;">üî¥ Couleur n√©gative (d√©penses)</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="color" id="th_red" value="#ff6b6b" style="width:50px;height:40px;border:none;border-radius:8px;cursor:pointer;padding:2px;">
                                <input type="text" id="th_red_hex" value="#ff6b6b" maxlength="7" style="flex:1;padding:8px 10px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;font-family:monospace;" oninput="syncColorInput('th_red','th_red_hex')">
                            </div>
                        </div>
                        <div>
                            <label style="font-size:13px;font-weight:600;color:#444;display:block;margin-bottom:8px;">‚¨õ Barre de navigation</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="color" id="th_nav" value="#0a0e1a" style="width:50px;height:40px;border:none;border-radius:8px;cursor:pointer;padding:2px;">
                                <input type="text" id="th_nav_hex" value="#0a0e1a" maxlength="7" style="flex:1;padding:8px 10px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;font-family:monospace;" oninput="syncColorInput('th_nav','th_nav_hex')">
                            </div>
                        </div>
                    </div>

                    <!-- Aper√ßu -->
                    <div style="margin-bottom:24px;">
                        <label style="font-weight:700;font-size:14px;display:block;margin-bottom:12px;">üëÅÔ∏è Aper√ßu en temps r√©el</label>
                        <div style="border-radius:16px;overflow:hidden;border:1px solid #e0e0e0;box-shadow:0 4px 20px rgba(0,0,0,0.1);">
                            <div id="pvBg" style="background:#0a0e1a;padding:16px;border-radius:16px;">
                                <div id="pvCard" style="background:linear-gradient(135deg,#0d1b3e,#0a2a6e);border-radius:14px;padding:16px;margin-bottom:12px;">
                                    <div style="color:rgba(255,255,255,0.5);font-size:11px;margin-bottom:4px;">Solde disponible</div>
                                    <div style="color:white;font-size:22px;font-weight:800;">1 250 000 GNF</div>
                                    <div style="display:flex;gap:8px;margin-top:12px;">
                                        <div id="pvBtn" style="background:linear-gradient(135deg,#1a3abf,#2550e8);border-radius:8px;padding:8px 16px;color:white;font-size:12px;font-weight:700;">üí∏ Virement</div>
                                        <div id="pvBtn2" style="background:linear-gradient(135deg,#1a3abf,#2550e8);border-radius:8px;padding:8px 16px;color:white;font-size:12px;font-weight:700;">üí≥ Carte</div>
                                    </div>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:0 4px;">
                                    <div><div style="color:rgba(255,255,255,0.4);font-size:10px;">Revenus</div><div id="pvGreen" style="color:#00e5a0;font-weight:700;font-size:13px;">+500 000</div></div>
                                    <div><div style="color:rgba(255,255,255,0.4);font-size:10px;">D√©penses</div><div id="pvRed" style="color:#ff6b6b;font-weight:700;font-size:13px;">‚Äî150 000</div></div>
                                </div>
                                <div id="pvNav" style="background:#0a0e1a;border-radius:10px;padding:10px;margin-top:12px;display:flex;justify-content:space-around;">
                                    <div style="color:rgba(255,255,255,0.6);font-size:11px;text-align:center;">üè†<br>Accueil</div>
                                    <div style="color:rgba(255,255,255,0.6);font-size:11px;text-align:center;">üí∏<br>Virement</div>
                                    <div style="color:rgba(255,255,255,0.6);font-size:11px;text-align:center;">üí≥<br>Carte</div>
                                    <div style="color:rgba(255,255,255,0.6);font-size:11px;text-align:center;">üë§<br>Compte</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div style="display:flex;gap:12px;flex-wrap:wrap;">
                        <button onclick="saveClientTheme()" style="flex:1;min-width:160px;padding:14px;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 14px rgba(39,174,96,0.35);">
                            üíæ Sauvegarder & Appliquer
                        </button>
                        <button onclick="resetClientTheme()" style="padding:14px 20px;background:#f5f5f5;color:#666;border:2px solid #e0e0e0;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;">
                            üîÑ R√©initialiser
                        </button>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê<!-- ‚ïê‚ïê TAB S√âCURIT√â ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="securityTab" class="tab-content">
                <div style="padding:0 0 24px;">
                    <h2 style="font-size:20px;font-weight:800;color:#1a1a2e;margin:0 0 6px;">üîí S√©curit√© Administrateur</h2>
                    <p style="color:#888;font-size:13px;margin:0;">Configurez les couches de s√©curit√© pour prot√©ger l'acc√®s admin.</p>
                </div>
                <div id="secBlockStatus" style="display:none;background:#ffeaea;border:1px solid #ffcccc;border-radius:14px;padding:14px 18px;margin-bottom:20px;">
                    <p style="color:#c0392b;font-weight:700;margin:0;" id="secBlockMsg"></p>
                </div>
                <div style="background:white;border-radius:16px;padding:22px;margin-bottom:16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);">
                    <h3 style="font-size:14px;font-weight:800;color:#1a1a2e;margin:0 0 16px;">üîê Double authentification</h3>
                    <div style="display:grid;gap:12px;">
                        <div>
                            <label style="font-size:11px;font-weight:700;color:#888;letter-spacing:1px;text-transform:uppercase;">Deuxi√®me mot de passe</label>
                            <input type="password" id="sec_pw2" placeholder="Nouveau 2√®me mot de passe" style="width:100%;margin-top:6px;padding:10px 14px;border:2px solid #e8ecf0;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none;">
                        </div>
                        <div>
                            <label style="font-size:11px;font-weight:700;color:#888;letter-spacing:1px;text-transform:uppercase;">Question secr√®te</label>
                            <input type="text" id="sec_q" placeholder="Ex: Quel est le pr√©nom de votre m√®re ?" style="width:100%;margin-top:6px;padding:10px 14px;border:2px solid #e8ecf0;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none;">
                        </div>
                        <div>
                            <label style="font-size:11px;font-weight:700;color:#888;letter-spacing:1px;text-transform:uppercase;">R√©ponse secr√®te</label>
                            <input type="text" id="sec_ans" placeholder="Votre r√©ponse" style="width:100%;margin-top:6px;padding:10px 14px;border:2px solid #e8ecf0;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none;">
                        </div>
                        <button onclick="saveSecuritySettings()" style="padding:12px 20px;background:linear-gradient(135deg,#1a56db,#2563eb);border:none;border-radius:12px;color:white;font-size:13px;font-weight:700;cursor:pointer;">Enregistrer les changements</button>
                    </div>
                </div>
                <div style="background:white;border-radius:16px;padding:22px;margin-bottom:16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);">
                    <h3 style="font-size:14px;font-weight:800;color:#1a1a2e;margin:0 0 8px;">üì± Code TOTP (Google Authenticator)</h3>
                    <p style="color:#888;font-size:12px;margin:0 0 16px;">Scannez ce QR code avec Google Authenticator ou Authy.</p>
                    <!-- Statut TOTP -->
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;">
                        <span style="font-size:12px;font-weight:700;color:#888;">Statut :</span>
                        <span id="totp_status_badge" style="font-size:12px;font-weight:700;color:#f59e0b;">‚ö†Ô∏è Non configur√©</span>
                    </div>
                    <!-- QR Code container (rempli par loadSecurityTab) -->
                    <div id="totp_qr_container" style="text-align:center;padding:16px;background:#f8f9fb;border-radius:12px;margin-bottom:14px;">
                        <p style="color:#888;font-size:13px;">Cliquez "G√©n√©rer" pour cr√©er votre QR code</p>
                    </div>
                    <button onclick="generateNewTOTPSecret()" style="width:100%;padding:13px 20px;background:linear-gradient(135deg,#7c3aed,#8b5cf6);border:none;border-radius:12px;color:white;font-size:13px;font-weight:700;cursor:pointer;box-shadow:0 4px 14px rgba(139,92,246,0.35);">üîÑ G√©n√©rer et enregistrer une nouvelle cl√©</button>
                </div>
                <div style="background:white;border-radius:16px;padding:22px;margin-bottom:16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);">
                    <h3 style="font-size:14px;font-weight:800;color:#1a1a2e;margin:0 0 8px;">üì± Appareils de confiance</h3>
                    <p style="color:#888;font-size:12px;margin:0 0 6px;">Sur un appareil de confiance, seul le mot de passe principal est demand√©.</p>
                    <p style="color:#555;font-size:12px;margin:0 0 14px;">Sur un <strong>nouvel appareil</strong>, les 3 √©tapes de s√©curit√© sont obligatoires.</p>
                    <div id="trusted_devices_count" style="background:#f0f7ff;border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:#1a56db;font-weight:600;"></div>
                    <button onclick="revokeAllTrustedDevices()" style="padding:12px 20px;background:linear-gradient(135deg,#e67e22,#d35400);border:none;border-radius:12px;color:white;font-size:13px;font-weight:700;cursor:pointer;">üóëÔ∏è R√©voquer tous les appareils de confiance</button>
                </div>
                <div style="background:white;border-radius:16px;padding:22px;box-shadow:0 2px 12px rgba(0,0,0,0.06);">
                    <h3 style="font-size:14px;font-weight:800;color:#1a1a2e;margin:0 0 8px;">üö´ Blocage des tentatives</h3>
                    <p style="color:#888;font-size:12px;margin:0 0 14px;">Apr√®s 3 tentatives √©chou√©es, l'acc√®s est bloqu√© 30 minutes.</p>
                    <button onclick="resetAdminBlock()" style="padding:12px 20px;background:linear-gradient(135deg,#e74c3c,#c0392b);border:none;border-radius:12px;color:white;font-size:13px;font-weight:700;cursor:pointer;">üîì D√©bloquer l'acc√®s maintenant</button>
                </div>
            </div>

            ‚ïê‚ïê‚ïê‚ïê TAB SUPPORT CLIENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="supportTab" class="tab-content">
                <div style="display:grid;grid-template-columns:280px 1fr;gap:0;height:calc(100vh - 130px);min-height:500px;background:white;border-radius:16px;overflow:hidden;border:1px solid #e0e0e0;box-shadow:0 4px 20px rgba(0,0,0,0.08);">

                    <!-- Liste des conversations -->
                    <div style="border-right:1px solid #e8e8e8;display:flex;flex-direction:column;background:#fafafa;">
                        <div style="padding:16px;border-bottom:1px solid #e8e8e8;background:white;">
                            <h3 style="margin:0;font-size:15px;font-weight:700;color:#1a1a2e;">üí¨ Conversations</h3>
                            <p style="margin:4px 0 0;font-size:11px;color:#999;">Messagerie temps r√©el</p>
                        </div>
                        <div id="adminConvList" style="flex:1;overflow-y:auto;padding:8px;">
                            <div style="text-align:center;padding:30px 16px;color:#bbb;font-size:13px;">
                                <div style="font-size:32px;margin-bottom:8px;">üí¨</div>
                                Aucune conversation
                            </div>
                        </div>
                    </div>

                    <!-- Zone de chat -->
                    <div style="display:flex;flex-direction:column;background:#f5f7fb;">
                        <!-- Header chat -->
                        <div id="adminChatHeader" style="padding:14px 20px;background:white;border-bottom:1px solid #e8e8e8;display:flex;align-items:center;gap:12px;min-height:60px;">
                            <div style="width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,#1a73e8,#0d47a1);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0;" id="adminChatAvatar">?</div>
                            <div>
                                <div id="adminChatName" style="font-weight:700;font-size:14px;color:#1a1a2e;">S√©lectionner une conversation</div>
                                <div id="adminChatStatus" style="font-size:11px;color:#999;">‚Äî</div>
                            </div>
                        </div>

                        <!-- Messages -->
                        <div id="adminChatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;">
                            <div style="text-align:center;color:#bbb;font-size:13px;margin:auto;">
                                <div style="font-size:40px;margin-bottom:8px;">üëà</div>
                                Choisissez une conversation
                            </div>
                        </div>

                        <!-- Input admin -->
                        <div id="adminChatInputZone" style="padding:12px 16px;background:white;border-top:1px solid #e8e8e8;display:flex;gap:10px;align-items:flex-end;">
                            <textarea id="adminChatInput" placeholder="R√©pondre au client..." rows="1"
                                style="flex:1;border:2px solid #e0e0e0;border-radius:12px;padding:10px 14px;font-size:14px;resize:none;outline:none;font-family:inherit;max-height:100px;line-height:1.4;"
                                onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();adminSendMessage();}"
                                oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"></textarea>
                            <button onclick="adminSendMessage()" style="padding:10px 20px;background:linear-gradient(135deg,#1a73e8,#0d47a1);color:white;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap;box-shadow:0 4px 14px rgba(26,115,232,0.35);">
                                Envoyer ‚Üë
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div><!-- /admin-content -->
        </div><!-- /admin-main -->
    </div><!-- /admin-container -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB SUPPORT CLIENT (admin) ‚Äî inject√© hors admin-content
     pour √©viter les conflits de layout
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
       <div id="txDetailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:flex-end; justify-content:center; backdrop-filter:blur(4px);" onclick="if(event.target===this)closeTxDetail()">
        <div id="txDetailContent" style="background:white;border-radius:28px 28px 0 0;max-width:500px;width:100%;max-height:88vh;overflow-y:auto;padding:0 0 30px;">
            <div style="width:40px;height:4px;background:#e0e0e0;border-radius:2px;margin:14px auto 20px;"></div>
        </div>
    </div>

    <!-- Modal Confirmation PIN -->
    <div id="pinConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); z-index:99998; align-items:center; justify-content:center; padding:20px;">
        <div style="background:white; border-radius:20px; padding:28px 24px; width:100%; max-width:360px; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
            <div style="font-size:40px; margin-bottom:12px;">üîí</div>
            <h3 style="font-size:16px; font-weight:700; margin-bottom:6px;" id="pinModalTitle">Confirmation requise</h3>
            <p style="font-size:13px; color:#888; margin-bottom:18px;" id="pinModalDesc">Saisissez votre code PIN pour confirmer</p>
            <input type="password" id="pinInput" placeholder="Code PIN" maxlength="20"
                style="width:100%; padding:13px; border:2px solid #e0e0e0; border-radius:12px; font-size:16px; text-align:center; letter-spacing:4px; margin-bottom:8px; box-sizing:border-box;">
            <p id="pinError" style="color:#e74c3c; font-size:13px; min-height:18px; margin-bottom:10px;"></p>
            <div style="display:flex; gap:10px;">
                <button onclick="cancelPinConfirm()" style="flex:1; padding:12px; background:#f0f0f0; color:#555; border:none; border-radius:10px; font-size:14px; font-weight:600; cursor:pointer;">Annuler</button>
                <button onclick="validatePin()" style="flex:1; padding:12px; background:var(--primary-blue); color:white; border:none; border-radius:10px; font-size:14px; font-weight:600; cursor:pointer;">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Modal for Recharge/Edit -->
    <!-- Modal Profil Client -->
    <div class="profile-modal-overlay" id="profileModalOverlay" onclick="if(event.target===this)closeProfileModal()">
        <div class="profile-modal-box">

            <!-- Bouton fermer rouge centr√© en haut -->
            <button class="profile-close-btn" onclick="closeProfileModal()">‚úï</button>

            <!-- Espace pour le bouton flottant -->
            <div style="height:38px;"></div>

            <!-- En-t√™te titre -->
            <div style="padding:0 24px 14px;">
                <p style="font-size:13px;color:rgba(100,160,255,0.7);font-weight:600;margin:0;display:flex;align-items:center;gap:6px;">
                    <span style="color:rgba(100,160,255,0.9);">‚ñ™</span> Vos informations de compte :
                </p>
            </div>

            <!-- S√©parateur -->
            <div style="height:1px;background:linear-gradient(90deg,transparent,rgba(100,160,255,0.18),transparent);margin-bottom:4px;"></div>

            <!-- Type de compte -->
            <div class="profile-info-row">
                <div class="profile-info-label">Type de Compte :</div>
                <div class="profile-info-value" id="profileAccountType">Compte courant</div>
            </div>

            <!-- Titulaire -->
            <div class="profile-info-row">
                <div class="profile-info-label">Titulaire du Compte :</div>
                <div class="profile-info-value" id="profileName">‚Äî</div>
            </div>

            <!-- Pays de r√©sidence -->
            <div class="profile-info-row">
                <div class="profile-info-label">Pays de r√©sidence :</div>
                <div class="profile-info-value" id="profileCountry">‚Äî</div>
            </div>

            <!-- Adresse de r√©sidence -->
            <div class="profile-info-row">
                <div class="profile-info-label">Adresse de r√©sidence :</div>
                <div class="profile-info-value" id="profilePhone">‚Äî</div>
            </div>

            <!-- Email -->
            <div class="profile-info-row">
                <div class="profile-info-label">Adresse e-mail :</div>
                <div class="profile-info-value" id="profileEmail">‚Äî</div>
            </div>

            <!-- T√©l√©phone -->
            <div class="profile-info-row">
                <div class="profile-info-label">Num√©ro de t√©l√©phone :</div>
                <div class="profile-info-value" id="profilePhoneNumber">‚Äî</div>
            </div>

            <!-- S√©parateur -->
            <div style="height:1px;background:linear-gradient(90deg,transparent,rgba(100,160,255,0.12),transparent);margin:8px 0;"></div>

            <!-- Bouton d√©connexion -->
            <div style="padding:16px 24px 32px;">
                <button class="profile-logout-btn" onclick="logoutClient()" style="width:auto;display:flex;align-items:center;gap:8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Se d√©connecter ‚Üí
                </button>
            </div>

        </div>
    </div>

    <div class="modal" id="rechargeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Recharger le compte</h3>
                <button class="close-modal" onclick="closeModal('rechargeModal')">√ó</button>
            </div>
            <div id="modalAlert" class="alert"></div>
            <form id="modalRechargeForm">
                <div class="form-group">
                    <label>Montant (GNF)</label>
                    <input type="number" id="modalRechargeAmount" required min="1">
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <input type="text" id="modalRechargeNote">
                </div>
                <button type="submit" class="btn btn-primary">Confirmer</button>
            </form>
        </div>
    </div>

    <!-- Modal for International Transfer -->
    <!-- Transfer Modal - Formulaire virement premium -->
    <div id="transferModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:9000;overflow-y:auto;background:radial-gradient(ellipse at 20% 10%,#0d1b4b 0%,#050d2e 55%,#020818 100%);">

        <!-- Lueurs d√©coratives -->
        <div style="position:fixed;top:-60px;right:-60px;width:280px;height:280px;background:radial-gradient(circle,rgba(0,100,255,0.14) 0%,transparent 70%);pointer-events:none;z-index:0;"></div>
        <div style="position:fixed;bottom:10%;left:-60px;width:220px;height:220px;background:radial-gradient(circle,rgba(80,0,200,0.1) 0%,transparent 70%);pointer-events:none;z-index:0;"></div>

        <!-- Photo fond header -->
        <div style="position:absolute;top:0;left:0;right:0;height:200px;z-index:0;
            background:linear-gradient(180deg,rgba(5,13,46,0.5) 0%,rgba(2,8,24,0.98) 100%),
            url('https://images.unsplash.com/photo-1563986768494-4dee2763ff3f?w=1200&q=80') center/cover no-repeat;">
        </div>

        <!-- Logo VANTEX -->
        <div style="position:relative;z-index:2;display:flex;align-items:center;gap:10px;padding:20px 20px 6px;">
            <div style="width:38px;height:38px;background:linear-gradient(135deg,#1565c0,#1976d2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 12px rgba(21,101,192,0.5);">üè¶</div>
            <span style="color:white;font-size:18px;font-weight:800;letter-spacing:1px;">VANTEX</span>
        </div>

        <!-- Header -->
        <div style="position:relative;z-index:2;display:flex;align-items:center;gap:14px;padding:8px 20px 10px;">
            <button onclick="closeTransferPage()" style="width:40px;height:40px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:50%;color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;backdrop-filter:blur(4px);">‚Üê</button>
            <div>
                <p style="color:rgba(0,229,160,0.85);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin:0 0 2px;">TRANSACTION S√âCURIS√âE</p>
                <h2 style="color:white;font-size:22px;font-weight:800;margin:0;">Effectuer un virement</h2>
            </div>
        </div>

        <!-- Solde dispo header pill -->
        <div style="position:relative;z-index:2;margin:10px 20px 16px;">
            <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(100,160,255,0.25);border-radius:16px;padding:12px 16px;display:flex;align-items:center;gap:10px;backdrop-filter:blur(6px);">
                <span style="font-size:20px;">üí≥</span>
                <span style="color:rgba(255,255,255,0.6);font-size:13px;font-weight:600;">Solde disponible</span>
                <span style="color:white;font-size:14px;font-weight:800;margin-left:auto;" id="headerBalance">‚Äî</span>
            </div>
        </div>

        <form id="transferForm" style="position:relative;z-index:1;padding:0 16px 40px;display:flex;flex-direction:column;gap:14px;">

            <!-- TYPE DE TRANSFERT -->
            <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(100,160,255,0.2);border-radius:20px;padding:18px;backdrop-filter:blur(8px);">
                <p style="color:rgba(255,255,255,0.45);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin:0 0 14px;">Type de transfert</p>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <!-- Transfert Mobile -->
                    <div id="typeCardMobile" onclick="selectTransferType('mobile')" style="background:rgba(255,255,255,0.05);border:1.5px solid rgba(255,255,255,0.1);border-radius:16px;padding:16px 10px;cursor:pointer;text-align:center;transition:all 0.2s;">
                        <div style="width:52px;height:52px;background:linear-gradient(135deg,#e65c00,#f9a825);border-radius:14px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 4px 14px rgba(230,92,0,0.4);">üì±</div>
                        <p style="color:white;font-size:13px;font-weight:700;margin:0 0 3px;">Transfert Mobile</p>
                        <p style="color:rgba(255,255,255,0.4);font-size:11px;margin:0;">Mobile Money, Wave...</p>
                    </div>
                    <!-- Virement Bancaire -->
                    <div id="typeCardBank" onclick="selectTransferType('bank')" style="background:rgba(255,255,255,0.05);border:1.5px solid rgba(255,255,255,0.1);border-radius:16px;padding:16px 10px;cursor:pointer;text-align:center;transition:all 0.2s;">
                        <div style="width:52px;height:52px;background:linear-gradient(135deg,#1565c0,#1976d2);border-radius:14px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 4px 14px rgba(21,101,192,0.45);">üè¶</div>
                        <p style="color:white;font-size:13px;font-weight:700;margin:0 0 3px;">Virement Bancaire</p>
                        <p style="color:rgba(255,255,255,0.4);font-size:11px;margin:0;">IBAN, SWIFT...</p>
                    </div>
                </div>
            </div>

            <!-- MONTANT -->
            <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(100,160,255,0.2);border-radius:20px;padding:18px;backdrop-filter:blur(8px);">
                <p style="color:rgba(255,255,255,0.45);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin:0 0 10px;">Montant du virement</p>
                <div style="position:relative;">
                    <input type="number" id="transferAmount" placeholder="0.00" min="0" step="0.01"
                        style="width:100%;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.25);border-radius:14px;padding:14px 80px 14px 16px;color:white;font-size:22px;font-weight:700;outline:none;-moz-appearance:textfield;box-sizing:border-box;"
                        onfocus="this.style.borderColor='rgba(0,200,255,0.6)'" onblur="this.style.borderColor='rgba(100,160,255,0.25)'">
                    <div style="position:absolute;right:0;top:0;height:100%;background:rgba(0,80,200,0.35);border:1.5px solid rgba(100,160,255,0.3);border-radius:0 14px 14px 0;padding:0 16px;display:flex;align-items:center;border-left:none;">
                        <span id="transferCurrency" style="color:#60a5fa;font-size:15px;font-weight:800;">XOF</span>
                    </div>
                </div>
                <!-- Info frais -->
                <div id="clientFeeInfo" style="display:none;background:rgba(0,60,160,0.2);border:1px solid rgba(100,160,255,0.2);border-radius:12px;padding:12px;margin-top:10px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span style="color:rgba(255,255,255,0.5);font-size:12px;">Montant</span>
                        <span style="color:white;font-size:12px;font-weight:600;" id="clientBaseAmount">‚Äî</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span style="color:rgba(255,255,255,0.5);font-size:12px;">Frais</span>
                        <span style="color:#ff6b6b;font-size:12px;font-weight:600;" id="clientFeeAmount">‚Äî</span>
                    </div>
                    <div style="height:1px;background:rgba(255,255,255,0.1);margin-bottom:6px;"></div>
                    <div style="display:flex;justify-content:space-between;">
                        <span style="color:rgba(255,255,255,0.7);font-size:13px;font-weight:700;">Total</span>
                        <span style="color:#00e5a0;font-size:13px;font-weight:800;" id="clientTotalAmount">‚Äî</span>
                    </div>
                </div>
            </div>

            <!-- NOM DU B√âN√âFICIAIRE -->
            <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(100,160,255,0.2);border-radius:20px;padding:18px;backdrop-filter:blur(8px);">
                <p style="color:rgba(255,255,255,0.45);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin:0 0 10px;">Nom du b√©n√©ficiaire</p>
                <input type="text" id="transferBeneficiary" placeholder="Pr√©nom et Nom"
                    style="width:100%;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.25);border-radius:14px;padding:14px 16px;color:white;font-size:15px;outline:none;box-sizing:border-box;"
                    onfocus="this.style.borderColor='rgba(0,200,255,0.6)'" onblur="this.style.borderColor='rgba(100,160,255,0.25)'">
            </div>

            <!-- RAISON -->
            <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(100,160,255,0.2);border-radius:20px;padding:18px;backdrop-filter:blur(8px);">
                <p style="color:rgba(255,255,255,0.45);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin:0 0 10px;">Raison du virement</p>
                <input type="text" id="transferReason" placeholder="Ex: Paiement de facture"
                    style="width:100%;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.25);border-radius:14px;padding:14px 16px;color:white;font-size:15px;outline:none;box-sizing:border-box;"
                    onfocus="this.style.borderColor='rgba(0,200,255,0.6)'" onblur="this.style.borderColor='rgba(100,160,255,0.25)'">
            </div>

            <!-- CHAMPS MOBILE -->
            <div id="mobileFields" style="display:none;background:rgba(255,255,255,0.04);border:1px solid rgba(100,160,255,0.2);border-radius:20px;padding:18px;backdrop-filter:blur(8px);">
                <p style="color:rgba(255,255,255,0.45);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin:0 0 14px;">D√©tails Mobile Money</p>
                <div style="display:flex;flex-direction:column;gap:12px;">

                    <!-- OP√âRATEUR ‚Äî bouton qui ouvre le modal -->
                    <div>
                        <p style="color:rgba(255,255,255,0.5);font-size:12px;font-weight:600;margin:0 0 8px;">Op√©rateur</p>
                        <input type="hidden" id="transferOperator" value="">
                        <div id="operatorDropdown" onclick="showOperatorModal()"
                             style="background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.25);border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:border-color 0.2s;"
                             onmouseover="this.style.borderColor='rgba(0,200,255,0.5)'"
                             onmouseout="this.style.borderColor='rgba(100,160,255,0.25)'">
                            <div id="opLogoDisplay" style="width:38px;height:38px;border-radius:10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">üì±</div>
                            <span id="opLabelDisplay" style="color:rgba(255,255,255,0.45);font-size:15px;font-weight:500;flex:1;">Choisir un op√©rateur</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                    </div>

                    <!-- NUM√âRO -->
                    <div>
                        <p style="color:rgba(255,255,255,0.5);font-size:12px;font-weight:600;margin:0 0 8px;">Num√©ro de t√©l√©phone</p>
                        <input type="tel" id="transferMobileNumber" placeholder="Ex: +221 77 000 00 00"
                            style="width:100%;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.25);border-radius:14px;padding:14px 16px;color:white;font-size:15px;outline:none;box-sizing:border-box;transition:border-color 0.2s;"
                            onfocus="this.style.borderColor='rgba(0,200,255,0.6)'" onblur="this.style.borderColor='rgba(100,160,255,0.25)'">
                    </div>

                    <!-- PAYS ‚Äî bouton qui ouvre le modal pays -->
                    <div>
                        <p style="color:rgba(255,255,255,0.5);font-size:12px;font-weight:600;margin:0 0 8px;">Pays</p>
                        <input type="hidden" id="transferMobileCountry" value="">
                        <div id="countryDropdown" onclick="showCountryModal()"
                             style="background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.25);border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:border-color 0.2s;"
                             onmouseover="this.style.borderColor='rgba(0,200,255,0.5)'"
                             onmouseout="this.style.borderColor='rgba(100,160,255,0.25)'">
                            <div id="ctFlagDisplay" style="font-size:28px;line-height:1;flex-shrink:0;">üåç</div>
                            <span id="ctLabelDisplay" style="color:rgba(255,255,255,0.45);font-size:15px;font-weight:500;flex:1;">Choisir un pays</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                    </div>

                </div>
            </div>

            <!-- CHAMPS BANCAIRES -->
            <div id="bankFields" style="display:none;background:rgba(255,255,255,0.04);border:1px solid rgba(100,160,255,0.2);border-radius:20px;padding:18px;backdrop-filter:blur(8px);">
                <p style="color:rgba(255,255,255,0.45);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin:0 0 14px;">D√©tails bancaires</p>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div>
                        <p style="color:rgba(255,255,255,0.5);font-size:12px;margin:0 0 6px;">IBAN / Num√©ro de compte</p>
                        <input type="text" id="transferIban" placeholder="FR76 XXXX XXXX..."
                            style="width:100%;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.25);border-radius:14px;padding:13px 16px;color:white;font-size:14px;font-family:monospace;outline:none;box-sizing:border-box;"
                            onfocus="this.style.borderColor='rgba(0,200,255,0.6)'" onblur="this.style.borderColor='rgba(100,160,255,0.25)'">
                    </div>
                    <div>
                        <p style="color:rgba(255,255,255,0.5);font-size:12px;margin:0 0 6px;">Code BIC / SWIFT</p>
                        <input type="text" id="transferSwift" placeholder="BNPAFRPP..."
                            style="width:100%;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.25);border-radius:14px;padding:13px 16px;color:white;font-size:14px;font-family:monospace;outline:none;box-sizing:border-box;"
                            onfocus="this.style.borderColor='rgba(0,200,255,0.6)'" onblur="this.style.borderColor='rgba(100,160,255,0.25)'">
                    </div>
                    <div>
                        <p style="color:rgba(255,255,255,0.5);font-size:12px;margin:0 0 6px;">Nom de la banque</p>
                        <input type="text" id="transferBank" placeholder="Ex: BNP Paribas"
                            style="width:100%;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.25);border-radius:14px;padding:13px 16px;color:white;font-size:15px;outline:none;box-sizing:border-box;"
                            onfocus="this.style.borderColor='rgba(0,200,255,0.6)'" onblur="this.style.borderColor='rgba(100,160,255,0.25)'">
                    </div>
                </div>
            </div>

            <!-- Solde disponible bas -->
            <div style="background:rgba(0,60,160,0.2);border:1px solid rgba(100,160,255,0.2);border-radius:16px;padding:14px 16px;display:flex;align-items:center;gap:12px;">
                <div style="width:38px;height:38px;background:linear-gradient(135deg,#1565c0,#1976d2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;box-shadow:0 3px 10px rgba(21,101,192,0.4);">üí∞</div>
                <span style="color:rgba(255,255,255,0.6);font-size:13px;font-weight:600;">Solde disponible</span>
                <span style="color:white;font-size:15px;font-weight:800;margin-left:auto;" id="transferAvailableBalance">‚Äî</span>
            </div>

            <!-- Bouton soumettre -->
            <button type="submit" style="width:100%;padding:17px;background:linear-gradient(135deg,#1a3abf,#2550e8);color:white;border:1px solid rgba(100,160,255,0.3);border-radius:16px;font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 6px 24px rgba(0,60,220,0.45);letter-spacing:0.5px;margin-top:4px;">
                Continuer ‚Üí
            </button>
        </form>
    </div>
    <!-- Transfer Confirmation Page -->
    <!-- Transfer Confirmation Page -->
    <div class="client-container" id="transferConfirmation" style="display:none;min-height:100vh;background:radial-gradient(ellipse at 20% 15%,#0d1b4b 0%,#050d2e 50%,#020818 100%);position:relative;overflow-y:auto;">

        <!-- Lueurs d√©coratives -->
        <div style="position:absolute;top:-60px;right:-60px;width:280px;height:280px;background:radial-gradient(circle,rgba(0,100,255,0.15) 0%,transparent 70%);pointer-events:none;z-index:0;"></div>
        <div style="position:absolute;bottom:20%;left:-60px;width:220px;height:220px;background:radial-gradient(circle,rgba(80,0,200,0.12) 0%,transparent 70%);pointer-events:none;z-index:0;"></div>

        <!-- Photo fond header -->
        <div style="position:absolute;top:0;left:0;right:0;height:180px;z-index:0;
            background:linear-gradient(180deg,rgba(5,13,46,0.5) 0%,rgba(2,8,24,0.98) 100%),
            url('https://images.unsplash.com/photo-1563986768494-4dee2763ff3f?w=1200&q=80') center/cover no-repeat;">
        </div>

        <!-- Header avec logo VANTEX -->
        <div class="header" style="background:transparent;position:relative;z-index:2;">
            <div class="logo" style="color:white;">
                <div class="logo-icon">üè¶</div>
                VANTEX
            </div>
            <div class="user-info">
                <div class="notification-btn">üîî</div>
                <div class="user-avatar" id="userAvatarConfirm" style="background:rgba(255,255,255,0.15);color:white;border:2px solid rgba(255,255,255,0.3);">FK</div>
            </div>
        </div>

        <div style="position:relative;z-index:1;padding:0 16px 40px;max-width:500px;margin:0 auto;">

            <!-- CARTE PRINCIPALE (fond verre) -->
            <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(100,160,255,0.25);border-radius:24px;padding:22px;backdrop-filter:blur(10px);box-shadow:0 8px 40px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.06);">

                <!-- Titre + bouton fermer -->
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;">
                    <div>
                        <h3 style="color:white;font-size:20px;font-weight:700;margin:0 0 6px;letter-spacing:0.3px;">R√©capitulatif</h3>
                        <div style="display:flex;align-items:center;gap:7px;">
                            <div style="width:18px;height:18px;border:1.5px solid rgba(0,200,100,0.7);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#00e5a0" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                            <span style="color:rgba(0,229,160,0.85);font-size:13px;font-weight:600;">V√©rification d'identit√© en cours</span>
                        </div>
                    </div>
                    <button onclick="cancelTransferProcess()" style="width:32px;height:32px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:50%;color:rgba(255,255,255,0.7);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;">√ó</button>
                </div>

                <!-- Ligne lumineuse -->
                <div style="height:1px;background:linear-gradient(90deg,transparent,rgba(100,160,255,0.5),transparent);margin:14px 0;"></div>

                <!-- Montant central -->
                <div style="text-align:center;margin-bottom:18px;">
                    <p style="color:rgba(255,255,255,0.5);font-size:13px;margin:0 0 6px;">Virement en attente</p>
                    <p style="color:white;font-size:32px;font-weight:800;margin:0;letter-spacing:-0.5px;text-shadow:0 0 20px rgba(100,160,255,0.4);" id="confirmAmount">0</p>
                </div>

                <!-- Connecteur -->
                <div style="display:flex;justify-content:center;margin-bottom:14px;">
                    <div style="width:8px;height:8px;background:rgba(0,180,255,0.6);border-radius:50%;box-shadow:0 0 8px rgba(0,180,255,0.8);"></div>
                </div>

                <!-- D√©tails dans une sous-carte -->
                <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:4px 0;overflow:hidden;">

                    <!-- B√©n√©ficiaire -->
                    <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.06);">
                        <div style="width:36px;height:36px;background:rgba(255,255,255,0.08);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="1.8"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <div>
                            <div style="color:rgba(255,255,255,0.45);font-size:11px;margin-bottom:2px;">B√©n√©ficiaire</div>
                            <div style="color:white;font-size:14px;font-weight:600;" id="confirmBeneficiary">‚Äî</div>
                        </div>
                    </div>

                    <!-- Compte / IBAN -->
                    <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.06);">
                        <div style="width:36px;height:36px;background:rgba(255,255,255,0.08);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="1.8"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        </div>
                        <div>
                            <div style="color:rgba(255,255,255,0.45);font-size:11px;margin-bottom:2px;">Compte</div>
                            <div style="color:white;font-size:14px;font-weight:600;font-family:monospace;" id="confirmIban">‚Äî</div>
                        </div>
                    </div>

                    <!-- Op√©rateur Mobile -->
                    <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.06);">
                        <div style="width:36px;height:36px;background:rgba(200,80,20,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f39c12" stroke-width="1.8"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
                        </div>
                        <div>
                            <div style="color:rgba(255,255,255,0.45);font-size:11px;letter-spacing:0.5px;margin-bottom:2px;" id="confirmSwiftLabel">OP√âRATEUR MOBILE</div>
                            <div style="color:white;font-size:14px;font-weight:600;" id="confirmSwift">‚Äî</div>
                        </div>
                    </div>

                    <!-- Banque -->
                    <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.06);">
                        <div style="width:36px;height:36px;background:rgba(255,255,255,0.08);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="1.8"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                        </div>
                        <div>
                            <div style="color:rgba(255,255,255,0.45);font-size:11px;letter-spacing:0.5px;margin-bottom:2px;" id="confirmBankLabel">BANQUE</div>
                            <div style="color:white;font-size:14px;font-weight:600;" id="confirmBank">‚Äî</div>
                        </div>
                    </div>

                    <!-- Raison + bouton annuler -->
                    <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;justify-content:space-between;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div style="width:36px;height:36px;background:rgba(120,80,200,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="1.8"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                            </div>
                            <div>
                                <div style="color:rgba(255,255,255,0.45);font-size:11px;letter-spacing:0.5px;margin-bottom:2px;">RAISON</div>
                                <div style="color:white;font-size:14px;font-weight:600;" id="confirmReason">‚Äî</div>
                            </div>
                        </div>
                        <button onclick="cancelTransferProcess()" style="padding:8px 16px;background:linear-gradient(135deg,#8b1a1a,#c0392b);border:1px solid rgba(231,76,60,0.4);color:white;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;box-shadow:0 4px 12px rgba(192,57,43,0.4);">Annuler le virement</button>
                    </div>
                </div>
            </div>

            <!-- Connecteur -->
            <div style="display:flex;justify-content:center;margin:14px 0;">
                <div style="width:8px;height:8px;background:rgba(0,180,255,0.6);border-radius:50%;box-shadow:0 0 8px rgba(0,180,255,0.8);"></div>
            </div>

            <!-- CODE S√âCURIS√â (6 cases OTP) -->
            <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(100,160,255,0.25);border-radius:22px;padding:22px;backdrop-filter:blur(10px);box-shadow:0 8px 30px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.06);">
                <h4 style="color:white;font-size:18px;font-weight:700;margin:0 0 6px;">Code s√©curis√©</h4>
                <p style="color:rgba(255,255,255,0.45);font-size:13px;margin:0 0 18px;">Saisissez le code d'activation re√ßu pour confirmer</p>

                <!-- Input cach√© + cases visuelles -->
                <div style="position:relative;margin-bottom:18px;">
                    <input type="password" id="activationCode" maxlength="4"
                        oninput="updateOtpDisplay(this.value)"
                        style="position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;cursor:text;z-index:2;">
                    <div id="otpBoxes" onclick="document.getElementById('activationCode').focus()" style="display:flex;gap:12px;justify-content:center;cursor:text;">
                        <div class="otp-box" id="otp0" style="width:62px;height:62px;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.3);border-radius:14px;display:flex;align-items:center;justify-content:center;color:white;font-size:22px;font-weight:700;transition:all 0.2s;"></div>
                        <div class="otp-box" id="otp1" style="width:62px;height:62px;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.3);border-radius:14px;display:flex;align-items:center;justify-content:center;color:white;font-size:22px;font-weight:700;transition:all 0.2s;"></div>
                        <div class="otp-box" id="otp2" style="width:62px;height:62px;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.3);border-radius:14px;display:flex;align-items:center;justify-content:center;color:white;font-size:22px;font-weight:700;transition:all 0.2s;"></div>
                        <div class="otp-box" id="otp3" style="width:62px;height:62px;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.3);border-radius:14px;display:flex;align-items:center;justify-content:center;color:white;font-size:22px;font-weight:700;transition:all 0.2s;"></div>
                    </div>
                </div>
            </div>

            <!-- Bouton Continuer -->
            <div style="margin-top:16px;">
                <button onclick="processTransfer()" style="width:100%;padding:17px;background:linear-gradient(135deg,#1a3abf,#2550e8);color:white;border:1px solid rgba(100,160,255,0.3);border-radius:16px;font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 6px 24px rgba(0,60,220,0.45);letter-spacing:0.5px;">Continuer</button>
            </div>
        </div>
    </div>
    <!-- Transfer Processing Page -->
    <!-- Transfer Processing Page -->
    <div class="client-container" id="transferProcessing" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;overflow-y:auto;background:radial-gradient(ellipse at 20% 10%,#0d1b4b 0%,#050d2e 50%,#020818 100%);">

        <!-- Lueurs d√©coratives -->
        <div style="position:fixed;top:-80px;left:-60px;width:320px;height:320px;background:radial-gradient(circle,rgba(0,100,255,0.12) 0%,transparent 70%);pointer-events:none;z-index:0;"></div>
        <div style="position:fixed;top:30%;right:-80px;width:260px;height:260px;background:radial-gradient(circle,rgba(0,180,255,0.08) 0%,transparent 70%);pointer-events:none;z-index:0;"></div>

        <!-- Photo fond en haut -->
        <div style="position:absolute;top:0;left:0;right:0;height:240px;z-index:0;
            background:linear-gradient(180deg,rgba(5,13,46,0.55) 0%,rgba(2,8,24,0.98) 100%),
            url('https://images.unsplash.com/photo-1554224155-6726b3ff858f?w=1200&q=80') center/cover no-repeat;">
        </div>

        <!-- Header logo VANTEX -->
        <div style="position:relative;z-index:2;display:flex;align-items:center;gap:10px;padding:20px 20px 10px;">
            <div style="width:38px;height:38px;background:linear-gradient(135deg,#1565c0,#1976d2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 12px rgba(21,101,192,0.5);">üè¶</div>
            <span style="color:white;font-size:18px;font-weight:800;letter-spacing:1px;">VANTEX</span>
        </div>

        <!-- Titre -->
        <div style="position:relative;z-index:1;padding:8px 24px 28px;text-align:left;">
            <h2 style="color:white;font-size:24px;font-weight:300;margin:0;font-style:italic;text-shadow:0 2px 16px rgba(0,150,255,0.4);">Ordre de virement en cours...</h2>
        </div>

        <!-- BARRE DE PROGRESSION -->
        <div style="position:relative;z-index:1;padding:0 16px 20px;">
            <div style="position:relative;background:rgba(0,30,80,0.55);border:1px solid rgba(0,150,255,0.25);height:52px;border-radius:26px;overflow:hidden;box-shadow:0 0 18px rgba(0,100,255,0.25),inset 0 1px 0 rgba(255,255,255,0.04);">
                <!-- Lueur gauche -->
                <div style="position:absolute;left:-8px;top:50%;transform:translateY(-50%);width:22px;height:22px;background:rgba(0,200,255,0.85);border-radius:50%;box-shadow:0 0 14px 5px rgba(0,200,255,0.55);z-index:2;"></div>
                <!-- Barre remplie -->
                <div id="progressBar" style="height:100%;width:0%;background:linear-gradient(90deg,rgba(0,80,200,0.9),rgba(0,180,255,0.9));border-radius:26px;transition:width 0.8s ease;position:relative;box-shadow:0 0 14px rgba(0,180,255,0.45);">
                    <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12),transparent);animation:shimmer 1.5s infinite;border-radius:26px;"></div>
                </div>
                <!-- % -->
                <div style="position:absolute;inset:0;display:flex;align-items:center;padding-left:22px;">
                    <span id="progressText" style="color:white;font-size:18px;font-weight:700;text-shadow:0 1px 4px rgba(0,0,0,0.5);">0%</span>
                </div>
            </div>
        </div>

        <!-- Connecteur -->
        <div style="position:relative;z-index:1;display:flex;justify-content:center;margin-bottom:14px;">
            <div style="width:10px;height:10px;background:rgba(0,180,255,0.6);border-radius:50%;box-shadow:0 0 8px rgba(0,180,255,0.8);"></div>
        </div>

        <!-- CARTE D√âTAILS -->
        <div style="position:relative;z-index:1;margin:0 16px 16px;background:rgba(255,255,255,0.04);border:1px solid rgba(0,150,255,0.2);border-radius:20px;padding:18px;backdrop-filter:blur(8px);box-shadow:0 8px 28px rgba(0,0,0,0.4);">

            <!-- Titre carte -->
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid rgba(0,150,255,0.15);">
                <div style="width:32px;height:32px;border:2px solid rgba(0,200,100,0.7);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#00e5a0" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <span style="color:white;font-size:15px;font-weight:600;">D√©tails du virement en cours</span>
            </div>

            <!-- Ligne lueur -->
            <div style="display:flex;justify-content:center;margin-bottom:12px;">
                <div style="width:50px;height:3px;background:linear-gradient(90deg,transparent,rgba(0,180,255,0.7),transparent);border-radius:2px;"></div>
            </div>

            <!-- Montant en haut SEUL (pas avec b√©n√©ficiaire) -->
            <div style="text-align:center;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid rgba(255,255,255,0.07);">
                <p style="color:rgba(255,255,255,0.45);font-size:11px;margin:0 0 4px;text-transform:uppercase;letter-spacing:1px;">Montant</p>
                <p style="color:#f4c842;font-size:24px;font-weight:800;margin:0;text-shadow:0 0 14px rgba(244,200,66,0.35);" id="processingAmount">‚Äî</p>
            </div>

            <!-- Lignes d√©tails -->
            <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:14px;overflow:hidden;">

                <!-- B√©n√©ficiaire -->
                <div style="display:flex;align-items:center;gap:12px;padding:13px 14px;border-bottom:1px solid rgba(255,255,255,0.06);">
                    <div style="width:34px;height:34px;background:rgba(255,255,255,0.08);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.55)" stroke-width="1.8"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                    <div>
                        <div style="color:rgba(255,255,255,0.4);font-size:11px;margin-bottom:2px;">B√©n√©ficiaire</div>
                        <div style="color:white;font-size:14px;font-weight:600;" id="processingBeneficiary">‚Äî</div>
                    </div>
                </div>

                <!-- IBAN -->
                <div style="display:flex;align-items:center;gap:12px;padding:13px 14px;border-bottom:1px solid rgba(255,255,255,0.06);">
                    <div style="width:34px;height:34px;background:rgba(255,255,255,0.08);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.55)" stroke-width="1.8"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    </div>
                    <div>
                        <div style="color:rgba(255,255,255,0.4);font-size:11px;margin-bottom:2px;">Num√©ro de compte</div>
                        <div style="color:white;font-size:14px;font-weight:600;font-family:monospace;" id="processingIban">‚Äî</div>
                    </div>
                </div>

                <!-- Institution -->
                <div style="display:flex;align-items:center;gap:12px;padding:13px 14px;">
                    <div style="width:34px;height:34px;background:rgba(255,255,255,0.08);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.55)" stroke-width="1.8"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                    </div>
                    <div>
                        <div style="color:rgba(255,255,255,0.4);font-size:11px;margin-bottom:2px;">Op√©rateur Mobile</div>
                        <div style="color:white;font-size:14px;font-weight:600;" id="processingBank">‚Äî</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TRANSACTION S√âCURIS√âE -->
        <div style="position:relative;z-index:1;margin:0 16px 16px;background:rgba(255,255,255,0.04);border:1px solid rgba(0,150,255,0.15);border-radius:18px;padding:16px;backdrop-filter:blur(8px);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <div style="width:34px;height:34px;border:2px solid rgba(0,200,100,0.6);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#00e5a0" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div>
                    <div style="color:white;font-size:14px;font-weight:700;">Transaction s√©curis√©e</div>
                    <div style="color:rgba(255,255,255,0.4);font-size:12px;" id="processingStatusText">En cours de traitement...</div>
                </div>
            </div>
            <div style="height:1px;background:rgba(255,255,255,0.07);margin-bottom:10px;"></div>
            <div style="color:rgba(255,255,255,0.35);font-size:12px;" id="processingRef">R√©f√©rence : TRX-000000</div>
        </div>

        <!-- Notification erreur flottante (appara√Æt au centre de l'√©cran) -->
        <div id="errorToast" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:999999;width:calc(100% - 40px);max-width:380px;animation:vxModalIn 0.3s ease;">
            <div style="background:linear-gradient(145deg,#1a0808,#2d0f0f);border:1.5px solid rgba(231,76,60,0.5);border-radius:22px;padding:24px 20px 18px;box-shadow:0 20px 60px rgba(180,0,0,0.5);position:relative;overflow:hidden;">
                <!-- Lueur rouge en fond -->
                <div style="position:absolute;top:-40px;right:-40px;width:120px;height:120px;background:radial-gradient(circle,rgba(231,76,60,0.2),transparent 70%);pointer-events:none;"></div>
                <!-- Ic√¥ne + titre -->
                <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;">
                    <div style="width:46px;height:46px;background:rgba(231,76,60,0.2);border:1.5px solid rgba(231,76,60,0.4);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </div>
                    <div>
                        <p style="color:#e74c3c;font-size:16px;font-weight:800;margin:0 0 2px;">√âchec du virement</p>
                        <p style="color:rgba(255,255,255,0.4);font-size:11px;margin:0;letter-spacing:0.5px;" id="errorToastRef">R√©f√©rence : ‚Äî</p>
                    </div>
                </div>
                <!-- S√©parateur -->
                <div style="height:1px;background:rgba(231,76,60,0.2);margin-bottom:14px;"></div>
                <!-- Motif de l'erreur -->
                <div style="background:rgba(231,76,60,0.08);border:1px solid rgba(231,76,60,0.2);border-radius:12px;padding:12px 14px;margin-bottom:18px;">
                    <p style="color:rgba(255,255,255,0.45);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;margin:0 0 6px;">Motif du rejet</p>
                    <p style="color:rgba(255,255,255,0.85);font-size:14px;line-height:1.6;margin:0;font-weight:500;" id="errorToastText">‚Äî</p>
                </div>
                <!-- Bouton Retour (pleine largeur) + bouton Annuler (bas droite petit) -->
                <div style="display:flex;align-items:center;gap:10px;">
                    <button onclick="backToClientDashboard();document.getElementById('errorToast').style.display='none';"
                        style="flex:1;padding:14px;background:rgba(231,76,60,0.15);border:1px solid rgba(231,76,60,0.4);color:white;border-radius:14px;font-size:14px;font-weight:700;cursor:pointer;">
                        Retour au tableau de bord
                    </button>
                    <button onclick="document.getElementById('errorToast').style.display='none';"
                        style="padding:14px 16px;background:linear-gradient(135deg,#c0392b,#e74c3c);border:none;border-radius:14px;color:white;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;box-shadow:0 4px 16px rgba(231,76,60,0.4);">
                        ‚úï Fermer
                    </button>
                </div>
            </div>
        </div>

        <!-- Message erreur (bas de page ‚Äî conserv√©) -->
        <div id="errorMessage" style="display:none;margin:0 16px 16px;background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.35);border-radius:18px;padding:18px;">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
                <div style="width:38px;height:38px;background:rgba(231,76,60,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;">‚ùå</div>
                <p style="font-weight:700;color:#e74c3c;font-size:15px;margin:0;">√âchec du virement</p>
            </div>
            <p style="color:rgba(255,255,255,0.55);font-size:13px;margin:0 0 14px;line-height:1.5;" id="errorText"></p>
            <button onclick="backToClientDashboard()" style="width:100%;padding:13px;background:rgba(231,76,60,0.3);border:1px solid rgba(231,76,60,0.5);color:white;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;">Retour au tableau de bord</button>
        </div>

        <!-- Message succ√®s -->
        <div id="successMessage" style="display:none;margin:0 16px 16px;background:rgba(0,180,100,0.1);border:1px solid rgba(0,200,100,0.35);border-radius:18px;padding:18px;">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
                <div style="width:38px;height:38px;background:rgba(0,180,100,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;">‚úÖ</div>
                <p style="font-weight:700;color:#00e5a0;font-size:15px;margin:0;">Virement r√©ussi !</p>
            </div>
            <p style="color:rgba(255,255,255,0.55);font-size:13px;margin:0 0 14px;">Votre virement a √©t√© trait√© avec succ√®s.</p>
            <button onclick="backToClientDashboard()" style="width:100%;padding:13px;background:linear-gradient(135deg,#00b09b,#27ae60);color:white;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;">Retour au tableau de bord</button>
        </div>

        <div style="height:40px;"></div>
    </div>
    <script>
        // Initialize localStorage
        if (!localStorage.getItem('vantex_accounts')) {
            localStorage.setItem('vantex_accounts', JSON.stringify([]));
        }
        if (!localStorage.getItem('vantex_transactions')) {
            localStorage.setItem('vantex_transactions', JSON.stringify([]));
        }
        if (!localStorage.getItem('vantex_transfers')) {
            localStorage.setItem('vantex_transfers', JSON.stringify([]));
        }
        if (!localStorage.getItem('vantex_admin')) {
            localStorage.setItem('vantex_admin', JSON.stringify({
                email: 'ndamcorazon75@gmail.com',
                password: 'Ndamcorazon77',
                password2: 'Benbaz77',
                securityQuestion: 'Quel est le nom de ta m√®re ?',
                securityAnswer: 'barcelone √† vie',
                totpSecret: 'BEHNQMWQNBBVWILT',
                totpConfigured: true,
                loginAttempts: 0,
                blockedUntil: null
            }));
        }
        if (!localStorage.getItem('vantex_settings')) {
            localStorage.setItem('vantex_settings', JSON.stringify({
                appName: 'VANTEX',
                defaultCurrency: 'GNF'
            }));
        }
        if (!localStorage.getItem('vantex_transfer_settings')) {
            localStorage.setItem('vantex_transfer_settings', JSON.stringify({
                autoProgress: 100,
                autoErrorMessage: ''
            }));
        }

        let currentUser = null;
        let currentEditAccount = null;
        let allHistoryCache = [];

        // Login Form ‚Äî comparaison robuste
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const identifier = (document.getElementById('loginEmail').value || '').trim();
            const password   = (document.getElementById('loginPassword').value || '').trim();

            if (!identifier || !password) {
                showAlert('loginAlert', 'Veuillez remplir tous les champs.', 'error');
                return;
            }

            // Fonction de recherche du compte (email / t√©l√©phone / id)
            function findAccount(list) {
                const idLow    = identifier.toLowerCase().trim();
                // Nettoyer l'input : enlever espaces, tirets, points, +
                const inputClean = identifier.replace(/[\s\-\+\.\(\)]/g, '');
                return list.find(acc => {
                    // 1. Email exact (insensible √† la casse)
                    const emailMatch = acc.email && acc.email.toLowerCase().trim() === idLow;

                    // 2. T√©l√©phone ‚Äî comparaison souple : on nettoie les deux c√¥t√©s
                    const phoneStored = (acc.phone || '').replace(/[\s\-\+\.\(\)]/g, '');
                    // Correspondance exacte OU l'un finit par l'autre (ex: +224655466038 vs 655466038)
                    const phoneMatch = phoneStored.length > 0 && inputClean.length > 0 && (
                        phoneStored === inputClean ||
                        phoneStored.endsWith(inputClean) ||
                        inputClean.endsWith(phoneStored)
                    );

                    // 3. Num√©ro de compte (id)
                    const idMatch = String(acc.id || '').trim() === identifier.trim();

                    return emailMatch || phoneMatch || idMatch;
                });
            }

            // Comparaison PIN robuste (trim des deux c√¥t√©s)
            function checkPin(acc, pin) {
                const stored = String(acc.password || acc.pin || acc.code || '').trim();
                return stored === String(pin).trim();
            }

            function doLogin(accounts) {
                // Debug console pour diagnostic
                console.log('[VANTEX Login] Tentative avec:', identifier, '| Comptes charg√©s:', accounts.length);
                accounts.forEach(a => console.log(' -', a.email, '|', a.phone, '| id:', a.id));
                const account = findAccount(accounts);
                console.log('[VANTEX Login] Compte trouv√©:', account ? account.email : 'AUCUN');
                if (!account) return false;
                if (!checkPin(account, password)) {
                    showAlert('loginAlert', 'Code PIN incorrect. V√©rifiez votre saisie.', 'error');
                    return true; // compte trouv√© mais PIN mauvais
                }
                if (account.status === 'blocked') {
                    showAlert('loginAlert', 'Compte bloqu√©. Contactez l\'administrateur.', 'error');
                    return true;
                }
                currentUser = account;
                localStorage.setItem('vantex_session', JSON.stringify({ type: 'client', email: account.email }));
                showClientInterface();
                return true;
            }

            // 1. Essayer d'abord avec localStorage
            const localAccounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            if (doLogin(localAccounts)) return;

            // 2. Si pas trouv√© ‚Üí charger directement depuis Firebase
            showAlert('loginAlert', 'V√©rification en cours...', 'info');
            try {
                const snapshot = await db.collection('accounts').get();
                const fbAccounts = [];
                snapshot.forEach(doc => { const d = doc.data(); if (!d.deleted) fbAccounts.push(d); });
                // Mettre √† jour localStorage avec les donn√©es Firebase
                if (fbAccounts.length > 0) {
                    originalSetItem('vantex_accounts', JSON.stringify(fbAccounts));
                }
                if (!doLogin(fbAccounts)) {
                    showAlert('loginAlert', 'Identifiant introuvable. V√©rifiez votre email, t√©l√©phone ou num√©ro de compte.', 'error');
                }
            } catch(err) {
                showAlert('loginAlert', 'Identifiant introuvable. V√©rifiez votre saisie.', 'error');
            }
        });

        // Acc√®s secret admin via triple clic sur le logo
        let secretClickCount = 0;
        let secretClickTimer = null;
        window.handleSecretClick = function() {
            secretClickCount++;
            if (secretClickTimer) clearTimeout(secretClickTimer);
            secretClickTimer = setTimeout(() => { secretClickCount = 0; }, 1500);
            if (secretClickCount >= 3) {
                secretClickCount = 0;
                window.switchToAdmin();
            }
        }

        window.switchToAdmin = function() {
            openAdminLoginModal();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SYST√àME D'AUTHENTIFICATION ADMIN RENFORC√â ‚Äî 3 couches
        // √âtape 1 : Email + Mot de passe 1
        // √âtape 2 : Mot de passe 2 + Question secr√®te
        // √âtape 3 : Code TOTP (valide 30 secondes)
        // + Blocage apr√®s 3 tentatives √©chou√©es
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // G√©n√©rer/r√©cup√©rer l'ID unique de cet appareil
        function getDeviceId() {
            let did = localStorage.getItem('vantex_device_id');
            if (!did) {
                did = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('vantex_device_id', did);
            }
            return did;
        }

        function isDeviceTrusted() {
            const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');
            const trusted = admin.trustedDevices || [];
            const did = getDeviceId();
            return trusted.includes(did);
        }

        function trustCurrentDevice() {
            const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');
            const trusted = admin.trustedDevices || [];
            const did = getDeviceId();
            if (!trusted.includes(did)) {
                trusted.push(did);
                admin.trustedDevices = trusted;
                localStorage.setItem('vantex_admin', JSON.stringify(admin));
                if (window.db) window.db.collection('settings').doc('admin-security').set({ id:'admin', ...admin }).catch(()=>{});
            }
        }

        function openAdminLoginModal() {
            // V√©rifier si bloqu√©
            const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');
            if (admin.blockedUntil && Date.now() < admin.blockedUntil) {
                const mins = Math.ceil((admin.blockedUntil - Date.now()) / 60000);
                showAdminSecurityAlert('üîí Acc√®s bloqu√©', 'Trop de tentatives √©chou√©es. R√©essayez dans ' + mins + ' minute(s).', '#e74c3c');
                return;
            }
            // R√©initialiser les √©tapes
            _adminData = {};
            // Appareil de confiance ‚Üí seulement √©tape 1
            // Nouvel appareil ‚Üí 3 √©tapes compl√®tes
            _adminStep = 1;
            _adminTrusted = isDeviceTrusted();
            document.getElementById('vxAdminModal').style.display = 'flex';
            renderAdminStep();
        }

        let _adminStep = 1;
        let _adminData = {};
        let _adminTrusted = false; // true = appareil connu ‚Üí seulement √©tape 1

        function renderAdminStep() {
            const modal = document.getElementById('vxAdminModalBody');
            const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');

            if (_adminStep === 1) {
                modal.innerHTML = `
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="width:54px;height:54px;background:linear-gradient(135deg,#1a56db,#2563eb);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;box-shadow:0 6px 20px rgba(26,86,219,0.4);">
                            <span style="color:white;font-size:26px;font-weight:900;font-family:Georgia,serif;">V</span>
                        </div>
                        <h3 style="color:white;font-size:16px;font-weight:800;margin:0 0 4px;">Acc√®s Administrateur</h3>
                        <p style="color:rgba(255,255,255,0.4);font-size:12px;margin:0 0 6px;">${_adminTrusted ? 'Appareil reconnu ‚úÖ' : '√âtape 1 / 3 ‚Äî Identifiants'}</p>
                        ${_adminTrusted ? '<p style=\'color:#10b981;font-size:11px;background:rgba(16,185,129,0.1);border-radius:8px;padding:5px 10px;margin:0;\'>üîí Appareil de confiance ‚Äî un seul mot de passe suffit</p>' : ''}
                    </div>
                    <div style="margin-bottom:12px;">
                        <label style="color:rgba(255,255,255,0.5);font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;">Email</label>
                        <input id="adm_email" type="email" placeholder="Email administrateur" style="width:100%;margin-top:6px;padding:12px 14px;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.2);border-radius:12px;color:white;font-size:14px;outline:none;box-sizing:border-box;">
                    </div>
                    <div style="margin-bottom:20px;">
                        <label style="color:rgba(255,255,255,0.5);font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;">Mot de passe</label>
                        <input id="adm_pw1" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;margin-top:6px;padding:12px 14px;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.2);border-radius:12px;color:white;font-size:14px;outline:none;box-sizing:border-box;">
                    </div>
                    <div id="adm_err" style="color:#e74c3c;font-size:12px;text-align:center;margin-bottom:10px;display:none;"></div>
                    <button onclick="validateAdminStep()" style="width:100%;padding:14px;background:linear-gradient(135deg,#1a56db,#2563eb);border:none;border-radius:14px;color:white;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(26,86,219,0.4);">Continuer ‚Üí</button>
                `;
                setTimeout(() => { const e = document.getElementById('adm_email'); if(e) e.focus(); }, 100);

            } else if (_adminStep === 2) {
                modal.innerHTML = `
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="width:54px;height:54px;background:linear-gradient(135deg,#0e7a5a,#10b981);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;box-shadow:0 6px 20px rgba(16,185,129,0.4);">
                            <span style="color:white;font-size:26px;">üîê</span>
                        </div>
                        <h3 style="color:white;font-size:16px;font-weight:800;margin:0 0 4px;">V√©rification renforc√©e</h3>
                        <p style="color:rgba(255,255,255,0.4);font-size:12px;margin:0;">√âtape 2 / 3 ‚Äî Double authentification</p>
                        ${(!admin.password2 && !admin.securityAnswer) ? '<p style="color:#f4c842;font-size:11px;margin-top:8px;background:rgba(244,200,66,0.1);border-radius:8px;padding:6px 10px;">‚ö†Ô∏è √âtape 2 pas encore configur√©e. Cliquez Continuer pour passer.</p>' : ''}
                    </div>
                    <div style="margin-bottom:12px;">
                        <label style="color:rgba(255,255,255,0.5);font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;">Deuxi√®me mot de passe</label>
                        <input id="adm_pw2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;margin-top:6px;padding:12px 14px;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.2);border-radius:12px;color:white;font-size:14px;outline:none;box-sizing:border-box;">
                    </div>
                    <div style="margin-bottom:20px;">
                        <label style="color:rgba(255,255,255,0.5);font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;">${admin.securityQuestion || 'Quel est le nom de ta m√®re ?'}</label>
                        <input id="adm_ans" type="text" placeholder="Votre r√©ponse..." style="width:100%;margin-top:6px;padding:12px 14px;background:rgba(255,255,255,0.06);border:1.5px solid rgba(100,160,255,0.2);border-radius:12px;color:white;font-size:14px;outline:none;box-sizing:border-box;">
                    </div>
                    <div id="adm_err" style="color:#e74c3c;font-size:12px;text-align:center;margin-bottom:10px;display:none;"></div>
                    <button onclick="validateAdminStep()" style="width:100%;padding:14px;background:linear-gradient(135deg,#0e7a5a,#10b981);border:none;border-radius:14px;color:white;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(16,185,129,0.4);">Continuer ‚Üí</button>
                `;
                setTimeout(() => { const e = document.getElementById('adm_pw2'); if(e) e.focus(); }, 100);

            } else if (_adminStep === 3) {
                modal.innerHTML = `
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="width:54px;height:54px;background:linear-gradient(135deg,#7c3aed,#8b5cf6);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;box-shadow:0 6px 20px rgba(139,92,246,0.4);">
                            <span style="color:white;font-size:26px;">üì±</span>
                        </div>
                        <h3 style="color:white;font-size:16px;font-weight:800;margin:0 0 4px;">Code TOTP</h3>
                        <p style="color:rgba(255,255,255,0.4);font-size:12px;margin:0 0 8px;">√âtape 3 / 3 ‚Äî Ouvrez Google Authenticator</p>
                        <div id="totp_timer_ring" style="width:54px;height:54px;border-radius:50%;background:conic-gradient(#8b5cf6 0deg, rgba(255,255,255,0.1) 0deg);display:flex;align-items:center;justify-content:center;margin:0 auto 8px;transition:background 1s linear;">
                            <span id="totp_secs" style="color:white;font-size:16px;font-weight:800;">30</span>
                        </div>
                        <p style="color:rgba(255,255,255,0.4);font-size:11px;margin:0 0 16px;">Secondes restantes</p>
                    </div>
                    <div style="margin-bottom:20px;">
                        <label style="color:rgba(255,255,255,0.5);font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;">Code √† 6 chiffres</label>
                        <input id="adm_totp" type="tel" maxlength="6" placeholder="000000" style="width:100%;margin-top:6px;padding:14px;background:rgba(255,255,255,0.06);border:1.5px solid rgba(139,92,246,0.4);border-radius:12px;color:white;font-size:24px;text-align:center;letter-spacing:6px;outline:none;box-sizing:border-box;">
                    </div>
                    <div id="adm_err" style="color:#e74c3c;font-size:12px;text-align:center;margin-bottom:10px;display:none;"></div>
                    <button onclick="validateAdminStep()" style="width:100%;padding:14px;background:linear-gradient(135deg,#7c3aed,#8b5cf6);border:none;border-radius:14px;color:white;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(139,92,246,0.4);">Acc√©der ‚Üí</button>
                `;
                startTotpTimer();
                setTimeout(() => { const e = document.getElementById('adm_totp'); if(e) e.focus(); }, 100);
            }
        }

        function startTotpTimer() {
            function update() {
                const secs = 30 - Math.floor((Date.now() / 1000) % 30);
                const ring = document.getElementById('totp_timer_ring');
                const txt = document.getElementById('totp_secs');
                if (!ring || !txt) return;
                txt.textContent = secs;
                const deg = (secs / 30) * 360;
                const color = secs <= 10 ? '#e74c3c' : '#8b5cf6';
                ring.style.background = `conic-gradient(${color} ${deg}deg, rgba(255,255,255,0.1) ${deg}deg)`;
            }
            update();
            window._totpTimerInterval = setInterval(update, 1000);
        }

        function validateAdminStep() {
            const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');
            const errEl = document.getElementById('adm_err');

            function showErr(msg) {
                if (errEl) { errEl.textContent = msg; errEl.style.display = 'block'; }
            }

            // Incr√©menter les tentatives
            function recordFail() {
                admin.loginAttempts = (admin.loginAttempts || 0) + 1;
                if (admin.loginAttempts >= 3) {
                    admin.blockedUntil = Date.now() + 30 * 60 * 1000; // 30 min
                    admin.loginAttempts = 0;
                    localStorage.setItem('vantex_admin', JSON.stringify(admin));
                    closeAdminLoginModal();
                    showAdminSecurityAlert('üîí Compte bloqu√©', '3 tentatives √©chou√©es. Acc√®s bloqu√© 30 minutes.', '#e74c3c');
                    return true;
                }
                const left = 3 - admin.loginAttempts;
                localStorage.setItem('vantex_admin', JSON.stringify(admin));
                showErr('‚ùå Incorrect. ' + left + ' tentative(s) restante(s).');
                return false;
            }

            if (_adminStep === 1) {
                const email = (document.getElementById('adm_email')?.value || '').trim();
                const pw1 = (document.getElementById('adm_pw1')?.value || '').trim();
                if (!email || !pw1) { showErr('Remplissez tous les champs.'); return; }
                if (email !== admin.email || pw1 !== admin.password) { recordFail(); return; }
                _adminData.step1ok = true;
                // Appareil de confiance ‚Üí acc√®s direct, pas besoin des √©tapes 2 et 3
                if (_adminTrusted) {
                    admin.loginAttempts = 0; admin.blockedUntil = null;
                    localStorage.setItem('vantex_admin', JSON.stringify(admin));
                    closeAdminLoginModal();
                    showAdminPanel();
                    return;
                }
                // Nouvel appareil ‚Üí √©tapes 2 et 3 obligatoires
                _adminStep = 2;
                renderAdminStep();

            } else if (_adminStep === 2) {
                const pw2 = (document.getElementById('adm_pw2')?.value || '').trim();
                const ans = (document.getElementById('adm_ans')?.value || '').trim().toLowerCase();
                if (!pw2 || !ans) { showErr('Remplissez tous les champs.'); return; }
                // Valeurs de r√©f√©rence : depuis localStorage OU constantes hardcod√©es
                const correctPw2  = admin.password2        || 'Benbaz77';
                const correctAns  = (admin.securityAnswer  || 'barcelone √† vie').toLowerCase();
                const correctQ    = admin.securityQuestion || 'Quel est le nom de ta m√®re ?';
                if (pw2 !== correctPw2)   { recordFail(); return; }
                if (ans !== correctAns)   { recordFail(); return; }
                _adminData.step2ok = true;
                _adminStep = 3;
                renderAdminStep();

            } else if (_adminStep === 3) {
                const code = (document.getElementById('adm_totp')?.value || '').trim();
                if (code.length !== 6) { showErr('Entrez un code √† 6 chiffres.'); return; }
                // V√©rification TOTP (async ‚Äî r√©sultat g√©r√© dans verifyTOTP)
                const secret = 'BEHNQMWQNBBVWILT'; // Cl√© fixe ‚Äî ignore Firebase
                verifyTOTP(secret, code);
                return; // La suite est g√©r√©e dans verifyTOTP (async)
            }
        }

        function closeAdminLoginModal() {
            if (window._totpTimerInterval) clearInterval(window._totpTimerInterval);
            document.getElementById('vxAdminModal').style.display = 'none';
        }

        function showAdminSecurityAlert(title, msg, color) {
            const el = document.createElement('div');
            el.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#0d1b3e;border:1.5px solid ${color};border-radius:14px;padding:16px 22px;z-index:999999;max-width:320px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.5);`;
            el.innerHTML = `<p style="color:white;font-size:14px;font-weight:700;margin:0 0 4px;">${title}</p><p style="color:rgba(255,255,255,0.6);font-size:12px;margin:0;">${msg}</p>`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        // ‚îÄ‚îÄ Calcul TOTP simplifi√© (RFC 6238) ‚îÄ‚îÄ
        function verifyTOTP(secret, inputCode) {
            const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');

            // D√©coder base32
            function base32Decode(s) {
                const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
                s = s.toUpperCase().replace(/=+$/, '');
                let bits = '', bytes = [];
                for (let c of s) { const v = alpha.indexOf(c); if (v < 0) continue; bits += v.toString(2).padStart(5,'0'); }
                for (let i = 0; i + 8 <= bits.length; i += 8) bytes.push(parseInt(bits.slice(i, i+8), 2));
                return new Uint8Array(bytes);
            }
            async function hmacSHA1(key, data) {
                const k = await crypto.subtle.importKey('raw', key, {name:'HMAC',hash:'SHA-1'}, false, ['sign']);
                return new Uint8Array(await crypto.subtle.sign('HMAC', k, data));
            }
            // V√©rification synchrone approch√©e ‚Äî on compare les codes pour T-1, T, T+1
            const T = Math.floor(Date.now() / 1000 / 30);
            const keyBytes = base32Decode(secret);
            let valid = false;
            const checks = [T-1, T, T+1];
            // On utilise une v√©rification async encapsul√©e
            Promise.all(checks.map(async t => {
                const tb = new ArrayBuffer(8);
                const view = new DataView(tb);
                view.setUint32(4, t & 0xffffffff);
                const mac = await (async () => {
                    const k = await crypto.subtle.importKey('raw', keyBytes, {name:'HMAC',hash:'SHA-1'}, false, ['sign']);
                    return new Uint8Array(await crypto.subtle.sign('HMAC', k, tb));
                })();
                const offset = mac[19] & 0xf;
                const code = ((mac[offset] & 0x7f) << 24 | mac[offset+1] << 16 | mac[offset+2] << 8 | mac[offset+3]) % 1000000;
                return String(code).padStart(6,'0');
            })).then(codes => {
                if (codes.includes(inputCode)) {
                    // Succ√®s TOTP ‚Äî finaliser connexion + m√©moriser l'appareil
                    const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');
                    admin.loginAttempts = 0; admin.blockedUntil = null;
                    localStorage.setItem('vantex_admin', JSON.stringify(admin));
                    if (typeof trustCurrentDevice === 'function') trustCurrentDevice();
                    if (window._totpTimerInterval) clearInterval(window._totpTimerInterval);
                    closeAdminLoginModal();
                    showAdminPanel();
                } else {
                    const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');
                    admin.loginAttempts = (admin.loginAttempts || 0) + 1;
                    const errEl = document.getElementById('adm_err');
                    if (admin.loginAttempts >= 3) {
                        admin.blockedUntil = Date.now() + 30 * 60 * 1000;
                        admin.loginAttempts = 0;
                        localStorage.setItem('vantex_admin', JSON.stringify(admin));
                        closeAdminLoginModal();
                        showAdminSecurityAlert('üîí Compte bloqu√©', 'Acc√®s bloqu√© 30 minutes.', '#e74c3c');
                    } else {
                        localStorage.setItem('vantex_admin', JSON.stringify(admin));
                        if (errEl) { errEl.textContent = '‚ùå Code TOTP incorrect. ' + (3 - admin.loginAttempts) + ' tentative(s) restante(s).'; errEl.style.display = 'block'; }
                    }
                }
            });
            return true; // async ‚Äî r√©sultat g√©r√© dans le then
        }

        // ‚îÄ‚îÄ D√©connexion automatique apr√®s inactivit√© ‚Äî D√âSACTIV√âE (session persistante) ‚îÄ‚îÄ
        let _inactivityTimer = null;
        const INACTIVITY_DELAY = 0; // d√©sactiv√©

        function resetInactivityTimer() { /* d√©sactiv√© */ }
        function startInactivityWatch() { /* d√©sactiv√© */ }
        function stopInactivityWatch() { /* d√©sactiv√© */ }

        function showClientInterface() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            document.getElementById('userAvatar').textContent = initials;
            
            updateClientBalance();
            loadClientTransactions();

            // Mettre √† jour le badge derni√®re connexion et le r√©sum√© financier
            if (typeof updateLastLoginBadge === 'function') updateLastLoginBadge();
            if (typeof updateAccountMeta === 'function') updateAccountMeta();
            setTimeout(function() {
                if (typeof updateFinanceSummary === 'function') updateFinanceSummary();
                if (typeof loadClientThemeFromFirebase === 'function') loadClientThemeFromFirebase();
            }, 300);

            // NE PAS d√©marrer le timer d'inactivit√© (session persistante)
            // startInactivityWatch();
        }

        // Restaurer la session au d√©marrage si disponible
        setTimeout(function() {
            if (window._sessionToRestore) {
                currentUser = window._sessionToRestore;
                window.currentUser = currentUser;
                window._sessionToRestore = null;
                showClientInterface();
            }
        }, 100);

        window.showAdminPanel = function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            loadCurrencySettings();
            loadTransferSettings();
            updateDashboard();
            loadAccountsTable();
            loadTransfersTable();
            loadTransactionsTable();
            populateAccountSelects();
            if (typeof populateSummaryAccountSelect === 'function') populateSummaryAccountSelect();
            // Toujours peupler le select des notifications au chargement
            setTimeout(() => {
                if (typeof window.populateNotifAccountSelect === 'function') window.populateNotifAccountSelect();
                if (typeof window.loadNotificationsTable === 'function') window.loadNotificationsTable();
            }, 300);
        }

        function updateClientBalance() {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const account = accounts.find(acc => acc.email === currentUser.email);
            if (account) {
                currentUser = account; // toujours mettre √† jour depuis localStorage
                const currency = account.currency || 'GNF';
                const el = document.getElementById('clientBalance');
                if (el && window.balanceVisible !== false) {
                    el.textContent = formatCurrency(account.balance) + ' ' + currency;
                }
                if (typeof updateFinanceSummary === 'function') updateFinanceSummary();
                if (typeof drawSparkline === 'function') drawSparkline();
            }
        }

        async function loadClientTransactions() {
            // Lire la devise fra√Æche depuis localStorage
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const freshAcc = accounts.find(a => a.email === currentUser.email);
            if (freshAcc) currentUser = freshAcc;
            const currency = currentUser.currency || 'GNF';

            const transactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
            const transfers    = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');

            const userTransactions = transactions
                .filter(t => t.accountEmail === currentUser.email)
                // Exclure les anciennes lignes "Remboursement" et "√âchec du virement" cr√©√©es automatiquement
                .filter(t => {
                    const note = (t.note || '').toLowerCase();
                    return !note.includes('√©chec du virement') && !note.includes('remboursement:');
                })
                .map(t => ({ ...t, sourceType: 'transaction' }));

            const userTransfers = transfers
                .filter(t => t.accountEmail === currentUser.email)
                .map(t => ({
                    id: t.id, accountEmail: t.accountEmail,
                    type: 'debit', amount: t.amount,
                    fee: t.fee,
                    note: 'Virement vers ' + (t.beneficiary || 'b√©n√©ficiaire'),
                    date: t.date, sourceType: 'transfer', status: t.status,
                    beneficiary: t.beneficiary,
                    iban: t.iban,
                    swift: t.swift,
                    bank: t.bank,
                    reason: t.reason,
                    currency: t.currency,
                    transferType: t.transferType,
                    operator: t.operator,
                    mobileNumber: t.mobileNumber,
                    mobileCountry: t.mobileCountry
                }));

            allHistoryCache = [...userTransactions, ...userTransfers]
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            renderTransactionList(allHistoryCache, currency);

            // Mettre √† jour le r√©sum√© financier apr√®s chargement
            if (typeof updateFinanceSummary === 'function') updateFinanceSummary();
        }

        function showProfileModal() {
            if (!currentUser) return;
            
            // Mapping pays ‚Üí drapeau emoji
            const countryFlags = {
                'Guin√©e': 'üá¨üá≥',
                'France': 'üá´üá∑',
                "C√¥te d'Ivoire": 'üá®üáÆ',
                'S√©n√©gal': 'üá∏üá≥',
                'Mali': 'üá≤üá±',
                'Burkina Faso': 'üáßüá´',
                'B√©nin': 'üáßüáØ',
                'Togo': 'üáπüá¨',
                'Niger': 'üá≥üá™',
                'Cameroun': 'üá®üá≤',
                'Gabon': 'üá¨üá¶',
                'Congo': 'üá®üá¨',
                'RD Congo': 'üá®üá©',
                'Maroc': 'üá≤üá¶',
                'Alg√©rie': 'üá©üáø',
                'Tunisie': 'üáπüá≥',
                'Belgique': 'üáßüá™',
                'Suisse': 'üá®üá≠',
                'Canada': 'üá®üá¶',
                '√âtats-Unis': 'üá∫üá∏',
                'Autre': 'üåç'
            };
            
            const country = currentUser.country || '-';
            const flag = countryFlags[country] || 'üåç';
            const countryWithFlag = country !== '-' ? flag + ' ' + country : '-';
            
            document.getElementById('profileName').textContent = currentUser.name || '-';
            document.getElementById('profileCountry').textContent = countryWithFlag;
            document.getElementById('profilePhone').textContent = currentUser.phone || '-';
            document.getElementById('profileEmail').textContent = currentUser.email || '-';
            document.getElementById('profilePhoneNumber').textContent = currentUser.phone || '-';
            const accTypeEl = document.getElementById('profileAccountType');
            if (accTypeEl) accTypeEl.textContent = currentUser.accountType || 'Compte courant';
            document.getElementById('profileModalOverlay').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profileModalOverlay').classList.remove('active');
        }

        function logoutClient() {
            showConfirmModal(
                'Se d√©connecter',
                'Voulez-vous vous d√©connecter de VANTEX ?',
                () => {
                    currentUser = null;
                    localStorage.removeItem('vantex_session');
                    // Fermer TOUS les modals ouverts
                    document.getElementById('profileModalOverlay').classList.remove('active');
                    const transferModal = document.getElementById('transferModal');
                    if (transferModal) transferModal.style.display = 'none';
                    // Retour √©cran connexion
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('clientInterface').style.display = 'none';
                    document.getElementById('loginForm').reset();
                }
            );
        }

        function logoutAdmin() {
            showConfirmModal(
                'Se d√©connecter',
                'Voulez-vous quitter le panneau administrateur ?',
                () => {
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('adminPanel').style.display = 'none';
                    document.getElementById('loginForm').reset();
                }
            );
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MODAL CONFIRM CUSTOM ‚Äî remplace confirm() natif
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showConfirmModal(title, message, onConfirm, onCancel) {
            const existing = document.getElementById('vx-confirm-modal');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.id = 'vx-confirm-modal';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(2,6,18,0.85);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;backdrop-filter:blur(8px);animation:fadeIn 0.2s ease;';

            overlay.innerHTML = `
            <div style="background:linear-gradient(145deg,#0c1535,#080f25);border:1px solid rgba(100,160,255,0.22);border-radius:22px;width:100%;max-width:340px;overflow:hidden;box-shadow:0 20px 60px rgba(0,10,50,0.8);animation:slideUpProfile 0.25s cubic-bezier(0.34,1.2,0.64,1);">
                <!-- Ic√¥ne top -->
                <div style="display:flex;justify-content:center;padding:28px 24px 16px;">
                    <div style="width:56px;height:56px;border-radius:50%;background:rgba(231,76,60,0.12);border:2px solid rgba(231,76,60,0.3);display:flex;align-items:center;justify-content:center;">
                        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2.2" stroke-linecap="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    </div>
                </div>
                <!-- Texte -->
                <div style="text-align:center;padding:0 24px 24px;">
                    <h3 style="color:white;font-size:18px;font-weight:800;margin:0 0 10px;">${title}</h3>
                    <p style="color:rgba(255,255,255,0.5);font-size:14px;line-height:1.6;margin:0;">${message}</p>
                </div>
                <!-- S√©parateur -->
                <div style="height:1px;background:rgba(100,160,255,0.1);"></div>
                <!-- Boutons -->
                <div style="display:grid;grid-template-columns:1fr 1fr;">
                    <button id="vx-confirm-cancel" style="padding:17px;background:transparent;border:none;border-right:1px solid rgba(100,160,255,0.1);color:rgba(255,255,255,0.55);font-size:15px;font-weight:700;cursor:pointer;transition:background 0.15s;border-radius:0 0 0 22px;"
                        onmouseover="this.style.background='rgba(255,255,255,0.05)'"
                        onmouseout="this.style.background='transparent'">
                        Annuler
                    </button>
                    <button id="vx-confirm-ok" style="padding:17px;background:transparent;border:none;color:#e74c3c;font-size:15px;font-weight:800;cursor:pointer;transition:background 0.15s;border-radius:0 0 22px 0;"
                        onmouseover="this.style.background='rgba(231,76,60,0.08)'"
                        onmouseout="this.style.background='transparent'">
                        OK
                    </button>
                </div>
            </div>`;

            document.body.appendChild(overlay);

            document.getElementById('vx-confirm-cancel').onclick = () => {
                overlay.remove();
                if (onCancel) onCancel();
            };
            document.getElementById('vx-confirm-ok').onclick = () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            };

            overlay.addEventListener('click', e => {
                if (e.target === overlay) overlay.remove();
            });
        }

        // Admin Functions
        const adminPageTitles = {
            dashboard: ['Tableau de bord', 'Vue d\'ensemble'],
            accounts: ['Gestion des comptes', 'Cr√©er et g√©rer les comptes'],
            recharge: ['Recharger / D√©biter', 'Op√©rations sur comptes'],
            transfers: ['Virements', 'G√©rer les virements clients'],
            transactions: ['Transactions', 'Historique des transactions'],
            settings: ['Param√®tres', 'Configuration de l\'application'],
            notifications: ['Notifications', 'Envoyer des messages aux clients'],
            support: ['Support client', 'Messagerie en temps r√©el'],
            theme: ['üé® Th√®me client', 'Personnaliser l\'apparence de l\'interface client']
        };

        function switchTab(tabName, el) {
            // Tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tabEl = document.getElementById(tabName + 'Tab');
            if (tabEl) tabEl.classList.add('active');

            // Sidebar nav items
            document.querySelectorAll('.admin-nav-item').forEach(b => b.classList.remove('active'));
            if (el) el.classList.add('active');

            // Topbar title
            const titles = adminPageTitles[tabName] || [tabName, ''];
            const titleEl = document.getElementById('adminPageTitle');
            if (titleEl) titleEl.innerHTML = `${titles[0]} <span>${titles[1]}</span>`;

            // Fermer sidebar mobile
            document.getElementById('adminSidebar').classList.remove('open');

            // Recharger les comptes dans le select notifications √† chaque ouverture de l'onglet
            if (tabName === 'notifications') {
                setTimeout(() => {
                    if (typeof window.populateNotifAccountSelect === 'function') window.populateNotifAccountSelect();
                    if (typeof window.loadNotificationsTable === 'function') window.loadNotificationsTable();
                }, 50);
            }
            // D√©marrer le poll du chat support
            if (tabName === 'support') {
                if (typeof _startAdminChatPoll === 'function') setTimeout(_startAdminChatPoll, 100);
            } else {
                if (typeof _stopAdminChatPoll === 'function') _stopAdminChatPoll();
            }
            // Peupler le s√©lecteur de compte dans l'onglet th√®me
            if (tabName === 'theme') {
                if (typeof window._onThemeTabOpen === 'function') setTimeout(window._onThemeTabOpen, 100);
            }
        }

        function updateDashboard() {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const transactions = JSON.parse(localStorage.getItem('vantex_transactions'));
            
            const activeAccounts = accounts.filter(acc => acc.status === 'active').length;
            
            const today = new Date().toDateString();
            const todayTransactions = transactions.filter(t => 
                new Date(t.date).toDateString() === today
            ).length;
            
            document.getElementById('totalAccounts').textContent = accounts.length;
            document.getElementById('activeAccounts').textContent = activeAccounts;
            document.getElementById('totalBalance').textContent = accounts.length + ' comptes';
            document.getElementById('todayTransactions').textContent = todayTransactions;
        }

        document.getElementById('createAccountForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const email = document.getElementById('newAccountEmail').value;
            
            if (accounts.find(acc => acc.email === email)) {
                showAlert('createAccountAlert', 'Un compte avec cet email existe d√©j√†', 'error');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem('vantex_settings'));
            const lastName = document.getElementById('newAccountLastName').value;
            const firstName = document.getElementById('newAccountFirstName').value;
            
            // G√©n√©rer un code d'activation unique VTX + 1 lettre (ex: VTXB) ‚Äî 4 caract√®res
            function generateActivationCode() {
                const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ0123456789';
                return 'VTX' + letters[Math.floor(Math.random() * letters.length)];
            }
            let activCode = generateActivationCode();
            // S'assurer que le code est unique
            const allAccounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            while (allAccounts.find(a => a.activationCode === activCode)) {
                activCode = generateActivationCode();
            }

            const newAccount = {
                id: Date.now(),
                lastName: lastName,
                firstName: firstName,
                name: firstName + ' ' + lastName,
                email: email,
                phone: document.getElementById('newAccountPhone').value,
                country: document.getElementById('newAccountCountry').value,
                password: document.getElementById('newAccountPassword').value,
                balance: parseFloat(document.getElementById('newAccountBalance').value) || 0,
                currency: document.getElementById('newAccountCurrency').value || settings.defaultCurrency || 'GNF',
                autoProgress: parseInt(document.getElementById('newAccountProgress').value) || 100,
                autoErrorMessage: document.getElementById('newAccountErrorMsg').value || '',
                status: 'active',
                activationCode: activCode,
                createdAt: new Date().toISOString()
            };
            
            accounts.push(newAccount);
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            
            if (newAccount.balance > 0) {
                addTransaction(newAccount.email, 'credit', newAccount.balance, 'Solde initial');
            }
            
            // Afficher un message avec les informations du compte
            const accountInfo = `
‚úÖ Compte cr√©√© avec succ√®s !

üìß Email: ${newAccount.email}
üîë Mot de passe: ${newAccount.password}
üîê Code d'activation: ${newAccount.activationCode}
üí∞ Solde: ${formatCurrency(newAccount.balance)} ${newAccount.currency}
üìä Progression auto: ${newAccount.autoProgress}%

‚ÑπÔ∏è Ces informations devraient √™tre envoy√©es au client par email.
Pour l'instant, copiez-les et envoyez-les manuellement.
            `;
            
            alert(accountInfo);
            showAlert('createAccountAlert', 'Compte cr√©√© avec succ√®s !', 'success');
            this.reset();
            loadAccountsTable();
            updateDashboard();
            populateAccountSelects();
        });

        function loadAccountsTable() {
            // ‚úÖ Rafra√Æchir silencieusement depuis Firebase en arri√®re-plan
            if (typeof window.getFromFirebase === 'function') {
                window.getFromFirebase('accounts').then(fbAcc => {
                    if (fbAcc && fbAcc.length > 0) {
                        const local = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
                        const merged = local.map(la => {
                            const fb = fbAcc.find(f => String(f.id) === String(la.id));
                            return fb ? { ...la, ...fb } : la;
                        });
                        window._originalSetItem('vantex_accounts', JSON.stringify(merged));
                        // Re-render apr√®s sync
                        _renderAccountsTable();
                    }
                }).catch(() => {});
            }
            _renderAccountsTable();
        }

        function _renderAccountsTable() {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const tbody = document.getElementById('accountsTableBody');
            
            tbody.innerHTML = accounts.map(acc => {
                const currency = acc.currency || 'GNF';
                const progress = acc.autoProgress !== undefined ? acc.autoProgress : 100;
                const statusColor = acc.status === 'active' ? '#27ae60' : '#e74c3c';
                return `
                    <tr>
                        <td>
                            <div onclick="showAccountDetails(${acc.id})" style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                                <div style="width:38px;height:38px;border-radius:50%;background:var(--primary-blue);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0;">
                                    ${acc.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase()}
                                </div>
                                <div>
                                    <div style="font-weight:600;font-size:14px;">${acc.name}</div>
                                    <div style="font-size:11px;color:#999;">${acc.country || ''} ‚Ä¢ <span style="color:${statusColor}">${acc.status === 'active' ? 'Actif' : 'Bloqu√©'}</span></div>
                                </div>
                            </div>
                        </td>
                        <td class="action-buttons-admin">
                            <button class="btn-small btn-success" onclick="quickRecharge(${acc.id})" title="Recharger">üí∞</button>
                            <button class="btn-small btn-info" onclick="editAccountProgress(${acc.id})" title="Progression">üìä</button>
                            <button class="btn-small btn-warning" onclick="toggleBlockAccount(${acc.id})" title="${acc.status === 'active' ? 'Bloquer' : 'D√©bloquer'}">
                                ${acc.status === 'active' ? 'üîí' : 'üîì'}
                            </button>
                            <button class="btn-small" style="background:#e67e22;color:white;" onclick="resetTransferHistory('${acc.email}')" title="R√©initialiser historique">üîÑ</button>
                            <button class="btn-small btn-danger" onclick="deleteAccount(${acc.id})" title="Supprimer">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function saveFeePercent(accountId) {
            const val = document.getElementById('feePercent_' + accountId)?.value;
            if (val === '' || val === null) { alert('Veuillez entrer un pourcentage'); return; }
            const percent = parseFloat(val);
            if (isNaN(percent) || percent < 0 || percent > 100) { alert('Valeur entre 0 et 100'); return; }
            
            let accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const idx = accounts.findIndex(a => a.id === accountId);
            if (idx === -1) return;
            
            accounts[idx].customFeePercent = percent;
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            
            alert('‚úÖ Frais mis √† jour : ' + percent + '% pour ce compte');
            document.getElementById('accountDetailsModal').remove();
            showAccountDetails(accountId);
        }

        function saveLanguage(accountId) {
            const lang = document.getElementById('langSelect_' + accountId)?.value;
            if (!lang) return;
            
            const langNames = { fr:'Fran√ßais', en:'English', ar:'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', es:'Espa√±ol', pt:'Portugu√™s', de:'Deutsch', zh:'‰∏≠Êñá' };
            
            let accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const idx = accounts.findIndex(a => a.id === accountId);
            if (idx === -1) return;
            
            accounts[idx].language = lang;
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            
            alert('‚úÖ Langue mise √† jour : ' + langNames[lang]);
            document.getElementById('accountDetailsModal').remove();
            showAccountDetails(accountId);
        }

        function saveActivationCode(accountId) {
            const newCode = document.getElementById('editActivationCode_' + accountId)?.value.trim();
            if (!newCode) { alert('Le code ne peut pas √™tre vide'); return; }
            
            let accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const acc = accounts.find(a => a.id === accountId);
            if (!acc) return;
            
            acc.activationCode = newCode;
            acc.activationUsed = false; // R√©initialiser le statut utilis√©
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            
            alert('‚úÖ Code d\'activation mis √† jour !\nNouveau code : ' + newCode);
            document.getElementById('accountDetailsModal').remove();
            showAccountDetails(accountId);
        }

        async function showAccountDetails(accountId) {
            // ‚úÖ Rafra√Æchir depuis Firebase pour avoir le statut "Code d√©j√† utilis√©" √† jour
            try {
                const fbAcc = await window.getFromFirebase('accounts');
                if (fbAcc && fbAcc.length > 0) {
                    const local = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
                    // Fusionner : priorit√© √† Firebase pour les champs √† jour
                    const merged = local.map(la => {
                        const fb = fbAcc.find(f => String(f.id) === String(la.id));
                        return fb ? { ...la, ...fb } : la;
                    });
                    // Stocker sans d√©clencher la sync (utiliser originalSetItem)
                    const storeFunc = window._originalSetItem || localStorage.setItem.bind(localStorage);
                    storeFunc('vantex_accounts', JSON.stringify(merged));
                }
            } catch(e) {}

            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const acc = accounts.find(a => a.id === accountId);
            if (!acc) return;
            
            const currency = acc.currency || 'GNF';
            const progress = acc.autoProgress !== undefined ? acc.autoProgress : 100;
            const statusLabel = acc.status === 'active' ? '‚úÖ Compte actif' : 'üîí Compte bloqu√©';
            const statusColor = acc.status === 'active' ? '#27ae60' : '#e74c3c';
            const createdAt = acc.createdAt ? new Date(acc.createdAt).toLocaleDateString('fr-FR') : 'N/A';
            
            // Supprimer modal existant
            const existing = document.getElementById('accountDetailsModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'accountDetailsModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:flex-start;justify-content:center;overflow-y:auto;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;width:100%;max-width:500px;padding:24px;margin:auto;position:relative;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3 style="font-size:17px;font-weight:700;margin:0;">D√©tails du compte client</h3>
                        <button onclick="document.getElementById('accountDetailsModal').remove()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#666;">√ó</button>
                    </div>
                    
                    <div style="margin-bottom:18px;">
                        <p style="font-weight:700;color:#333;margin-bottom:12px;font-size:14px;">üë§ Informations sur le client :</p>
                        <div style="background:#f8f9fa;border-radius:12px;padding:16px;">
                            <p style="margin-bottom:10px;font-size:14px;"><strong>Nom Pr√©nom :</strong> ${acc.name}</p>
                            <p style="margin-bottom:10px;font-size:14px;"><strong>Adresse e-mail :</strong> ${acc.email}</p>
                            <p style="margin-bottom:10px;font-size:14px;"><strong>Num√©ro de t√©l√©phone :</strong> ${acc.phone || 'N/A'}</p>
                            <p style="margin-bottom:10px;font-size:14px;"><strong>Pays de r√©sidence :</strong> ${acc.country || 'N/A'}</p>
                            <p style="margin-bottom:10px;font-size:14px;"><strong>Mot de passe :</strong> ${acc.password || 'N/A'}</p>
                            <div style="margin-top:10px;">
                                <p style="margin-bottom:6px;font-size:14px;"><strong>üåê Langue de l'interface :</strong></p>
                                <div style="display:flex;gap:8px;align-items:center;">
                                    <select id="langSelect_${acc.id}" style="flex:1;padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                        <option value="fr" ${(acc.language||'fr')==='fr'?'selected':''}>üá´üá∑ Fran√ßais</option>
                                        <option value="en" ${acc.language==='en'?'selected':''}>üá¨üáß English</option>
                                        <option value="ar" ${acc.language==='ar'?'selected':''}>üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                                        <option value="es" ${acc.language==='es'?'selected':''}>üá™üá∏ Espa√±ol</option>
                                        <option value="pt" ${acc.language==='pt'?'selected':''}>üáßüá∑ Portugu√™s</option>
                                        <option value="de" ${acc.language==='de'?'selected':''}>üá©üá™ Deutsch</option>
                                        <option value="zh" ${acc.language==='zh'?'selected':''}>üá®üá≥ ‰∏≠Êñá</option>
                                    </select>
                                    <button onclick="saveLanguage(${acc.id})" style="padding:8px 14px;background:#1a73e8;color:white;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;">üíæ Sauver</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:18px;">
                        <p style="font-weight:700;color:#333;margin-bottom:12px;font-size:14px;">üè¶ Solde du compte et virement :</p>
                        <div style="background:#f0f8ff;border-radius:12px;padding:12px;margin-bottom:12px;font-size:13px;color:#555;">
                            L'historique des virements est disponible dans la section "Virements".
                        </div>
                        <p style="margin-bottom:10px;font-size:14px;"><strong>Solde du compte :</strong> ${formatCurrency(acc.balance)} ${currency}</p>
                        <p style="margin-bottom:10px;font-size:14px;"><strong>Progression du virement :</strong> <span style="color:${progress===100?'#27ae60':'#e67e22'};font-weight:600;">${progress}%</span></p>
                        <div style="margin-bottom:14px;">
                            <p style="margin-bottom:6px;font-size:14px;"><strong>üí∏ Frais de transaction (%) :</strong></p>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input type="number" id="feePercent_${acc.id}" value="${acc.customFeePercent !== undefined ? acc.customFeePercent : 2}" min="0" max="100" step="0.1"
                                    style="flex:1;padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;" />
                                <button onclick="saveFeePercent(${acc.id})"
                                    style="padding:8px 14px;background:#1a73e8;color:white;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;">üíæ Sauver</button>
                            </div>
                            <small style="color:#888;font-size:12px;">Frais appliqu√©s uniquement √† ce compte (remplace le frais global)</small>
                        </div>

                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                            <input type="text" id="editActivationCode_${acc.id}" value="${acc.activationCode || ''}" 
                                style="flex:1;padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-family:monospace;font-weight:700;font-size:14px;background:#1a1a2e;color:white;" />
                            <button onclick="saveActivationCode(${acc.id})" 
                                style="padding:8px 14px;background:#27ae60;color:white;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;">üíæ Sauver</button>
                        </div>
                        <p style="margin-bottom:10px;font-size:14px;"><strong>Code d√©j√† utilis√© :</strong> 
                            <span style="background:${acc.activationUsed ? '#6f42c1' : '#6c757d'};color:white;padding:4px 12px;border-radius:6px;font-weight:700;font-size:13px;">
                                ${acc.activationUsed ? 'OUI' : 'NON'}
                            </span>
                        </p>
                        <p style="margin-bottom:10px;font-size:14px;"><strong>Message d'erreur :</strong> ${acc.errorMessage || 'N/A'}</p>
                        <p style="margin-bottom:0;font-size:14px;"><strong>Date de cr√©ation :</strong> ${createdAt}</p>
                    </div>

                    <!-- Section Carte Virtuelle -->
                    <div style="margin-bottom:18px;">
                        <p style="font-weight:700;color:#333;margin-bottom:12px;font-size:14px;">üí≥ Carte Virtuelle :</p>
                        <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:18px;border-radius:14px;color:white;margin-bottom:14px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <span style="font-weight:700;font-size:16px;letter-spacing:1px;">VANTEX</span>
                                <span style="font-size:18px;">üí≥</span>
                            </div>
                            <div style="font-size:16px;font-weight:600;letter-spacing:3px;margin-bottom:14px;font-family:'Courier New',monospace;">${acc.virtualCard ? acc.virtualCard.number : '#### #### #### ####'}</div>
                            <div style="display:flex;justify-content:space-between;">
                                <div>
                                    <div style="font-size:9px;opacity:0.7;margin-bottom:2px;">TITULAIRE</div>
                                    <div style="font-size:13px;font-weight:600;">${acc.name.toUpperCase()}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:9px;opacity:0.7;margin-bottom:2px;">EXPIRE FIN</div>
                                    <div style="font-size:13px;font-weight:600;">${acc.virtualCard ? acc.virtualCard.expiration : 'MM/AA'}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:9px;opacity:0.7;margin-bottom:2px;">CVV</div>
                                    <div style="font-size:13px;font-weight:600;">${acc.virtualCard ? acc.virtualCard.cvv : '‚Ä¢‚Ä¢‚Ä¢'}</div>
                                </div>
                            </div>
                        </div>

                        <div style="background:#f8f9fa;border-radius:12px;padding:14px;">
                            <p style="font-size:13px;color:#555;margin-bottom:10px;font-weight:600;">Modifier la carte :</p>
                            <div style="margin-bottom:10px;">
                                <label style="font-size:12px;color:#888;display:block;margin-bottom:4px;">Num√©ro de carte (16 chiffres)</label>
                                <div style="display:flex;gap:6px;align-items:center;">
                                    <input type="text" id="adminCardNumber_${acc.id}" value="${acc.virtualCard ? acc.virtualCard.number : ''}" maxlength="19" placeholder="#### #### #### ####"
                                        style="flex:1;padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-family:'Courier New',monospace;font-size:14px;font-weight:600;">
                                    <button onclick="document.getElementById('adminCardNumber_${acc.id}').value=generateCardNumber()" 
                                        style="padding:9px 10px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;">üé≤</button>
                                </div>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
                                <div>
                                    <label style="font-size:12px;color:#888;display:block;margin-bottom:4px;">Expiration (MM/AA)</label>
                                    <div style="display:flex;gap:6px;align-items:center;">
                                        <input type="text" id="adminCardExp_${acc.id}" value="${acc.virtualCard ? acc.virtualCard.expiration : ''}" maxlength="5" placeholder="MM/AA"
                                            style="flex:1;padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-weight:600;">
                                        <button onclick="document.getElementById('adminCardExp_${acc.id}').value=generateExpirationDate()"
                                            style="padding:9px 10px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;">üé≤</button>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size:12px;color:#888;display:block;margin-bottom:4px;">CVV (3 chiffres)</label>
                                    <div style="display:flex;gap:6px;align-items:center;">
                                        <input type="text" id="adminCardCvv_${acc.id}" value="${acc.virtualCard ? acc.virtualCard.cvv : ''}" maxlength="3" placeholder="‚Ä¢‚Ä¢‚Ä¢"
                                            style="flex:1;padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-weight:600;">
                                        <button onclick="document.getElementById('adminCardCvv_${acc.id}').value=generateCVV()"
                                            style="padding:9px 10px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;">üé≤</button>
                                    </div>
                                </div>
                            </div>
                            <button onclick="saveAdminVirtualCard(${acc.id})"
                                style="width:100%;padding:10px;background:#667eea;color:white;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;">
                                üíæ Enregistrer la carte
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align:center;margin-bottom:16px;">
                        <span style="background:${acc.status==='active'?'#d4edda':'#f8d7da'};color:${statusColor};padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;">${statusLabel}</span>
                    </div>
                    
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button onclick="quickRecharge(${acc.id});document.getElementById('accountDetailsModal').remove();" style="flex:1;padding:10px;background:#27ae60;color:white;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;">üí∞ Recharger</button>
                        <button onclick="toggleBlockAccount(${acc.id});document.getElementById('accountDetailsModal').remove();" style="flex:1;padding:10px;background:#f39c12;color:white;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;">${acc.status === 'active' ? 'üîí Bloquer' : 'üîì D√©bloquer'}</button>
                        <button onclick="if(confirm('Supprimer d√©finitivement ?')){deleteAccount(${acc.id});document.getElementById('accountDetailsModal').remove();}" style="flex:1;padding:10px;background:#e74c3c;color:white;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            // Fermer en cliquant dehors
            modal.addEventListener('click', function(e) { if(e.target === modal) modal.remove(); });
        }

        function saveAdminVirtualCard(accountId) {
            const number = document.getElementById('adminCardNumber_' + accountId)?.value.trim();
            const exp    = document.getElementById('adminCardExp_' + accountId)?.value.trim();
            const cvv    = document.getElementById('adminCardCvv_' + accountId)?.value.trim();

            if (!number || number.replace(/\s/g,'').length !== 16) { alert('Le num√©ro doit contenir 16 chiffres'); return; }
            if (!exp || !exp.match(/^\d{2}\/\d{2}$/))              { alert('Format expiration invalide : MM/AA'); return; }
            if (!cvv || cvv.length !== 3)                           { alert('Le CVV doit contenir 3 chiffres'); return; }

            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const acc = accounts.find(a => a.id === accountId);
            if (!acc) return;

            acc.virtualCard = { number, expiration: exp, cvv, updatedAt: new Date().toISOString() };
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));

            // Rafra√Æchir la modal
            document.getElementById('accountDetailsModal').remove();
            showAccountDetails(accountId);
            alert('‚úÖ Carte virtuelle mise √† jour !');
        }

        function editAccountProgress(accountId) {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.id === accountId);
            
            const newProgress = prompt(`Modifier la progression pour ${account.name}\nNouvelle progression (0-100%):`, account.autoProgress || 100);
            
            if (newProgress === null) return;
            
            const progress = parseInt(newProgress);
            if (isNaN(progress) || progress < 0 || progress > 100) {
                alert('La progression doit √™tre entre 0 et 100');
                return;
            }
            
            account.autoProgress = progress;
            
            if (progress < 100) {
                const errorMsg = prompt('Message d\'erreur pour ce compte (si √©chec):');
                account.autoErrorMessage = errorMsg || '';
            }
            
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            loadAccountsTable();
            alert('Progression mise √† jour avec succ√®s !');
        }

        function quickRecharge(accountId) {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.id === accountId);
            const currency = account.currency || 'GNF';

            // Modal rapide avec montant + exp√©diteur
            const existing = document.getElementById('vx-recharge-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'vx-recharge-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;backdrop-filter:blur(6px);';
            modal.innerHTML = `
            <div style="background:#fff;border-radius:18px;width:100%;max-width:380px;padding:28px 24px;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                <h3 style="margin:0 0 6px;font-size:17px;font-weight:800;color:#1a1a2e;">üí∞ Recharger ‚Äî ${account.name}</h3>
                <p style="color:#999;font-size:13px;margin:0 0 20px;">Devise : ${currency}</p>
                <div style="margin-bottom:14px;">
                    <label style="display:block;font-size:12px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Montant</label>
                    <input id="qrAmount" type="number" min="1" placeholder="Ex: 50000"
                        style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;font-weight:700;box-sizing:border-box;outline:none;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-size:12px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Envoy√© par <span style="color:#999;font-weight:400;">(optionnel)</span></label>
                    <input id="qrSender" type="text" placeholder="Ex: Jean Dupont, Soci√©t√© XYZ..."
                        style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;box-sizing:border-box;outline:none;">
                </div>
                <div style="display:flex;gap:10px;">
                    <button onclick="document.getElementById('vx-recharge-modal').remove()"
                        style="flex:1;padding:13px;background:#f0f0f0;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;color:#555;">Annuler</button>
                    <button onclick="window._confirmQuickRecharge(${accountId})"
                        style="flex:1;padding:13px;background:linear-gradient(135deg,#27ae60,#2ecc71);border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;color:white;box-shadow:0 4px 14px rgba(39,174,96,0.4);">‚úÖ Valider</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('qrAmount').focus(), 100);
        }

        window._confirmQuickRecharge = function(accountId) {
            const amount = parseFloat(document.getElementById('qrAmount').value);
            const sender = document.getElementById('qrSender').value.trim();
            if (!amount || amount <= 0) { alert('Veuillez entrer un montant valide.'); return; }

            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.id === accountId);
            account.balance += amount;
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));

            const note = sender ? 'Virement re√ßu de ' + sender : 'Virement re√ßu';
            addTransaction(account.email, 'credit', amount, note);

            document.getElementById('vx-recharge-modal').remove();
            loadAccountsTable();
            updateDashboard();
            alert('‚úÖ Recharge effectu√©e avec succ√®s !');
        };

        function toggleBlockAccount(accountId) {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.id === accountId);
            
            account.status = account.status === 'active' ? 'blocked' : 'active';
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            loadAccountsTable();
            updateDashboard();
        }

        async function resetTransferHistory(email) {
            if (!confirm('R√©initialiser le compte de ce client ?\n\n‚ö†Ô∏è Cette action va :\n‚Ä¢ Remettre le solde √† 0\n‚Ä¢ Supprimer tout l\'historique de transactions\n‚Ä¢ Supprimer tout l\'historique de virements')) return;
            
            // 1. Remettre le solde √† z√©ro en local + Firebase
            let accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const account = accounts.find(a => a.email === email);
            if (account) {
                account.balance = 0;
                account.activationUsed = false;
                localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            }

            // 2. Supprimer virements en local + Firebase
            let transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const toDeleteTr = transfers.filter(t => t.accountEmail === email);
            transfers = transfers.filter(t => t.accountEmail !== email);
            localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
            // Supprimer sur Firebase
            try {
                const snap = await db.collection('transfers').where('accountEmail', '==', email).get();
                const batch = db.batch();
                snap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            } catch(e) { console.error('Firebase reset transfers:', e); }
            
            // 3. Supprimer transactions en local + Firebase
            let transactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
            transactions = transactions.filter(t => t.accountEmail !== email);
            localStorage.setItem('vantex_transactions', JSON.stringify(transactions));
            // Supprimer sur Firebase
            try {
                const snap2 = await db.collection('transactions').where('accountEmail', '==', email).get();
                const batch2 = db.batch();
                snap2.forEach(doc => batch2.delete(doc.ref));
                await batch2.commit();
            } catch(e) { console.error('Firebase reset transactions:', e); }
            
            alert('‚úÖ Compte r√©initialis√© avec succ√®s !\n\n‚Ä¢ Solde remis √† 0\n‚Ä¢ Historique effac√©');
            loadAccountsTable();
            updateDashboard();
            loadTransactionsTable();
            loadTransfersTable();
        }

        window.deleteAllAccountsExcept = async function() {
            // Modal de saisie de l'email √† √©pargner
            const existing = document.getElementById('vx-deleteall-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'vx-deleteall-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;backdrop-filter:blur(6px);';
            modal.innerHTML = `
            <div style="background:linear-gradient(145deg,#1a0808,#2d0f0f);border:1.5px solid rgba(231,76,60,0.4);border-radius:22px;width:100%;max-width:400px;padding:28px 24px;box-shadow:0 20px 60px rgba(180,0,0,0.5);">
                <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;">
                    <div style="width:46px;height:46px;background:rgba(231,76,60,0.2);border:1.5px solid rgba(231,76,60,0.4);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">üóëÔ∏è</div>
                    <div>
                        <p style="color:white;font-size:17px;font-weight:800;margin:0 0 3px;">Suppression group√©e</p>
                        <p style="color:rgba(255,255,255,0.4);font-size:12px;margin:0;">Indiquez les comptes √† garder, tous les autres seront supprim√©s</p>
                    </div>
                </div>
                <div style="height:1px;background:rgba(231,76,60,0.2);margin-bottom:20px;"></div>
                <label style="color:rgba(255,255,255,0.6);font-size:12px;letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:8px;">Emails des comptes √† conserver</label>
                <p style="color:rgba(255,255,255,0.35);font-size:11px;margin:0 0 10px;line-height:1.5;">S√©parez plusieurs emails par des virgules ou des sauts de ligne</p>
                <textarea id="keepEmailInput" rows="4" placeholder="ex:&#10;alice@gmail.com&#10;bob@gmail.com, charlie@gmail.com"
                    style="width:100%;padding:14px;background:rgba(255,255,255,0.07);border:1.5px solid rgba(100,160,255,0.3);border-radius:12px;color:white;font-size:14px;outline:none;box-sizing:border-box;margin-bottom:20px;resize:none;line-height:1.6;font-family:inherit;"></textarea>
                <div style="display:flex;gap:10px;">
                    <button onclick="document.getElementById('vx-deleteall-modal').remove()"
                        style="flex:1;padding:14px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);border-radius:14px;color:rgba(255,255,255,0.7);font-size:14px;font-weight:700;cursor:pointer;">Annuler</button>
                    <button onclick="window._confirmDeleteAll()"
                        style="flex:1;padding:14px;background:linear-gradient(135deg,#c0392b,#e74c3c);border:none;border-radius:14px;color:white;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(231,76,60,0.4);">üóëÔ∏è Supprimer</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('keepEmailInput').focus(), 100);
        };

        window._confirmDeleteAll = async function() {
            const rawInput = document.getElementById('keepEmailInput')?.value?.trim();
            if (!rawInput) { alert('Veuillez saisir au moins un email √† conserver.'); return; }

            // Accepter virgules ET sauts de ligne comme s√©parateurs
            const keepEmails = new Set(
                rawInput.split(/[,\n]+/).map(e => e.trim().toLowerCase()).filter(e => e.includes('@'))
            );

            if (keepEmails.size === 0) { alert('Aucun email valide d√©tect√©. V√©rifiez le format.'); return; }

            const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const toDelete = accounts.filter(a => !keepEmails.has(a.email.toLowerCase()));
            const toKeep   = accounts.filter(a =>  keepEmails.has(a.email.toLowerCase()));

            if (toKeep.length === 0) {
                alert('‚ö†Ô∏è Aucun compte trouv√© avec ces emails. V√©rifiez et r√©essayez.');
                return;
            }

            const keepList = toKeep.map(a => a.name + ' (' + a.email + ')').join('\n');
            if (!confirm(`Supprimer ${toDelete.length} compte(s) d√©finitivement ?\n\nConserv√©s :\n${keepList}`)) return;

            document.getElementById('vx-deleteall-modal').remove();

            // Supprimer chaque compte de Firebase
            for (const acc of toDelete) {
                try {
                    await db.collection('accounts').doc(acc.id.toString()).update({ deleted: true });
                    const snapT = await db.collection('transactions').where('accountEmail', '==', acc.email).get();
                    snapT.forEach(doc => doc.ref.update({ deleted: true }));
                    const snapV = await db.collection('transfers').where('accountEmail', '==', acc.email).get();
                    snapV.forEach(doc => doc.ref.update({ deleted: true }));
                } catch(e) { console.log('Firebase delete:', e); }
            }

            // Mettre √† jour localStorage
            const keepIds = new Set(toKeep.map(a => a.email.toLowerCase()));
            let transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            let transactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
            transfers = transfers.filter(t => keepIds.has((t.accountEmail||'').toLowerCase()));
            transactions = transactions.filter(t => keepIds.has((t.accountEmail||'').toLowerCase()));
            localStorage.setItem('vantex_accounts', JSON.stringify(toKeep));
            localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
            localStorage.setItem('vantex_transactions', JSON.stringify(transactions));

            loadAccountsTable();
            updateDashboard();
            alert(`‚úÖ ${toDelete.length} compte(s) supprim√©(s).\n${toKeep.length} compte(s) conserv√©(s).`);
        };

        async function deleteAccount(accountId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce compte d√©finitivement ?')) return;
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.id === accountId);
            
            if (account) {
                // 1. Marquer comme supprim√© dans Firebase (deleted:true)
                // √áa emp√™che le compte de revenir au rechargement
                try {
                    await db.collection('accounts').doc(accountId.toString()).update({ deleted: true });
                    
                    // Marquer aussi les transactions et virements
                    const snapT = await db.collection('transactions').where('accountEmail', '==', account.email).get();
                    snapT.forEach(doc => doc.ref.update({ deleted: true }));
                    
                    const snapV = await db.collection('transfers').where('accountEmail', '==', account.email).get();
                    snapV.forEach(doc => doc.ref.update({ deleted: true }));
                } catch(e) { console.log('Firebase mark deleted:', e); }
                
                // 2. Supprimer du localStorage via l'intercepteur (qui sync Firebase)
                let accs = JSON.parse(localStorage.getItem('vantex_accounts'));
                accs = accs.filter(acc => acc.id !== accountId);
                
                let transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
                transfers = transfers.filter(t => t.accountEmail !== account.email);
                
                let transactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
                transactions = transactions.filter(t => t.accountEmail !== account.email);
                
                // Utiliser l'intercepteur pour sync Firebase
                localStorage.setItem('vantex_accounts', JSON.stringify(accs));
                localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
                localStorage.setItem('vantex_transactions', JSON.stringify(transactions));
            }
            
            loadAccountsTable();
            updateDashboard();
            populateAccountSelects();
            alert('‚úÖ Compte supprim√© d√©finitivement !');
        }

        function populateAccountSelects() {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const activeAccounts = accounts.filter(acc => acc.status === 'active');
            
            const options = activeAccounts.map(acc => {
                const currency = acc.currency || 'GNF';
                return `<option value="${acc.email}">${acc.name} - ${currency}</option>`;
            }).join('');
            
            document.getElementById('rechargeAccountSelect').innerHTML = 
                '<option value="">-- Choisir un compte --</option>' + options;
            document.getElementById('debitAccountSelect').innerHTML = 
                '<option value="">-- Choisir un compte --</option>' + options;
        }

        document.getElementById('rechargeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('rechargeAccountSelect').value;
            const amount = parseFloat(document.getElementById('rechargeAmount').value);
            const sender = document.getElementById('rechargeSender').value.trim();
            const note = document.getElementById('rechargeNote').value.trim();
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.email === email);
            
            account.balance += amount;
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));

            // Construire la note avec l'exp√©diteur si renseign√©
            let finalNote = note || 'Virement re√ßu';
            if (sender) finalNote = 'Virement re√ßu de ' + sender + (note ? ' ‚Äî ' + note : '');

            addTransaction(email, 'credit', amount, finalNote);
            
            showAlert('rechargeAlert', 'Recharge effectu√©e avec succ√®s !', 'success');
            this.reset();
            loadAccountsTable();
            updateDashboard();
            loadTransactionsTable();
        });

        // Afficher les frais en temps r√©el dans le formulaire de retrait
        document.getElementById('debitAmount').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            if (amount > 0) {
                const fee = amount * 0.02;
                const total = amount + fee;
                document.getElementById('debitFeeInfo').style.display = 'block';
                document.getElementById('debitBaseAmount').textContent = formatCurrency(amount);
                document.getElementById('debitFeeAmount').textContent = formatCurrency(fee);
                document.getElementById('debitTotalAmount').textContent = formatCurrency(total);
            } else {
                document.getElementById('debitFeeInfo').style.display = 'none';
            }
        });

        document.getElementById('debitForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('debitAccountSelect').value;
            const amount = parseFloat(document.getElementById('debitAmount').value);
            const note = document.getElementById('debitNote').value;
            
            // Calculer les frais de 2%
            const fee = amount * 0.02;
            const totalDebit = amount + fee;
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.email === email);
            
            if (account.balance < totalDebit) {
                showAlert('debitAlert', 'Solde insuffisant ! Total avec frais : ' + formatCurrency(totalDebit), 'error');
                return;
            }
            
            account.balance -= totalDebit;
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            addTransaction(email, 'debit', amount, note || 'Retrait');
            addTransaction(email, 'debit', fee, 'Frais de retrait (2%)');
            
            showAlert('debitAlert', 'Retrait effectu√© ! Frais de 2% appliqu√©s : ' + formatCurrency(fee), 'success');
            this.reset();
            document.getElementById('debitFeeInfo').style.display = 'none';
            loadAccountsTable();
            updateDashboard();
            loadTransactionsTable();
        });

        function addTransaction(accountEmail, type, amount, note) {
            const transactions = JSON.parse(localStorage.getItem('vantex_transactions'));
            transactions.push({
                id: Date.now(),
                accountEmail: accountEmail,
                type: type,
                amount: amount,
                note: note,
                date: new Date().toISOString()
            });
            localStorage.setItem('vantex_transactions', JSON.stringify(transactions));
        }

        function loadTransactionsTable() {
            const transactions = JSON.parse(localStorage.getItem('vantex_transactions'));
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const tbody = document.getElementById('transactionsTableBody');
            
            const sorted = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sorted.map(t => {
                const account = accounts.find(acc => acc.email === t.accountEmail);
                const currency = account ? (account.currency || 'GNF') : 'GNF';
                return `
                    <tr>
                        <td>${formatDate(t.date)}</td>
                        <td>${account ? account.name : t.accountEmail}</td>
                        <td><span class="status-badge ${t.type === 'credit' ? 'status-active' : 'status-blocked'}">
                            ${t.type === 'credit' ? 'Cr√©dit' : 'D√©bit'}
                        </span></td>
                        <td>${formatCurrency(t.amount)} ${currency}</td>
                        <td>${t.note || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function saveTransferSettings() {
            const settings = {
                autoProgress: parseInt(document.getElementById('autoProgress').value) || 100,
                autoErrorMessage: document.getElementById('autoErrorMessage').value || ''
            };
            
            localStorage.setItem('vantex_transfer_settings', JSON.stringify(settings));
            alert('Param√®tres enregistr√©s ! Ils s\'appliqueront aux prochains virements.');
        }

        function loadTransferSettings() {
            const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings'));
            document.getElementById('autoProgress').value = settings.autoProgress;
            document.getElementById('autoErrorMessage').value = settings.autoErrorMessage;
        }

        function exportTransfers() {
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            
            let csv = 'Date,Client,Email,Montant,Devise,B√©n√©ficiaire,IBAN,SWIFT,Banque,Raison,Statut\n';
            transfers.forEach(t => {
                const account = accounts.find(acc => acc.email === t.accountEmail);
                csv += `${formatDate(t.date)},${account ? account.name : ''},${t.accountEmail},${t.amount},${t.currency},"${t.beneficiary}","${t.iban}","${t.swift}","${t.bank}","${t.reason}",${t.status}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `virements_vantex_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function loadTransfersTable() {
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const tbody = document.getElementById('transfersTableBody');
            
            if (transfers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            Aucun virement n'a √©t√© effectu√©
                        </td>
                    </tr>
                `;
                return;
            }
            
            const sorted = transfers.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sorted.map(t => {
                const account = accounts.find(acc => acc.email === t.accountEmail);
                const statusClass = t.status === 'completed' ? 'status-active' : 
                                   t.status === 'processing' ? 'status-badge' :
                                   t.status === 'failed' ? 'status-blocked' : 'status-badge';
                const statusText = t.status === 'completed' ? 'Compl√©t√©' : 
                                  t.status === 'processing' ? `En traitement (${t.progress || 0}%)` :
                                  t.status === 'failed' ? '√âchou√©' : 'En attente';
                
                return `
                    <tr>
                        <td>${formatDate(t.date)}</td>
                        <td>${account ? account.name : t.accountEmail}</td>
                        <td>${formatCurrency(t.amount)} ${t.currency}</td>
                        <td>${t.beneficiary}</td>
                        <td>${t.iban}</td>
                        <td>${t.bank}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-buttons-admin">
                            ${t.status === 'processing' ? `
                                <input type="number" id="progress_${t.id}" min="0" max="100" value="${t.progress || 0}" 
                                    style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;" 
                                    placeholder="%">
                                <button class="btn-small btn-info" onclick="updateProgress(${t.id})">üìä Mettre √† jour</button>
                                <button class="btn-small btn-danger" onclick="failTransfer(${t.id})">‚ùå √âchec</button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateProgress(transferId) {
            const progressInput = document.getElementById(`progress_${transferId}`);
            const newProgress = parseInt(progressInput.value);
            
            if (isNaN(newProgress) || newProgress < 0 || newProgress > 100) {
                alert('La progression doit √™tre entre 0 et 100');
                return;
            }
            
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const transfer = transfers.find(t => t.id === transferId);
            
            if (transfer) {
                transfer.progress = newProgress;
                
                // Si la progression atteint 100% : marquer compl√©t√© + d√©biter le solde maintenant
                if (newProgress === 100) {
                    transfer.status = 'completed';
                    const accts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
                    const acct  = accts.find(a => a.email === transfer.accountEmail);
                    if (acct) {
                        const total = transfer.amount + (transfer.fee || 0);
                        acct.balance -= total;
                        localStorage.setItem('vantex_accounts', JSON.stringify(accts));
                        const note = 'Virement √† ' + transfer.beneficiary + ' (' + (transfer.bank || transfer.operator || '') + ')';
                        addTransaction(transfer.accountEmail, 'debit', transfer.amount, note);
                        if (transfer.fee && transfer.fee > 0) {
                            addTransaction(transfer.accountEmail, 'debit', transfer.fee, 'üí∏ Frais de transaction');
                        }
                    }
                }
                
                localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
                loadTransfersTable();
                alert(`Progression mise √† jour: ${newProgress}%`);
            }
        }

        function failTransfer(transferId) {
            const errorMessage = prompt('Message d\'erreur √† afficher au client:');
            
            if (!errorMessage) {
                alert('Veuillez entrer un message d\'erreur');
                return;
            }
            
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const transfer = transfers.find(t => t.id === transferId);
            
            if (transfer) {
                transfer.status = 'failed';
                transfer.errorMessage = errorMessage;
                localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
                
                // Solde intact ‚Äî le transfer √©chou√© appara√Æt directement dans l'historique via la liste transfers
                
                loadTransfersTable();
                alert('Virement marqu√© comme √©chou√©.');
            }
        }

        function exportTransactions() {
            const transactions = JSON.parse(localStorage.getItem('vantex_transactions'));
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            
            let csv = 'Date,Compte,Email,Type,Montant,Note\n';
            transactions.forEach(t => {
                const account = accounts.find(acc => acc.email === t.accountEmail);
                csv += `${formatDate(t.date)},${account ? account.name : ''},${t.accountEmail},${t.type},${t.amount},"${t.note || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transactions_vantex_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ATTENTION: Cette action supprimera TOUTES les donn√©es (comptes, transactions). Continuer ?')) return;
            if (!confirm('√ätes-vous ABSOLUMENT s√ªr ? Cette action est irr√©versible !')) return;
            
            localStorage.setItem('vantex_accounts', JSON.stringify([]));
            localStorage.setItem('vantex_transactions', JSON.stringify([]));
            
            alert('Toutes les donn√©es ont √©t√© supprim√©es !');
            location.reload();
        }

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR').format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function saveAppSettings() {
            const settings = {
                appName: document.getElementById('appName').value || 'VANTEX',
                defaultCurrency: document.getElementById('defaultCurrency').value.toUpperCase() || 'GNF'
            };
            
            localStorage.setItem('vantex_settings', JSON.stringify(settings));
            showAlert('settingsAlert', 'Param√®tres enregistr√©s avec succ√®s !', 'success');
        }

        function changeAccountCurrency() {
            const accountEmail = document.getElementById('accountCurrencySelect').value;
            const newCurrency = document.getElementById('newCurrencyForAccount').value.trim().toUpperCase();
            
            if (!accountEmail) {
                showAlert('settingsAlert', 'Veuillez s√©lectionner un compte', 'error');
                return;
            }
            
            if (!newCurrency) {
                showAlert('settingsAlert', 'Veuillez entrer une devise', 'error');
                return;
            }
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.email === accountEmail);
            
            if (account) {
                account.currency = newCurrency;
                localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
                showAlert('settingsAlert', `Devise chang√©e avec succ√®s pour ${account.name} ‚Üí ${newCurrency}`, 'success');
                loadAccountsTable();
                loadTransactionsTable();
                
                // Forcer la mise √† jour de currentUser avec la nouvelle devise
                if (currentUser && currentUser.email === accountEmail) {
                    currentUser = account; // mettre √† jour en m√©moire
                    updateClientBalance();
                    if (typeof updateFinanceSummary === 'function') updateFinanceSummary();
                    loadClientTransactions();
                }
            }
        }

        function setQuickCurrencyForAccount(currency) {
            const accountEmail = document.getElementById('accountCurrencySelect').value;
            
            if (!accountEmail) {
                showAlert('settingsAlert', 'Veuillez d\'abord s√©lectionner un compte ci-dessus', 'error');
                return;
            }
            
            document.getElementById('newCurrencyForAccount').value = currency;
            changeAccountCurrency();
        }

        function setQuickSummaryCurrency(currency) {
            const accountEmail = document.getElementById('summaryAccountSelect').value;
            if (!accountEmail) {
                showAlert('settingsAlert', 'Veuillez d\'abord s√©lectionner un compte', 'error');
                return;
            }
            document.getElementById('newSummaryCurrency').value = currency;
            changeSummaryCurrency();
        }

        async function saveSummaryCurrencyFromModal(accountId, accountEmail) {
            const input = document.getElementById('summaryCurrency_' + accountId);
            if (!input) return;
            const newCurrency = input.value.trim().toUpperCase();
            if (!newCurrency) { alert('Veuillez entrer une devise'); return; }

            const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const account = accounts.find(acc => acc.id.toString() === accountId.toString());
            if (!account) return;

            account.summaryCurrency = newCurrency;
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));

            // Sauvegarder sur Firebase
            try {
                await db.collection('accounts').doc(accountId.toString()).update({ summaryCurrency: newCurrency });
                // Feedback visuel sur le bouton
                const btn = input.nextElementSibling;
                if (btn) { btn.textContent = '‚úÖ Sauv√©!'; btn.style.background = '#27ae60'; setTimeout(() => { btn.textContent = 'üíæ Sauver'; btn.style.background = 'linear-gradient(135deg,#0055b3,#0099cc)'; }, 2000); }
            } catch(e) {
                console.error('Firebase summaryCurrency modal:', e);
                alert('Sauvegard√© localement. Erreur Firebase: ' + e.message);
            }

            // Mettre √† jour l'affichage client si connect√©
            if (currentUser && currentUser.email === accountEmail) {
                currentUser = account;
                if (typeof updateFinanceSummary === 'function') updateFinanceSummary();
            }
        }

        function populateSummaryAccountSelect() {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const select = document.getElementById('summaryAccountSelect');
            if (!select) return;
            select.innerHTML = '<option value="">-- Choisir un compte --</option>' +
                accounts.map(acc => `<option value="${acc.email}">${acc.name} (${acc.summaryCurrency || acc.currency || 'GNF'})</option>`).join('');
        }

        function populateAccountCurrencySelect() {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const select = document.getElementById('accountCurrencySelect');
            if (select) {
                select.innerHTML = '<option value="">-- Choisir un compte --</option>' +
                    accounts.map(acc =>
                        `<option value="${acc.email}">${acc.name} - ${acc.email} (${acc.currency || 'GNF'})</option>`
                    ).join('');
            }
        }

        function loadCurrencySettings() {
            const settings = JSON.parse(localStorage.getItem('vantex_settings'));
            const appNameInput = document.getElementById('appName');
            const defaultCurrencyInput = document.getElementById('defaultCurrency');
            
            if (appNameInput) appNameInput.value = settings.appName;
            if (defaultCurrencyInput) defaultCurrencyInput.value = settings.defaultCurrency;
            
            populateAccountCurrencySelect();
            populateSummaryAccountSelect();
        }

        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type === 'error' ? 'error' : 'success'} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        window.balanceVisible = true;
        window.window.realBalanceText = '';

        window.toggleBalance = function() {
            const balanceEl = document.getElementById('clientBalance');
            const eyeOpen   = document.getElementById('eyeOpenIcon');
            const eyeClosed = document.getElementById('eyeClosedIcon');
            if (!balanceEl) return;
            window.balanceVisible = !window.balanceVisible;

            if (window.balanceVisible) {
                balanceEl.style.filter     = 'none';
                balanceEl.style.opacity    = '1';
                balanceEl.style.transition = 'filter 0.3s ease, opacity 0.3s ease';
                if (eyeOpen)   eyeOpen.style.display   = 'block';
                if (eyeClosed) eyeClosed.style.display = 'none';
            } else {
                balanceEl.style.transition = 'filter 0.3s ease, opacity 0.3s ease';
                balanceEl.style.filter     = 'blur(10px)';
                balanceEl.style.opacity    = '0.4';
                if (eyeOpen)   eyeOpen.style.display   = 'none';
                if (eyeClosed) eyeClosed.style.display = 'block';
            }
        };

        // Surcharger updateClientBalance pour maintenir l'√©tat cach√©
        const _origUpdateClientBalance = window.updateClientBalance;
        window.updateClientBalance = function() {
            if (_origUpdateClientBalance) _origUpdateClientBalance();
            const balanceEl = document.getElementById('clientBalance');
            if (balanceEl && !window.balanceVisible) {
                balanceEl.style.filter  = 'blur(10px)';
                balanceEl.style.opacity = '0.5';
            }
        };
        let currentTransferType = null;

        window.selectTransferType = function(type) {
            currentTransferType = type;
            const cardMobile = document.getElementById('typeCardMobile');
            const cardBank   = document.getElementById('typeCardBank');
            const mobileFields = document.getElementById('mobileFields');
            const bankFields   = document.getElementById('bankFields');

            if (type === 'mobile') {
                cardMobile.style.border = '1.5px solid rgba(0,200,255,0.7)';
                cardMobile.style.background = 'rgba(0,80,200,0.2)';
                cardMobile.style.boxShadow = '0 0 14px rgba(0,200,255,0.2)';
                cardBank.style.border = '1.5px solid rgba(255,255,255,0.1)';
                cardBank.style.background = 'rgba(255,255,255,0.05)';
                cardBank.style.boxShadow = 'none';
                mobileFields.style.display = 'block';
                bankFields.style.display = 'none';
            } else {
                cardBank.style.border = '1.5px solid rgba(0,200,255,0.7)';
                cardBank.style.background = 'rgba(0,80,200,0.2)';
                cardBank.style.boxShadow = '0 0 14px rgba(0,200,255,0.2)';
                cardMobile.style.border = '1.5px solid rgba(255,255,255,0.1)';
                cardMobile.style.background = 'rgba(255,255,255,0.05)';
                cardMobile.style.boxShadow = 'none';
                bankFields.style.display = 'block';
                mobileFields.style.display = 'none';
            }
        };

        // R√©initialiser le type quand on ouvre le formulaire
        const _origOpenTransferModal2 = window.openTransferModal;
        window.openTransferModal = function() {
            currentTransferType = null;
            document.getElementById('typeCardMobile').style.border = '1.5px solid rgba(255,255,255,0.1)';
            document.getElementById('typeCardMobile').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('typeCardMobile').style.boxShadow = 'none';
            document.getElementById('typeCardBank').style.border = '1.5px solid rgba(255,255,255,0.1)';
            document.getElementById('typeCardBank').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('typeCardBank').style.boxShadow = 'none';
            document.getElementById('mobileFields').style.display = 'none';
            document.getElementById('bankFields').style.display = 'none';
            if (_origOpenTransferModal2) _origOpenTransferModal2();
        };

        // Overrider la soumission pour valider selon le type choisi
        document.getElementById('transferForm').addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopImmediatePropagation();

            if (!currentTransferType) {
                alert('Veuillez choisir un type de transfert : Mobile ou Bancaire');
                return;
            }

            const amount = parseFloat(document.getElementById('transferAmount').value);
            const beneficiary = document.getElementById('transferBeneficiary').value.trim();
            const reason = document.getElementById('transferReason').value.trim();
            const currency = currentUser ? (currentUser.currency || 'GNF') : 'GNF';

            if (!amount || amount <= 0) { alert('Veuillez entrer un montant valide'); return; }
            if (!beneficiary) { alert('Veuillez entrer le nom du b√©n√©ficiaire'); return; }
            if (!reason) { alert('Veuillez entrer la raison du virement'); return; }

            let iban = '', swift = '', bank = '';

            if (currentTransferType === 'mobile') {
                const operator = document.getElementById('transferOperator').value;
                const mobileNum = document.getElementById('transferMobileNumber').value.trim();
                const mobileCountry = document.getElementById('transferMobileCountry').value;
                if (!operator)     { alert('Veuillez choisir un op√©rateur mobile'); return; }
                if (!mobileNum)    { alert('Veuillez entrer le num√©ro Mobile Money'); return; }
                if (!mobileCountry){ alert('Veuillez choisir le pays'); return; }
                iban  = mobileNum;
                swift = operator;
                bank  = operator + ' ‚Äì ' + mobileCountry;
            } else {
                iban  = document.getElementById('transferIban').value.trim();
                swift = document.getElementById('transferSwift').value.trim();
                bank  = document.getElementById('transferBank').value.trim();
                if (!iban)  { alert('Veuillez entrer l\'IBAN / Num√©ro de compte'); return; }
                if (!swift) { alert('Veuillez entrer le code BIC / SWIFT'); return; }
                if (!bank)  { alert('Veuillez entrer le nom de la banque'); return; }
            }

            const settingsData = JSON.parse(localStorage.getItem('vantex_transfer_settings') || '{}');
            const allAccounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const myAcct = allAccounts.find(a => a.email === currentUser.email);
            const clientFeePercent = (myAcct && myAcct.customFeePercent !== undefined)
                ? myAcct.customFeePercent
                : (settingsData.clientFeePercent !== undefined ? settingsData.clientFeePercent : 2);
            const fee = amount * (clientFeePercent / 100);
            const totalAmount = amount + fee;

            // V√©rifier solde suffisant avant confirmation
            const accts1 = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const acct1 = accts1.find(a => a.email === currentUser.email);
            if (acct1 && acct1.balance < totalAmount) {
                alert('‚ùå Solde insuffisant !\n\nMontant : ' + amount.toLocaleString('fr-FR') + ' ' + currency +
                      '\nFrais : ' + fee.toLocaleString('fr-FR') + ' ' + currency +
                      '\nTotal n√©cessaire : ' + totalAmount.toLocaleString('fr-FR') + ' ' + currency +
                      '\nVotre solde : ' + acct1.balance.toLocaleString('fr-FR') + ' ' + currency);
                return;
            }

            // R√©cup√©rer infos mobile si applicable
            const _operator = currentTransferType === 'mobile' ? (document.getElementById('transferOperator')?.value || '') : '';
            const _mobileNum = currentTransferType === 'mobile' ? (document.getElementById('transferMobileNumber')?.value?.trim() || '') : '';
            const _mobileCountry = currentTransferType === 'mobile' ? (document.getElementById('transferMobileCountry')?.value || '') : '';

            pendingTransferData = {
                amount, fee, totalAmount,
                beneficiary, iban, swift, bank, reason, currency,
                transferType: currentTransferType,
                operator: _operator,
                mobileNumber: _mobileNum,
                mobileCountry: _mobileCountry
            };

            document.getElementById('transferModal').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'none';
            document.getElementById('transferConfirmation').style.display = 'block';

            // Label selon type
            const typeLabel = currentTransferType === 'mobile' ? 'üì± ' + swift : 'üè¶ ' + bank;
            document.getElementById('confirmAmount').textContent = formatCurrency(amount) + ' ' + currency;
            document.getElementById('confirmBeneficiary').textContent = beneficiary;
            document.getElementById('confirmIban').textContent = iban;
            // Adapter les labels selon le type de transfert
            if (currentTransferType === 'mobile') {
                document.getElementById('confirmSwiftLabel').textContent = 'OP√âRATEUR MOBILE';
                document.getElementById('confirmBankLabel').textContent = 'PAYS';
                document.getElementById('confirmSwift').textContent = swift;
                document.getElementById('confirmBank').textContent = bank.replace(/^.*‚Äì\s*/, ''); // juste le pays
            } else {
                document.getElementById('confirmSwiftLabel').textContent = 'CODE SWIFT / BIC';
                document.getElementById('confirmBankLabel').textContent = 'BANQUE';
                document.getElementById('confirmSwift').textContent = swift;
                document.getElementById('confirmBank').textContent = bank;
            }
            document.getElementById('confirmReason').textContent = reason;

            const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            document.getElementById('userAvatarConfirm').textContent = initials;
        }, true);

        // Afficher les frais en temps r√©el c√¥t√© client
        document.getElementById('transferAmount').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            if (amount > 0) {
                const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings') || '{}');
                const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
                const myAccount = accounts.find(a => a.email === currentUser.email);
                // Frais individuel du compte prioritaire sur le frais global
                const feePercent = (myAccount && myAccount.customFeePercent !== undefined) 
                    ? myAccount.customFeePercent 
                    : (settings.clientFeePercent !== undefined ? settings.clientFeePercent : 2);
                const fee = amount * (feePercent / 100);
                const total = amount + fee;
                const currency = currentUser ? currentUser.currency || 'GNF' : 'GNF';
                document.getElementById('clientFeeInfo').style.display = 'block';
                document.getElementById('clientBaseAmount').textContent = formatCurrency(amount) + ' ' + currency;
                document.getElementById('clientFeeAmount').textContent = formatCurrency(fee) + ' ' + currency + ' (' + feePercent + '%)';
                document.getElementById('clientTotalAmount').textContent = formatCurrency(total) + ' ' + currency;
            } else {
                document.getElementById('clientFeeInfo').style.display = 'none';
            }
        });

        // Listener pour le formulaire de virement
        document.getElementById('transferForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const beneficiary = document.getElementById('transferBeneficiary').value.trim();
            const iban = document.getElementById('transferIban').value.trim();
            const swift = document.getElementById('transferSwift').value.trim();
            const bank = document.getElementById('transferBank').value.trim();
            const reason = document.getElementById('transferReason').value.trim();
            const currency = currentUser.currency || 'GNF';

            if (!amount || amount <= 0) {
                alert('Veuillez entrer un montant valide');
                return;
            }

            const settingsData = JSON.parse(localStorage.getItem('vantex_transfer_settings') || '{}');
            const allAccounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const myAcct = allAccounts.find(a => a.email === currentUser.email);
            // Frais individuel prioritaire sur frais global
            const clientFeePercent = (myAcct && myAcct.customFeePercent !== undefined)
                ? myAcct.customFeePercent
                : (settingsData.clientFeePercent !== undefined ? settingsData.clientFeePercent : 2);
            const fee = amount * (clientFeePercent / 100);
            const totalAmount = amount + fee;

            // V√©rifier solde suffisant avant confirmation
            const accts2 = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const acct2 = accts2.find(a => a.email === currentUser.email);
            if (acct2 && acct2.balance < totalAmount) {
                alert('‚ùå Solde insuffisant !\n\nMontant : ' + amount.toLocaleString('fr-FR') + ' ' + currency +
                      '\nFrais : ' + fee.toLocaleString('fr-FR') + ' ' + currency +
                      '\nTotal n√©cessaire : ' + totalAmount.toLocaleString('fr-FR') + ' ' + currency +
                      '\nVotre solde : ' + acct2.balance.toLocaleString('fr-FR') + ' ' + currency);
                return;
            }

            pendingTransferData = {
                amount: amount,
                fee: fee,
                totalAmount: totalAmount,
                beneficiary: beneficiary,
                iban: iban,
                swift: swift,
                bank: bank,
                reason: reason,
                currency: currency
            };

            // Afficher la page de confirmation
            document.getElementById('transferModal').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'none';
            document.getElementById('transferConfirmation').style.display = 'block';

            // Remplir les d√©tails
            document.getElementById('confirmAmount').textContent = formatCurrency(amount) + ' ' + currency;
            document.getElementById('confirmBeneficiary').textContent = beneficiary;
            document.getElementById('confirmIban').textContent = iban;
            // Labels dynamiques selon type de transfert
            if (currentTransferType === 'mobile') {
                document.getElementById('confirmSwiftLabel').textContent = 'OP√âRATEUR MOBILE';
                document.getElementById('confirmBankLabel').textContent = 'PAYS';
                document.getElementById('confirmSwift').textContent = swift;
                document.getElementById('confirmBank').textContent = bank.replace(/^.*‚Äì\s*/, '');
            } else {
                document.getElementById('confirmSwiftLabel').textContent = 'CODE SWIFT / BIC';
                document.getElementById('confirmBankLabel').textContent = 'BANQUE';
                document.getElementById('confirmSwift').textContent = swift;
                document.getElementById('confirmBank').textContent = bank;
            }
            document.getElementById('confirmReason').textContent = reason;

            // Avatar
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            document.getElementById('userAvatarConfirm').textContent = initials;
        });

        window.showIban = function showIban() {
            const user = window.currentUser;
            if (!user) return;
            const accountNum = String(user.id || '0');
            const accountType = user.accountType || 'Compte courant';
            const currency = user.currency || 'GNF';
            const country = user.country || '‚Äî';
            // G√©n√©rer un IBAN fictif bas√© sur l'ID du compte
            const ibanRaw = ('GN' + '00' + accountNum.padStart(20, '0')).substring(0, 24);
            const ibanFormatted = ibanRaw.match(/.{1,4}/g).join(' ');
            const bic = 'VNTX' + country.substring(0,2).toUpperCase() + 'XX';

            // Supprimer ancienne modal si existante
            const existing = document.getElementById('vx-iban-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'vx-iban-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(2,6,18,0.88);z-index:99999;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(8px);animation:fadeIn 0.2s ease;';
            modal.innerHTML = `
            <div style="width:100%;max-width:480px;background:linear-gradient(145deg,#0c1535,#080f25);border-radius:26px 26px 0 0;border:1px solid rgba(100,160,255,0.2);border-bottom:none;overflow:hidden;box-shadow:0 -10px 60px rgba(0,20,80,0.7);animation:slideUpProfile 0.3s cubic-bezier(0.34,1.2,0.64,1);">

                <!-- Header -->
                <div style="display:flex;align-items:center;justify-content:space-between;padding:22px 20px 14px;">
                    <div>
                        <h2 style="color:white;font-size:19px;font-weight:800;margin:0 0 3px;">Coordonn√©es bancaires</h2>
                        <p style="color:rgba(255,255,255,0.4);font-size:12px;margin:0;">Partagez vos infos pour recevoir un virement</p>
                    </div>
                    <button onclick="document.getElementById('vx-iban-modal').remove()" style="width:34px;height:34px;background:rgba(255,255,255,0.07);border:1px solid rgba(100,160,255,0.2);border-radius:50%;color:rgba(255,255,255,0.6);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
                </div>

                <!-- S√©parateur -->
                <div style="height:1px;background:rgba(100,160,255,0.1);margin:0 20px;"></div>

                <!-- Carte IBAN stylis√©e -->
                <div style="margin:18px 20px;background:linear-gradient(135deg,#0d1b3e 0%,#0a2a6e 50%,#0d1b3e 100%);border-radius:18px;padding:20px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.08);">
                    <div style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:30px 30px;border-radius:18px;pointer-events:none;"></div>
                    <div style="position:relative;z-index:1;">
                        <p style="color:rgba(255,255,255,0.45);font-size:10px;letter-spacing:2px;text-transform:uppercase;margin:0 0 6px;">Titulaire</p>
                        <p style="color:white;font-size:16px;font-weight:800;margin:0 0 16px;letter-spacing:0.5px;">${user.name.toUpperCase()}</p>
                        <p style="color:rgba(255,255,255,0.45);font-size:10px;letter-spacing:2px;text-transform:uppercase;margin:0 0 6px;">Num√©ro de compte</p>
                        <p style="color:white;font-size:18px;font-weight:700;font-family:monospace;letter-spacing:3px;margin:0 0 16px;">${ibanFormatted}</p>
                        <div style="display:flex;gap:24px;">
                            <div>
                                <p style="color:rgba(255,255,255,0.45);font-size:10px;letter-spacing:2px;text-transform:uppercase;margin:0 0 4px;">Type</p>
                                <p style="color:white;font-size:13px;font-weight:700;margin:0;">${accountType}</p>
                            </div>
                            <div>
                                <p style="color:rgba(255,255,255,0.45);font-size:10px;letter-spacing:2px;text-transform:uppercase;margin:0 0 4px;">Devise</p>
                                <p style="color:#00e5a0;font-size:13px;font-weight:700;margin:0;">${currency}</p>
                            </div>
                            <div>
                                <p style="color:rgba(255,255,255,0.45);font-size:10px;letter-spacing:2px;text-transform:uppercase;margin:0 0 4px;">BIC</p>
                                <p style="color:white;font-size:13px;font-weight:700;margin:0;">${bic}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ligne IBAN copiable -->
                <div style="margin:0 20px 14px;background:rgba(255,255,255,0.05);border:1px solid rgba(100,160,255,0.15);border-radius:14px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;">
                    <div style="overflow:hidden;">
                        <p style="color:rgba(255,255,255,0.4);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;margin:0 0 4px;">IBAN complet</p>
                        <p style="color:white;font-size:13px;font-weight:600;font-family:monospace;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${ibanFormatted}</p>
                    </div>
                    <button id="copyIbanBtn" onclick="
                        navigator.clipboard.writeText('${ibanRaw}').catch(()=>{});
                        this.innerHTML='‚úÖ';
                        this.style.background='linear-gradient(135deg,#27ae60,#2ecc71)';
                        setTimeout(()=>{this.innerHTML='üìã';this.style.background='linear-gradient(135deg,#1a3abf,#2550e8)';},2000);"
                        style="flex-shrink:0;width:38px;height:38px;background:linear-gradient(135deg,#1a3abf,#2550e8);border:none;border-radius:10px;color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,60,220,0.4);">üìã</button>
                </div>

                <!-- Avertissement -->
                <div style="margin:0 20px 20px;background:rgba(0,180,100,0.06);border:1px solid rgba(0,200,100,0.2);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:10px;">
                    <span style="font-size:18px;">üîí</span>
                    <span style="color:rgba(255,255,255,0.55);font-size:12px;line-height:1.5;">Ne partagez ces informations qu'avec des personnes de confiance.</span>
                </div>

                <!-- Bouton fermer -->
                <div style="padding:0 20px 28px;">
                    <button onclick="document.getElementById('vx-iban-modal').remove()" style="width:100%;padding:16px;background:linear-gradient(135deg,#1a3abf,#2550e8);color:white;border:none;border-radius:16px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(0,60,220,0.4);">Fermer</button>
                </div>
            </div>`;

            modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
            document.body.appendChild(modal);
        }

        function openTransferModal() {
            document.getElementById('transferModal').style.display = 'block';
            // Mettre √† jour le solde dans le header du modal
            if (window.currentUser) {
                const currency = window.currentUser.currency || 'GNF';
                const balance = window.currentUser.balance || 0;
                const hb = document.getElementById('headerBalance');
                if (hb) hb.textContent = balance.toLocaleString('fr-FR') + ' ' + currency;
            }
            document.getElementById('clientInterface').style.display = 'none';
            // Mettre √† jour le solde affich√©
            if (currentUser) {
                const currency = currentUser.currency || 'GNF';
                const balanceEl = document.getElementById('transferAvailableBalance');
                if (balanceEl) balanceEl.textContent = formatCurrency(currentUser.balance) + ' ' + currency;
                const currencyEl = document.getElementById('transferCurrency');
                if (currencyEl) currencyEl.value = currency;
            }
        }

        function closeTransferPage() {
            document.getElementById('transferModal').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'block';
            document.getElementById('transferForm').reset();
        }

        function showTransferConfirmation() {
            // Masquer la page de virement
            document.getElementById('transferModal').style.display = 'none';
            
            // Masquer l'interface client normale
            document.getElementById('clientInterface').style.display = 'none';
            
            // Afficher la page de confirmation
            document.getElementById('transferConfirmation').style.display = 'block';
            
            // Remplir les d√©tails
            const currency = pendingTransferData.currency;
            document.getElementById('confirmAmount').textContent = 
                formatCurrency(pendingTransferData.amount) + ' ' + currency;
            document.getElementById('confirmBeneficiary').textContent = pendingTransferData.beneficiary;
            document.getElementById('confirmIban').textContent = pendingTransferData.iban;
            // Labels dynamiques selon type de transfert
            if (pendingTransferData.transferType === 'mobile') {
                document.getElementById('confirmSwiftLabel').textContent = 'OP√âRATEUR MOBILE';
                document.getElementById('confirmBankLabel').textContent = 'PAYS';
                document.getElementById('confirmSwift').textContent = pendingTransferData.swift;
                document.getElementById('confirmBank').textContent = (pendingTransferData.bank || '').replace(/^.*‚Äì\s*/, '');
            } else {
                document.getElementById('confirmSwiftLabel').textContent = 'CODE SWIFT / BIC';
                document.getElementById('confirmBankLabel').textContent = 'BANQUE';
                document.getElementById('confirmSwift').textContent = pendingTransferData.swift;
                document.getElementById('confirmBank').textContent = pendingTransferData.bank;
            }
            document.getElementById('confirmReason').textContent = pendingTransferData.reason;
            
            // Mettre √† jour l'avatar
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            document.getElementById('userAvatarConfirm').textContent = initials;
        }

        // ============================================================
        // S√âLECTEUR OP√âRATEUR & PAYS ‚Äî Modal style image, couleurs formulaire
        // ============================================================
        const _operators = [
            { value: 'Orange Money',  label: 'Orange Money',  dot: '#FF6600' },
            { value: 'Wave',          label: 'Wave',           dot: '#1ABCFE' },
            { value: 'MTN MoMo',     label: 'MTN MoMo',      dot: '#FFCB00' },
            { value: 'Moov Money',   label: 'Moov Money',    dot: '#00B050' },
            { value: 'Free Money',   label: 'Free Money',    dot: '#CD0037' },
            { value: 'Airtel Money', label: 'Airtel Money',  dot: '#E40000' },
        ];

        const _countries = [
            { value: "C√¥te d'Ivoire", flag: 'üá®üáÆ' },
            { value: 'S√©n√©gal',       flag: 'üá∏üá≥' },
            { value: 'Mali',          flag: 'üá≤üá±' },
            { value: 'Guin√©e',        flag: 'üá¨üá≥' },
            { value: 'Cameroun',      flag: 'üá®üá≤' },
            { value: 'Burkina Faso',  flag: 'üáßüá´' },
            { value: 'Togo',          flag: 'üáπüá¨' },
            { value: 'B√©nin',         flag: 'üáßüáØ' },
            { value: 'Niger',         flag: 'üá≥üá™' },
            { value: 'Congo',         flag: 'üá®üá¨' },
            { value: 'Gabon',         flag: 'üá¨üá¶' },
            { value: 'Madagascar',    flag: 'üá≤üá¨' },
            { value: 'Maroc',         flag: 'üá≤üá¶' },
            { value: 'Guin√©e-Bissau', flag: 'üá¨üáº' },
            { value: 'Sierra Leone',  flag: 'üá∏üá±' },
            { value: 'Ghana',         flag: 'üá¨üá≠' },
            { value: 'Nigeria',       flag: 'üá≥üá¨' },
            { value: 'France',        flag: 'üá´üá∑' },
        ];

        // Couleurs du formulaire (fond sombre bleu nuit)
        const MODAL_BG    = 'linear-gradient(180deg,#080f25 0%,#0b1535 100%)';
        const MODAL_ITEM  = 'rgba(255,255,255,0.03)';
        const MODAL_HOVER = 'rgba(100,160,255,0.1)';
        const MODAL_SEP   = 'rgba(100,160,255,0.1)';
        const RADIO_EMPTY = 'rgba(100,160,255,0.35)';
        const RADIO_FILL  = '#3b82f6';

        window.showOperatorModal = function() {
            const existing = document.getElementById('vx-op-modal');
            if (existing) existing.remove();
            const currentVal = document.getElementById('transferOperator')?.value || '';

            const rows = _operators.map(op => {
                const sel = op.value === currentVal;
                const radio = sel
                    ? `<div style="width:22px;height:22px;border-radius:50%;border:2px solid ${RADIO_FILL};background:${RADIO_FILL};display:flex;align-items:center;justify-content:center;flex-shrink:0;"><div style="width:8px;height:8px;border-radius:50%;background:white;"></div></div>`
                    : `<div style="width:22px;height:22px;border-radius:50%;border:2px solid ${RADIO_EMPTY};flex-shrink:0;"></div>`;
                return `<div onclick="window._selectOp('${op.value}')"
                    style="display:flex;align-items:center;gap:12px;padding:11px 16px;border-bottom:1px solid ${MODAL_SEP};cursor:pointer;background:${sel ? 'rgba(100,160,255,0.06)' : 'transparent'};transition:background 0.15s;"
                    onmouseover="this.style.background='${MODAL_HOVER}'" onmouseout="this.style.background='${sel ? 'rgba(100,160,255,0.06)' : 'transparent'}'">
                    <div style="width:32px;height:32px;border-radius:50%;background:${op.dot};flex-shrink:0;box-shadow:0 3px 8px ${op.dot}55;"></div>
                    <span style="color:white;font-size:14px;font-weight:600;flex:1;">${op.label}</span>
                    ${radio}
                </div>`;
            }).join('');

            const overlay = document.createElement('div');
            overlay.id = 'vx-op-modal';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(2,6,18,0.88);z-index:99999;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(8px);animation:fadeIn 0.2s ease;';
            overlay.innerHTML = `
            <div style="width:100%;max-width:480px;background:${MODAL_BG};border-radius:26px 26px 0 0;border:1px solid rgba(100,160,255,0.2);border-bottom:none;overflow:hidden;max-height:88vh;display:flex;flex-direction:column;box-shadow:0 -10px 60px rgba(0,20,80,0.7);">
                <!-- En-t√™te -->
                <div style="display:flex;align-items:center;justify-content:space-between;padding:20px 20px 16px;">
                    <h2 style="color:white;font-size:20px;font-weight:800;margin:0;">Choisir op√©rateur</h2>
                    <button onclick="window._closeOpModal()" style="width:34px;height:34px;background:rgba(255,255,255,0.07);border:1px solid rgba(100,160,255,0.2);border-radius:50%;color:rgba(255,255,255,0.6);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;">‚úï</button>
                </div>
                <!-- S√©parateur -->
                <div style="height:1px;background:${MODAL_SEP};"></div>
                <!-- Liste -->
                <div style="overflow-y:auto;flex:1;">${rows}</div>
            </div>`;
            overlay.addEventListener('click', e => { if (e.target === overlay) window._closeOpModal(); });
            document.body.appendChild(overlay);
        };

        window._selectOp = function(value) {
            const op = _operators.find(o => o.value === value);
            if (!op) return;
            document.getElementById('transferOperator').value = op.value;
            const logoEl = document.getElementById('opLogoDisplay');
            const labelEl = document.getElementById('opLabelDisplay');
            if (logoEl) logoEl.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:${op.dot};box-shadow:0 2px 10px ${op.dot}66;"></div>`;
            if (labelEl) { labelEl.textContent = op.label; labelEl.style.color = 'white'; }
            window._closeOpModal();
        };
        window._closeOpModal = function() {
            const m = document.getElementById('vx-op-modal');
            if (m) { m.style.opacity = '0'; m.style.transition = 'opacity 0.15s'; setTimeout(() => m.remove(), 150); }
        };

        window.showCountryModal = function() {
            const existing = document.getElementById('vx-ct-modal');
            if (existing) existing.remove();
            const currentVal = document.getElementById('transferMobileCountry')?.value || '';

            const rows = _countries.map(ct => {
                const sel = ct.value === currentVal;
                const radio = sel
                    ? `<div style="width:22px;height:22px;border-radius:50%;border:2px solid ${RADIO_FILL};background:${RADIO_FILL};display:flex;align-items:center;justify-content:center;flex-shrink:0;"><div style="width:8px;height:8px;border-radius:50%;background:white;"></div></div>`
                    : `<div style="width:22px;height:22px;border-radius:50%;border:2px solid ${RADIO_EMPTY};flex-shrink:0;"></div>`;
                const esc = ct.value.replace(/'/g, "\\'");
                return `<div onclick="window._selectCt('${esc}')"
                    style="display:flex;align-items:center;gap:16px;padding:16px 20px;border-bottom:1px solid ${MODAL_SEP};cursor:pointer;background:${sel ? 'rgba(100,160,255,0.06)' : 'transparent'};transition:background 0.15s;"
                    onmouseover="this.style.background='${MODAL_HOVER}'" onmouseout="this.style.background='${sel ? 'rgba(100,160,255,0.06)' : 'transparent'}'">
                    <span style="font-size:30px;flex-shrink:0;line-height:1;">${ct.flag}</span>
                    <span style="color:white;font-size:16px;font-weight:600;flex:1;">${ct.value}</span>
                    ${radio}
                </div>`;
            }).join('');

            const overlay = document.createElement('div');
            overlay.id = 'vx-ct-modal';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(2,6,18,0.88);z-index:99999;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(8px);animation:fadeIn 0.2s ease;';
            overlay.innerHTML = `
            <div style="width:100%;max-width:480px;background:${MODAL_BG};border-radius:26px 26px 0 0;border:1px solid rgba(100,160,255,0.2);border-bottom:none;overflow:hidden;max-height:88vh;display:flex;flex-direction:column;box-shadow:0 -10px 60px rgba(0,20,80,0.7);">
                <div style="display:flex;align-items:center;justify-content:space-between;padding:20px 20px 16px;">
                    <h2 style="color:white;font-size:20px;font-weight:800;margin:0;">Choisir un pays</h2>
                    <button onclick="window._closeCtModal()" style="width:34px;height:34px;background:rgba(255,255,255,0.07);border:1px solid rgba(100,160,255,0.2);border-radius:50%;color:rgba(255,255,255,0.6);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;">‚úï</button>
                </div>
                <div style="height:1px;background:${MODAL_SEP};"></div>
                <div style="overflow-y:auto;flex:1;">${rows}</div>
            </div>`;
            overlay.addEventListener('click', e => { if (e.target === overlay) window._closeCtModal(); });
            document.body.appendChild(overlay);
        };

        window._selectCt = function(value) {
            const ct = _countries.find(c => c.value === value);
            if (!ct) return;
            document.getElementById('transferMobileCountry').value = ct.value;
            const flagEl = document.getElementById('ctFlagDisplay');
            const labelEl = document.getElementById('ctLabelDisplay');
            if (flagEl) flagEl.textContent = ct.flag;
            if (labelEl) { labelEl.textContent = ct.value; labelEl.style.color = 'white'; }
            window._closeCtModal();
        };
        window._closeCtModal = function() {
            const m = document.getElementById('vx-ct-modal');
            if (m) { m.style.opacity = '0'; m.style.transition = 'opacity 0.15s'; setTimeout(() => m.remove(), 150); }
        };

        // Aliases pour compatibilit√©
        function buildDropdowns() {}
        function toggleDropdown(type) {
            if (type === 'operator') window.showOperatorModal();
            else window.showCountryModal();
        }

        function cancelTransferProcess() {
            showConfirmModal(
                '‚ö†Ô∏è Annuler le virement',
                '√ätes-vous s√ªr de vouloir annuler ce virement en cours ?',
                function() {
                    pendingTransferData = null;
                    document.getElementById('activationCode').value = '';
                    for(let i=0;i<4;i++){const b=document.getElementById('otp'+i);if(b){b.textContent='';b.style.border='1.5px solid rgba(100,160,255,0.3)';b.style.background='rgba(255,255,255,0.06)';b.style.boxShadow='none';}}
                    backToClientDashboard();
                }
            );
        }

        // Mise √† jour visuelle des cases OTP
        function updateOtpDisplay(val) {
            for(let i=0;i<4;i++){
                const box = document.getElementById('otp'+i);
                if(!box) continue;
                if(i < val.length){
                    box.textContent = '‚Ä¢';
                    box.style.border = '1.5px solid rgba(0,180,255,0.7)';
                    box.style.background = 'rgba(0,80,200,0.2)';
                    box.style.boxShadow = '0 0 8px rgba(0,180,255,0.3)';
                } else {
                    box.textContent = '';
                    box.style.border = '1.5px solid rgba(100,160,255,0.3)';
                    box.style.background = 'rgba(255,255,255,0.06)';
                    box.style.boxShadow = 'none';
                }
            }
            // Surligner la case active
            if(val.length < 4){
                const active = document.getElementById('otp'+val.length);
                if(active){
                    active.style.border = '1.5px solid rgba(0,220,255,0.9)';
                    active.style.boxShadow = '0 0 12px rgba(0,220,255,0.4)';
                }
            }
        }

        function backToClientDashboard() {
            document.getElementById('transferConfirmation').style.display = 'none';
            document.getElementById('transferProcessing').style.display = 'none';
            document.getElementById('transferModal').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'block';
            document.getElementById('transferForm').reset();
            pendingTransferData = null;
        }

        function processTransfer() {
            const activationCode = document.getElementById('activationCode').value.trim();
            
            if (!activationCode) {
                alert('Veuillez entrer le code d\'activation');
                return;
            }
            
            // V√©rifier que le code correspond au code unique du compte
            const allAccts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const userAcct = allAccts.find(acc => acc.email === currentUser.email);
            if (!userAcct || userAcct.activationCode !== activationCode) {
                alert('‚ùå Code d\'activation incorrect. Veuillez contacter l\'administrateur.');
                return;
            }

            // ‚úÖ Marquer le code comme utilis√© (OUI dans la popup admin)
            const allAcctsToMark = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const accIdxToMark = allAcctsToMark.findIndex(a => a.email === currentUser.email);
            if (accIdxToMark !== -1) {
                allAcctsToMark[accIdxToMark].activationUsed = true;
                localStorage.setItem('vantex_accounts', JSON.stringify(allAcctsToMark));
                // Sync Firebase
                if (typeof saveToFirebase === 'function') {
                    saveToFirebase('accounts', allAcctsToMark[accIdxToMark]);
                }
            }

            // V√©rifier solde suffisant (montant + frais)
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.email === currentUser.email);
            const totalToDebit = pendingTransferData.totalAmount || (pendingTransferData.amount + (pendingTransferData.fee || 0));
            
            if (account.balance < totalToDebit) {
                const currency = pendingTransferData.currency || '';
                alert('‚ùå Solde insuffisant !\n\nMontant : ' + (pendingTransferData.amount || 0).toLocaleString('fr-FR') + ' ' + currency +
                      '\nFrais : ' + (pendingTransferData.fee || 0).toLocaleString('fr-FR') + ' ' + currency +
                      '\nTotal n√©cessaire : ' + totalToDebit.toLocaleString('fr-FR') + ' ' + currency +
                      '\nVotre solde : ' + account.balance.toLocaleString('fr-FR') + ' ' + currency);
                return;
            }
            
            // ‚ö†Ô∏è Le solde n'est PAS d√©bit√© imm√©diatement.
            // Il sera d√©bit√© uniquement si le virement est compl√©t√© avec succ√®s.
            // Si √©chec ‚Üí solde intact, on √©crit juste "√âchec" dans l'historique.
            
            // Enregistrer les d√©tails du virement avec code d'activation
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const transferId = Date.now();
            transfers.push({
                id: transferId,
                accountEmail: currentUser.email,
                amount: pendingTransferData.amount,
                fee: pendingTransferData.fee || 0,
                currency: pendingTransferData.currency,
                beneficiary: pendingTransferData.beneficiary,
                iban: pendingTransferData.iban,
                swift: pendingTransferData.swift,
                bank: pendingTransferData.bank,
                reason: pendingTransferData.reason,
                transferType: pendingTransferData.transferType || 'bank',
                operator: pendingTransferData.operator || '',
                mobileNumber: pendingTransferData.mobileNumber || '',
                mobileCountry: pendingTransferData.mobileCountry || '',
                activationCode: activationCode,
                date: new Date().toISOString(),
                status: 'processing',
                progress: 0,
                errorMessage: null
            });
            localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
            
            // Passer √† l'√©cran de traitement
            document.getElementById('transferConfirmation').style.display = 'none';
            document.getElementById('transferProcessing').style.display = 'block';
            
            // Remplir les d√©tails sur la page de traitement
            const currency = pendingTransferData.currency;
            document.getElementById('processingAmount').textContent = 
                formatCurrency(pendingTransferData.amount) + ' ' + currency;
            document.getElementById('processingBeneficiary').textContent = pendingTransferData.beneficiary;
            document.getElementById('processingIban').textContent = pendingTransferData.iban || pendingTransferData.mobileNumber || '‚Äî';
            document.getElementById('processingBank').textContent = pendingTransferData.bank;
            // R√©f√©rence unique TRX
            const trxRef = 'TRX-' + String(transferId).slice(-6);
            if (document.getElementById('processingRef')) document.getElementById('processingRef').textContent = 'R√©f√©rence : ' + trxRef;
            if (document.getElementById('processingStatusText')) document.getElementById('processingStatusText').textContent = 'En cours de traitement...';
            
            // D√©marrer la surveillance de la progression
            startProgressMonitoring(transferId);
        }

        let progressInterval = null;
        
        function startProgressMonitoring(transferId) {
            // R√©initialiser l'affichage
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            
            // R√©cup√©rer les param√®tres du compte sp√©cifique
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const transfer = transfers.find(t => t.id === transferId);
            
            if (!transfer) return;
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.email === transfer.accountEmail);
            
            const targetProgress = account.autoProgress !== undefined ? account.autoProgress : 100;
            const errorMessage = account.autoErrorMessage || 'Une erreur est survenue';
            
            let currentProgress = 0;
            
            // Incr√©menter progressivement de 1% toutes les 2-3 secondes
            const progressTimer = setInterval(() => {
                if (currentProgress < targetProgress) {
                    currentProgress++;
                    transfer.progress = currentProgress;
                    localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
                } else {
                    clearInterval(progressTimer);
                    
                    // Marquer comme compl√©t√© ou √©chou√©
                    if (targetProgress === 100) {
                        transfer.status = 'completed';
                        // D√©biter le solde maintenant que le virement est r√©ussi
                        const accts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
                        const acct  = accts.find(a => a.email === transfer.accountEmail);
                        if (acct) {
                            const total = transfer.amount + (transfer.fee || 0);
                            acct.balance -= total;
                            localStorage.setItem('vantex_accounts', JSON.stringify(accts));
                            const note = 'Virement √† ' + transfer.beneficiary + ' (' + (transfer.bank || transfer.operator || '') + ')';
                            addTransaction(transfer.accountEmail, 'debit', transfer.amount, note);
                            if (transfer.fee && transfer.fee > 0) {
                                addTransaction(transfer.accountEmail, 'debit', transfer.fee, 'üí∏ Frais de transaction');
                            }
                        }
                    } else {
                        transfer.status = 'failed';
                        transfer.errorMessage = errorMessage;
                        // Solde intact ‚Äî le transfer √©chou√© appara√Æt directement dans l'historique via la liste transfers
                    }
                    
                    localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
                }
            }, 2500); // 2.5 secondes entre chaque pourcentage
            
            // V√©rifier et afficher la progression toutes les 500ms
            progressInterval = setInterval(() => {
                const updatedTransfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
                const updatedTransfer = updatedTransfers.find(t => t.id === transferId);
                
                if (updatedTransfer) {
                    const progress = updatedTransfer.progress || 0;
                    
                    // Mettre √† jour la barre de progression
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressText').textContent = progress + '%';
                    
                    // V√©rifier si le virement est termin√©
                    if (updatedTransfer.status === 'completed' && progress === 100) {
                        clearInterval(progressInterval);
                        clearInterval(progressTimer);
                        document.getElementById('successMessage').style.display = 'block';
                    } else if (updatedTransfer.status === 'failed') {
                        clearInterval(progressInterval);
                        clearInterval(progressTimer);
                        const errMsg = updatedTransfer.errorMessage || 'Une erreur est survenue lors du traitement';
                        // Bloc bas de page
                        document.getElementById('errorMessage').style.display = 'block';
                        document.getElementById('errorText').textContent = errMsg;
                        // Toast flottant au centre
                        document.getElementById('errorToastText').textContent = errMsg;
                        document.getElementById('errorToastRef').textContent = 'R√©f√©rence : ' + (document.getElementById('processingRef').textContent || '‚Äî');
                        document.getElementById('errorToast').style.display = 'block';
                    }
                }
            }, 500);
        }

        function showVirtualCard() {
            alert('Fonctionnalit√© Carte Virtuelle √† venir');
        }

        // Initialize
        if (localStorage.getItem('vantex_accounts') === '[]') {
            // Create demo account
            const demoAccount = {
                id: Date.now(),
                lastName: 'KARAMO',
                firstName: 'FOFANA',
                name: 'FOFANA KARAMO',
                email: 'demo@vantex.com',
                phone: '+224 123 456 789',
                country: 'Guin√©e',
                password: 'demo123',
                balance: 0,
                currency: 'GNF',
                autoProgress: 100,
                autoErrorMessage: '',
                status: 'active',
                createdAt: new Date().toISOString()
            };
            localStorage.setItem('vantex_accounts', JSON.stringify([demoAccount]));
        } else {
            // Ajouter les nouveaux champs aux comptes existants
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            let updated = false;
            accounts.forEach(acc => {
                if (!acc.currency) {
                    acc.currency = 'GNF';
                    updated = true;
                }
                if (acc.autoProgress === undefined) {
                    acc.autoProgress = 100;
                    updated = true;
                }
                if (!acc.autoErrorMessage) {
                    acc.autoErrorMessage = '';
                    updated = true;
                }
                if (!acc.country) {
                    acc.country = '';
                    updated = true;
                }
                if (!acc.firstName && acc.name) {
                    const nameParts = acc.name.split(' ');
                    acc.firstName = nameParts[0] || '';
                    acc.lastName = nameParts.slice(1).join(' ') || '';
                    updated = true;
                }
            });
            if (updated) {
                localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            }
        }
   script>
// ============================================
// MODULE FRAIS DE TRANSACTION - VANTEX
// ============================================
(function() {
    // Initialiser les frais dans les settings
    const existingSettings = JSON.parse(localStorage.getItem('vantex_transfer_settings') || '{}');
    if (!existingSettings.transactionFeePercent) {
        existingSettings.transactionFeePercent = 2;
        localStorage.setItem('vantex_transfer_settings', JSON.stringify(existingSettings));
    }
})();

// OVERRIDE saveTransferSettings
window.saveTransferSettings = function() {
    const settings = {
        autoProgress: parseInt(document.getElementById('autoProgress').value) || 100,
        autoErrorMessage: document.getElementById('autoErrorMessage').value || '',
        transactionFeePercent: parseFloat(document.getElementById('transactionFeePercent')?.value) || 0,
        clientFeePercent: parseFloat(document.getElementById('clientFeePercent')?.value) || 0
    };
    
    localStorage.setItem('vantex_transfer_settings', JSON.stringify(settings));
    alert('‚úÖ Param√®tres enregistr√©s !\n\nFrais de transaction : ' + settings.transactionFeePercent + '%\nCes param√®tres s\'appliqueront aux prochains virements.');
};

// OVERRIDE loadTransferSettings
const originalLoadTransferSettings = window.loadTransferSettings;
window.loadTransferSettings = function() {
    if (originalLoadTransferSettings) originalLoadTransferSettings();
    const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings') || '{}');
    const feeInput = document.getElementById('transactionFeePercent');
    if (feeInput) feeInput.value = settings.transactionFeePercent || 2;
    const clientFeeInput = document.getElementById('clientFeePercent');
    if (clientFeeInput) clientFeeInput.value = settings.clientFeePercent !== undefined ? settings.clientFeePercent : 2;
};

// OVERRIDE openTransferModal
const originalOpenTransferModal = window.openTransferModal;
window.openTransferModal = function() {
    if (originalOpenTransferModal) originalOpenTransferModal();
    // Fermer si ouvert comme modal classique
    const modal = document.getElementById('transferModal');
    if (modal) { modal.style.display = 'block'; }
    const ci = document.getElementById('clientInterface');
    if (ci) { ci.style.display = 'none'; }
    
    setTimeout(function() {
        const amountInput = document.getElementById('transferAmount');
        if (amountInput) {
            const newInput = amountInput.cloneNode(true);
            amountInput.parentNode.replaceChild(newInput, amountInput);
            
            newInput.addEventListener('input', function() {
                const amount = parseFloat(this.value) || 0;
                
                if (amount > 0 && window.currentUser) {
                    const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings'));
                    const feePercent = settings.transactionFeePercent || 0;
                    const feeAmount = (amount * feePercent) / 100;
                    const totalAmount = amount + feeAmount;
                    const currency = window.currentUser.currency || 'GNF';
                    
                    let feeCalc = document.getElementById('feeCalculation');
                    if (!feeCalc) {
                        const balanceDiv = document.getElementById('transferAvailableBalance')?.parentElement;
                        if (balanceDiv) {
                            feeCalc = document.createElement('div');
                            feeCalc.id = 'feeCalculation';
                            feeCalc.style.cssText = 'display: none; padding-top: 12px; border-top: 1px solid #d0e8ff; margin-top: 12px;';
                            feeCalc.innerHTML = `
                                <p style="margin: 4px 0; color: #666; font-size: 13px;">
                                    <strong>Montant du virement:</strong> <span id="transferBaseAmount">0.00</span>
                                </p>
                                <p style="margin: 4px 0; color: #666; font-size: 13px;">
                                    <strong>Frais (<span id="feePercentDisplay">0</span>%):</strong> <span id="transferFeeAmount">0.00</span>
                                </p>
                                <p style="margin: 8px 0 4px 0; color: var(--primary-blue); font-size: 15px; font-weight: 700;">
                                    <strong>üí∞ TOTAL √Ä D√âBITER:</strong> <span id="transferTotalAmount">0.00</span>
                                </p>
                            `;
                            balanceDiv.appendChild(feeCalc);
                        }
                    }
                    
                    if (feeCalc) {
                        feeCalc.style.display = 'block';
                        document.getElementById('feePercentDisplay').textContent = feePercent;
                        document.getElementById('transferBaseAmount').textContent = window.formatCurrency(amount) + ' ' + currency;
                        document.getElementById('transferFeeAmount').textContent = window.formatCurrency(feeAmount) + ' ' + currency;
                        document.getElementById('transferTotalAmount').textContent = window.formatCurrency(totalAmount) + ' ' + currency;
                    }
                } else {
                    const feeCalc = document.getElementById('feeCalculation');
                    if (feeCalc) feeCalc.style.display = 'none';
                }
            });
        }
    }, 200);
};

// OVERRIDE showTransferConfirmation
const originalShowTransferConfirmation = window.showTransferConfirmation;
window.showTransferConfirmation = function() {
    if (originalShowTransferConfirmation) originalShowTransferConfirmation();
    
    if (window.pendingTransferData) {
        const currency = window.pendingTransferData.currency;
        const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings'));
        const feePercent = settings.transactionFeePercent || 0;
        const feeAmount = (window.pendingTransferData.amount * feePercent) / 100;
        const totalAmount = window.pendingTransferData.amount + feeAmount;
        
        let amountDisplay = window.formatCurrency(window.pendingTransferData.amount) + ' ' + currency;
        if (feeAmount > 0) {
            amountDisplay += '<br><small style="color: #666; font-size: 14px;">+ Frais (' + feePercent + '%) : ' + 
                             window.formatCurrency(feeAmount) + ' ' + currency + '</small>' +
                             '<br><strong style="color: var(--primary-blue); font-size: 22px;">Total : ' + 
                             window.formatCurrency(totalAmount) + ' ' + currency + '</strong>';
        }
        
        const confirmAmountEl = document.getElementById('confirmAmount');
        if (confirmAmountEl) {
            confirmAmountEl.innerHTML = amountDisplay;
        }
    }
};

// OVERRIDE processTransfer
const originalProcessTransfer = window.processTransfer;
window.processTransfer = function() {
    const activationCode = document.getElementById('activationCode').value.trim();
    
    if (!activationCode) {
        alert('Veuillez entrer le code d\'activation');
        return;
    }
    
    if (!window.pendingTransferData || !window.currentUser) {
        alert('Erreur: Donn√©es du virement manquantes');
        return;
    }
    
    // V√©rifier que le code correspond au code unique du compte
    const allAccts2 = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
    const userAcct2 = allAccts2.find(acc => acc.email === window.currentUser.email);
    if (!userAcct2 || userAcct2.activationCode !== activationCode) {
        alert('‚ùå Code d\'activation incorrect. Veuillez contacter l\'administrateur.');
        return;
    }
    
    // Marquer le code comme utilis√© (OUI dans la popup admin)
    const allAccs = JSON.parse(localStorage.getItem('vantex_accounts'));
    const accIndex = allAccs.findIndex(a => a.email === window.currentUser.email);
    if (accIndex !== -1) {
        allAccs[accIndex].activationUsed = true;
        localStorage.setItem('vantex_accounts', JSON.stringify(allAccs));
        // Sync Firebase
        if (typeof saveToFirebase === 'function') {
            saveToFirebase('accounts', allAccs[accIndex]);
        }
    }
    
    const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings'));
    const feePercent = settings.transactionFeePercent || 0;
    const feeAmount = (window.pendingTransferData.amount * feePercent) / 100;
    const totalAmount = window.pendingTransferData.amount + feeAmount;
    
    if (window.currentUser.balance < totalAmount) {
        alert('Solde insuffisant !\nVous avez besoin de ' + window.formatCurrency(totalAmount) + ' ' + (window.currentUser.currency || 'GNF') + ' (montant + frais)');
        return;
    }
    
    const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
    const account = accounts.find(acc => acc.email === window.currentUser.email);
    account.balance -= totalAmount;
    localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
    
    const transferNote = `Virement √† ${window.pendingTransferData.beneficiary} (${window.pendingTransferData.bank})`;
    window.addTransaction(window.currentUser.email, 'debit', window.pendingTransferData.amount, transferNote);
    
    if (feeAmount > 0) {
        window.addTransaction(window.currentUser.email, 'debit', feeAmount, 'Frais de virement (' + feePercent + '%)');
    }
    
    const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
    const transferId = Date.now();
    transfers.push({
        id: transferId,
        accountEmail: window.currentUser.email,
        amount: window.pendingTransferData.amount,
        feeAmount: feeAmount,
        feePercent: feePercent,
        totalAmount: totalAmount,
        currency: window.pendingTransferData.currency,
        beneficiary: window.pendingTransferData.beneficiary,
        iban: window.pendingTransferData.iban,
        swift: window.pendingTransferData.swift,
        bank: window.pendingTransferData.bank,
        reason: window.pendingTransferData.reason,
        activationCode: activationCode,
        date: new Date().toISOString(),
        status: 'processing',
        progress: 0,
        errorMessage: null
    });
    localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
    
    document.getElementById('transferConfirmation').style.display = 'none';
    document.getElementById('transferProcessing').style.display = 'block';
    
    const currency = window.pendingTransferData.currency;
    document.getElementById('processingAmount').textContent = window.formatCurrency(window.pendingTransferData.amount) + ' ' + currency;
    document.getElementById('processingBeneficiary').textContent = window.pendingTransferData.beneficiary;
    document.getElementById('processingIban').textContent = window.pendingTransferData.iban;
    document.getElementById('processingBank').textContent = window.pendingTransferData.bank;
    
    window.startProgressMonitoring(transferId);
};

console.log('‚úÖ Module Frais de Transaction charg√©');
console.log('üí∞ Frais: ' + (JSON.parse(localStorage.getItem('vantex_transfer_settings')).transactionFeePercent || 2) + '%');

// ============================================
// MODULE NOTIFICATIONS - VANTEX
// ============================================

if (!localStorage.getItem('vantex_notifications')) {
    localStorage.setItem('vantex_notifications', JSON.stringify([]));
}

// Couleurs par type
const notifColors = {
    info:    { bg: '#e0f0ff', border: '#2196F3', color: '#0d47a1', icon: '‚ÑπÔ∏è' },
    success: { bg: '#e8f5e9', border: '#4CAF50', color: '#1b5e20', icon: '‚úÖ' },
    warning: { bg: '#fff8e1', border: '#FFC107', color: '#7B4F00', icon: '‚ö†Ô∏è' },
    danger:  { bg: '#ffebee', border: '#f44336', color: '#b71c1c', icon: '‚ùå' }
};

// ---- ADMIN : cr√©er une notification ----
window.createNotification = async function() {
    const accountEmail = document.getElementById('notifAccountSelect').value;
    const message = document.getElementById('notifMessage').value.trim();
    const type = document.getElementById('notifType').value;

    if (!accountEmail) { alert('Veuillez s√©lectionner un compte'); return; }
    if (!message)       { alert('Veuillez √©crire un message'); return; }

    const notif = {
        id: Date.now().toString(),
        accountEmail: accountEmail,
        message: message,
        type: type,
        date: new Date().toISOString(),
        active: true
    };

    // 1. Sauvegarder en local
    const notifications = JSON.parse(localStorage.getItem('vantex_notifications') || '[]');
    notifications.push(notif);
    localStorage.setItem('vantex_notifications', JSON.stringify(notifications));

    // 2. Sauvegarder sur Firebase (synchronisation multi-appareils)
    try {
        await db.collection('notifications').doc(notif.id).set(notif);
        document.getElementById('notifMessage').value = '';
        alert('‚úÖ Notification envoy√©e et synchronis√©e !');
    } catch(e) {
        console.error('Firebase notif:', e);
        document.getElementById('notifMessage').value = '';
        alert('‚úÖ Notification envoy√©e (localement). Erreur Firebase: ' + e.message);
    }

    window.loadNotificationsTable();
};

// ---- ADMIN : supprimer une notification ----
window.deleteNotification = async function(id) {
    let notifications = JSON.parse(localStorage.getItem('vantex_notifications') || '[]');
    notifications = notifications.filter(n => n.id.toString() !== id.toString());
    localStorage.setItem('vantex_notifications', JSON.stringify(notifications));

    // Supprimer aussi sur Firebase
    try {
        await db.collection('notifications').doc(id.toString()).delete();
    } catch(e) { console.error('Firebase delete notif:', e); }

    window.loadNotificationsTable();
};

// ---- ADMIN : supprimer toutes les notifications ----
window.clearAllNotifications = async function() {
    if (!confirm('Supprimer toutes les notifications actives ?')) return;

    // Supprimer sur Firebase
    try {
        const snap = await db.collection('notifications').get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
    } catch(e) { console.error('Firebase clear notifs:', e); }

    localStorage.setItem('vantex_notifications', JSON.stringify([]));
    window.loadNotificationsTable();
    alert('‚úÖ Toutes les notifications ont √©t√© supprim√©es.');
};

// ---- ADMIN : charger la table des notifications ----
window.loadNotificationsTable = function() {
    const notifications = JSON.parse(localStorage.getItem('vantex_notifications') || '[]');
    const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
    const tbody = document.getElementById('notificationsTableBody');
    if (!tbody) return;

    if (notifications.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;color:#999;">Aucune notification active</td></tr>';
        return;
    }

    const sorted = [...notifications].sort((a, b) => new Date(b.date) - new Date(a.date));
    tbody.innerHTML = sorted.map(n => {
        const c = notifColors[n.type] || notifColors.info;
        const account = accounts.find(a => a.email === n.accountEmail);
        const clientName = n.accountEmail === 'ALL' ? 'üì¢ Tous les comptes' : (account ? account.name : n.accountEmail);
        return `
            <tr>
                <td><strong>${clientName}</strong></td>
                <td><span style="background:${c.bg};color:${c.color};padding:4px 10px;border-radius:10px;font-size:12px;font-weight:600;">${c.icon} ${n.type}</span></td>
                <td>${n.message}</td>
                <td style="font-size:12px;color:#999;">${new Date(n.date).toLocaleString('fr-FR')}</td>
                <td><button onclick="deleteNotification(${n.id})" class="btn-small btn-danger">üóëÔ∏è</button></td>
            </tr>
        `;
    }).join('');
};

// ---- ADMIN : peupler le select comptes dans l'onglet notifications ----
window.populateNotifAccountSelect = function() {
    const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
    const select = document.getElementById('notifAccountSelect');
    if (!select) return;
    select.innerHTML = '<option value="">-- Choisir un compte --</option><option value="ALL">üì¢ Tous les comptes</option>' +
        accounts.map(acc => `<option value="${acc.email}">${acc.name} ‚Äî ${acc.email}</option>`).join('');
};

// ---- CLIENT : boucle d'affichage des notifications ----
let notifLoopInterval = null;

function startClientNotifLoop() {
    if (notifLoopInterval) clearInterval(notifLoopInterval);
    window._notifIndex = 0;

    function showNextNotif() {
        if (!window.currentUser) return;
        const notifications = JSON.parse(localStorage.getItem('vantex_notifications') || '[]');
        const myNotifs = notifications.filter(n => n.active && (n.accountEmail === currentUser.email || n.accountEmail === 'ALL'));

        const banner = document.getElementById('clientNotifBanner');
        if (!banner) return;

        if (myNotifs.length === 0) {
            banner.style.display = 'none';
            return;
        }

        if (window._notifIndex >= myNotifs.length) window._notifIndex = 0;
        const notif = myNotifs[window._notifIndex];
        window._notifIndex++;

        const c = notifColors[notif.type] || notifColors.info;

        // Afficher
        banner.style.cssText = `display:block; margin:0 12px 8px; border-radius:12px; padding:13px 16px; font-size:14px; font-weight:600; background:${c.bg}; border-left:4px solid ${c.border}; color:${c.color}; transition:opacity 0.4s ease;`;
        banner.innerHTML = `<span>${c.icon}&nbsp;&nbsp;${notif.message}</span>`;
        banner.style.opacity = '1';

        // Cacher apr√®s 5 sec
        setTimeout(() => {
            banner.style.opacity = '0';
            setTimeout(() => { banner.style.display = 'none'; }, 400);
        }, 5000);
    }

    showNextNotif();
    notifLoopInterval = setInterval(showNextNotif, 10000);
}

function stopClientNotifLoop() {
    if (notifLoopInterval) { clearInterval(notifLoopInterval); notifLoopInterval = null; }
    const banner = document.getElementById('clientNotifBanner');
    if (banner) banner.style.display = 'none';
}

// D√©marrer la boucle notif apr√®s connexion ‚Äî appel√© depuis le showClientInterface unifi√©
window._startNotifLoop = function() {
    setTimeout(startClientNotifLoop, 600);
};

// Hooker logoutClient pour arr√™ter la boucle
const _origLogoutClient = window.logoutClient;
window.logoutClient = function() {
    stopClientNotifLoop();
    if (_origLogoutClient) _origLogoutClient();
};

// Les notifications sont charg√©es directement dans showAdminPanel principal
// et dans switchTab ‚Äî pas besoin de hooks suppl√©mentaires

console.log('‚úÖ Module Notifications charg√©');

// ============================================
// 1. MESSAGE DE BIENVENUE PERSONNALIS√â
// ============================================
function getGreeting() {
    const h = new Date().getHours();
    if (h >= 5  && h < 12) return 'Bonjour';
    if (h >= 12 && h < 18) return 'Bon apr√®s-midi';
    if (h >= 18 && h < 22) return 'Bonsoir';
    return 'Bonne nuit';
}

// ============================================
// 2. SPINNER DE CHARGEMENT
// ============================================
window.showSpinner = function(text) {
    const s = document.getElementById('loadingSpinner');
    if (!s) return;
    document.getElementById('spinnerText').textContent = text || 'Chargement...';
    s.style.display = 'flex';
};
window.hideSpinner = function() {
    const s = document.getElementById('loadingSpinner');
    if (s) s.style.display = 'none';
};

// ============================================
// 3. D√âCONNEXION AUTOMATIQUE (10 min d'inactivit√©)
// ============================================
let inactivityTimer = null;
const INACTIVITY_LIMIT = 10 * 60 * 1000; // 10 minutes

function resetInactivityTimer() {
    if (!window.currentUser) return;
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        if (!window.currentUser) return;
        stopClientNotifLoop && stopClientNotifLoop();
        window.currentUser = null;
        localStorage.removeItem('vantex_session');
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('clientInterface').style.display = 'none';
        document.getElementById('transferModal').style.display = 'none';
        document.getElementById('transferConfirmation').style.display = 'none';
        document.getElementById('transferProcessing').style.display = 'none';
        document.getElementById('loginForm').reset();
        alert('‚è∞ Vous avez √©t√© d√©connect√© automatiquement apr√®s 10 minutes d\'inactivit√©.');
    }, INACTIVITY_LIMIT);
}

['click','touchstart','keydown','scroll','mousemove'].forEach(evt =>
    document.addEventListener(evt, resetInactivityTimer, { passive: true })
);

// ============================================
// 4. D√âTAIL DE TRANSACTION AU CLIC
// ============================================
window.showTxDetail = function(idx) {
    const t = allHistoryCache[idx];
    if (!t) return;
    const currency = (t.currency) || (window.currentUser ? window.currentUser.currency || 'GNF' : 'GNF');
    const dateObj = new Date(t.date);
    const dateStr = dateObj.toLocaleDateString('fr-FR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
    const timeStr = dateObj.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
    const isFailed = t.sourceType === 'transfer' && t.status === 'failed';
    const sign    = isFailed ? '' : (t.type === 'credit' ? '+' : '-');
    const color   = t.type === 'credit' ? '#27ae60' : '#e74c3c';
    const bgColor = isFailed
        ? 'linear-gradient(135deg,#e74c3c,#8b0000)'
        : (t.type === 'credit' ? 'linear-gradient(135deg,#00b09b,#27ae60)' : 'linear-gradient(135deg,#e74c3c,#c0392b)');
    const ref     = 'VTX-' + String(t.id).slice(-8).toUpperCase();

    let icon = t.type === 'credit' ? 'üè¶' : 'üì§';
    let label = t.type === 'credit' ? 'Virement' : 'Retrait';
    if (t.sourceType === 'transfer') { icon = 'üè¶'; label = 'Virement envoy√©'; }
    if (t.sourceType === 'transfer' && t.status === 'failed') { icon = 'üè¶'; label = 'Virement √âchou√©'; }
    if (t.type === 'debit' && t.sourceType !== 'transfer') { label = 'Retrait'; }
    if (t.note && t.note.toLowerCase().includes('frais')) { icon = 'üí∏'; label = 'Frais de transaction'; }
    if (t.transferType === 'mobile') { icon = 'üì±'; label = 'Transfert Mobile Money'; }

    // Ligne helper
    const row = (lbl, val, mono=false) => val ? `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:11px 0;border-bottom:1px solid #f0f0f0;">
            <span style="color:#aaa;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;flex-shrink:0;">${lbl}</span>
            <span style="font-weight:700;font-size:13px;text-align:right;max-width:62%;${mono?'font-family:monospace;':''}">${val}</span>
        </div>` : '';

    // Bloc d√©tails sp√©cifiques au virement
    let extraRows = '';
    if (t.sourceType === 'transfer') {
        if (t.beneficiary) extraRows += row('B√©n√©ficiaire', t.beneficiary);
        if (t.transferType === 'mobile') {
            if (t.operator)      extraRows += row('Op√©rateur', t.operator);
            if (t.mobileNumber)  extraRows += row('Num√©ro mobile', t.mobileNumber, true);
            if (t.mobileCountry) extraRows += row('Pays', t.mobileCountry);
        } else {
            if (t.iban)  extraRows += row('IBAN / Compte', t.iban, true);
            if (t.swift) extraRows += row('BIC / SWIFT', t.swift, true);
            if (t.bank)  extraRows += row('Banque', t.bank);
        }
        if (t.reason) extraRows += row('Motif', t.reason);
        if (t.fee && t.fee > 0) extraRows += row('Frais', formatCurrency(t.fee) + ' ' + currency);
        // Message d'erreur affich√© en √©vidence dans le d√©tail
        if (t.status === 'failed' && t.errorMessage) {
            extraRows += `<div style="background:linear-gradient(135deg,rgba(231,76,60,0.12),rgba(192,57,43,0.08));border:1.5px solid rgba(231,76,60,0.4);border-radius:14px;padding:16px;margin-top:10px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <div style="width:28px;height:28px;background:rgba(231,76,60,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">‚ùå</div>
                    <p style="color:#e74c3c;font-size:13px;font-weight:800;letter-spacing:0.3px;">Motif de l'√©chec</p>
                </div>
                <p style="color:rgba(255,255,255,0.8);font-size:14px;line-height:1.6;padding-left:4px;">${t.errorMessage}</p>
            </div>`;
        }
    }

    // Statut badge
    const statusMap = {
        'completed': ['‚úÖ R√©ussi', '#d4edda', '#155724'],
        'failed':    ['‚ùå √âchou√©', '#f8d7da', '#721c24'],
        'processing':['‚è≥ En cours', '#fff3cd', '#856404'],
    };
    const [statusTxt, statusBg, statusColor] = statusMap[t.status] || ['‚úÖ Confirm√©', '#d4edda', '#155724'];

    document.getElementById('txDetailContent').innerHTML = `
        <!-- En-t√™te color√© -->
        <div style="background:${bgColor};border-radius:18px;padding:24px 20px;text-align:center;margin-bottom:18px;">
            <div style="width:56px;height:56px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 12px;">${icon}</div>
            <div style="font-size:28px;font-weight:900;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.2);">${sign}${formatCurrency(t.amount)} ${currency}</div>
            <div style="font-size:13px;color:rgba(255,255,255,0.85);margin-top:4px;font-weight:600;">${label}</div>
            <div style="background:rgba(255,255,255,0.2);border-radius:8px;padding:4px 12px;display:inline-block;margin-top:10px;">
                <span style="color:white;font-size:11px;font-family:monospace;font-weight:700;">${ref}</span>
            </div>
        </div>

        <!-- D√©tails -->
        <div style="background:#f8faff;border-radius:18px;padding:4px 16px;margin-bottom:14px;">
            ${row('Date', dateStr)}
            ${row('Heure', timeStr)}
            ${row('Type', t.type === 'credit' ? '‚¨ÜÔ∏è Entr√©e' : '‚¨áÔ∏è Sortie')}
            ${extraRows}
            <div style="display:flex;justify-content:space-between;align-items:center;padding:11px 0;">
                <span style="color:#aaa;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Statut</span>
                <span style="background:${statusBg};color:${statusColor};padding:4px 12px;border-radius:8px;font-size:12px;font-weight:700;">${statusTxt}</span>
            </div>
        </div>
        <div style="padding:0 20px;margin-top:4px;">
            <button onclick="closeTxDetail()" style="width:100%;padding:15px;background:linear-gradient(135deg,#0052cc,#0091ff);color:white;border:none;border-radius:16px;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(0,82,204,0.3);">Fermer</button>
        </div>
    `;
    const modal = document.getElementById('txDetailModal');
    modal.style.display = 'flex';
};

window.closeTxDetail = function() {
    document.getElementById('txDetailModal').style.display = 'none';
};

// ============================================
// 5. RECHERCHE / FILTRE TRANSACTIONS
// ============================================
window.filterTransactions = function() {
    const query  = (document.getElementById('txSearchInput')?.value || '').toLowerCase();
    const filter = document.getElementById('txFilterType')?.value || 'all';
    const currency = window.currentUser ? (window.currentUser.currency || 'GNF') : 'GNF';

    const filtered = allHistoryCache.filter(t => {
        const matchType = filter === 'all' || t.type === filter;
        const searchStr = (t.note || '') + ' ' + formatCurrency(t.amount) + ' ' + t.date;
        const matchQuery = !query || searchStr.toLowerCase().includes(query);
        return matchType && matchQuery;
    });

    renderTransactionList(filtered, currency);
};

function renderTransactionList(list, currency) {
    const listDiv = document.getElementById('transactionsList');
    if (list.length === 0) {
        listDiv.innerHTML = `<div class="no-transactions"><div class="no-transactions-icon">üîç</div><p>Aucune transaction trouv√©e.</p></div>`;
        return;
    }
    listDiv.innerHTML = list.map((t, idx) => {
        const realIdx = allHistoryCache.indexOf(t);
        let icon = t.type === 'credit' ? 'üè¶' : 'üì§';
        let label = t.type === 'credit' ? 'Virement' : 'Retrait';
        let labelColor = t.type === 'credit' ? '#00e5a0' : '#ff6b6b';
        if (t.sourceType === 'transfer') { icon = 'üè¶'; label = 'Virement'; labelColor = '#00e5a0'; }
        if (t.sourceType === 'transfer' && t.status === 'failed')   { icon = 'üè¶'; label = 'Virement √âchou√©'; labelColor = '#ff6b6b'; }
        if (t.sourceType === 'transfer' && t.status === 'completed') { icon = 'üè¶'; label = 'Virement'; labelColor = '#00e5a0'; }
        if (t.type === 'debit' && t.sourceType !== 'transfer') { label = 'Retrait'; labelColor = '#ff6b6b'; }
        if (t.note && t.note.toLowerCase().includes('frais')) { icon = 'üí∏'; label = 'Frais'; labelColor = '#ff6b6b'; }
        if (t.note && t.note.toLowerCase().includes('recharge')) { icon = 'üè¶'; label = 'Virement'; labelColor = '#00e5a0'; }

        // Pour un transfer √©chou√© : note = juste le b√©n√©ficiaire, pas le message d'erreur
        const displayNote = (t.sourceType === 'transfer')
            ? 'Virement vers ' + (t.beneficiary || 'b√©n√©ficiaire')
            : (t.note || '');

        const isFailed = t.sourceType === 'transfer' && t.status === 'failed';
        const borderColor = isFailed ? '#ff6b6b' : (t.type === 'credit' ? '#00e5a0' : '#ff6b6b');
        const amountSign  = isFailed ? '' : (t.type === 'credit' ? '+' : '-');
        const amountClass = isFailed ? 'negative' : (t.type === 'credit' ? 'positive' : 'negative');

        const statusBadge = t.sourceType === 'transfer' && t.status
            ? `<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:${t.status==='completed'?'#d4edda':t.status==='failed'?'#f8d7da':'#fff3cd'};color:${t.status==='completed'?'#155724':t.status==='failed'?'#721c24':'#856404'};">${t.status==='completed'?'R√©ussi':t.status==='failed'?'√âchou√©':'En cours'}</span>` : '';

        const dateObj = new Date(t.date);
        const dateStr = dateObj.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit', year:'numeric' });
        const timeStr = dateObj.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
        return `
        <div class="transaction-item" style="border-left:3px solid ${borderColor};background:rgba(255,255,255,0.04);border-radius:12px;margin-bottom:8px;cursor:pointer;" onclick="showTxDetail(${realIdx})">
            <div class="transaction-info">
                <h4 style="display:flex;align-items:center;gap:6px;"><span style="color:${labelColor};font-weight:800;">${icon} ${label}</span> ${statusBadge}</h4>
                <p class="transaction-date">üìÖ ${dateStr} √† ${timeStr}</p>
                <p class="transaction-date" style="color:#888;">${displayNote}</p>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                <div class="transaction-amount ${amountClass}">
                    ${amountSign}${formatCurrency(t.amount)} ${currency}
                </div>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
            </div>
        </div>`;
    }).join('');
}

// ============================================
// 6. CONFIRMATION PAR CODE PIN
// ============================================
let _pinCallback = null;
let _pinCancelCallback = null;

window.requirePin = function(title, desc, onSuccess, onCancel) {
    _pinCallback = onSuccess;
    _pinCancelCallback = onCancel || null;
    document.getElementById('pinModalTitle').textContent = title || 'Confirmation requise';
    document.getElementById('pinModalDesc').textContent  = desc  || 'Saisissez votre code PIN pour confirmer';
    document.getElementById('pinInput').value = '';
    document.getElementById('pinError').textContent = '';
    const modal = document.getElementById('pinConfirmModal');
    modal.style.display = 'flex';
    setTimeout(() => document.getElementById('pinInput').focus(), 100);
};

window.validatePin = function() {
    const entered = document.getElementById('pinInput').value;
    if (!window.currentUser) return;
    if (entered === window.currentUser.password) {
        document.getElementById('pinConfirmModal').style.display = 'none';
        if (_pinCallback) _pinCallback();
        _pinCallback = null;
    } else {
        document.getElementById('pinError').textContent = '‚ùå Code PIN incorrect';
        document.getElementById('pinInput').value = '';
        document.getElementById('pinInput').focus();
    }
};

window.cancelPinConfirm = function() {
    document.getElementById('pinConfirmModal').style.display = 'none';
    if (_pinCancelCallback) _pinCancelCallback();
    _pinCallback = null;
    _pinCancelCallback = null;
};

// PIN requis avant d√©connexion
const _origLogoutClientFinal = window.logoutClient;
window.logoutClient = function() {
    showConfirmModal(
        'Se d√©connecter',
        'Voulez-vous vous d√©connecter de VANTEX ?',
        () => {
            // Stopper la boucle notif
            if (typeof stopClientNotifLoop === 'function') stopClientNotifLoop();
            // Vider l'utilisateur
            window.currentUser = null;
            localStorage.removeItem('vantex_session');
            // Fermer TOUS les modals et overlays
            const profileOverlay = document.getElementById('profileModalOverlay');
            if (profileOverlay) profileOverlay.classList.remove('active');
            const transferModal = document.getElementById('transferModal');
            if (transferModal) transferModal.style.display = 'none';
            const transferConfirm = document.getElementById('transferConfirmation');
            if (transferConfirm) transferConfirm.style.display = 'none';
            // Fermer tous les modals dynamiques
            ['vx-op-modal','vx-ct-modal','vx-confirm-modal','operatorModal','countryModal'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.remove();
            });
            // Retour √©cran connexion
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('clientInterface').style.display = 'none';
            document.getElementById('loginForm').reset();
        }
    );
};

// PIN requis avant virement (override de processTransfer)
const _origProcessTransferFinal = window.processTransfer;
window.processTransfer = function() {
    // Le code d'activation remplace le PIN pour les virements ‚Äî on garde l'existant
    if (_origProcessTransferFinal) _origProcessTransferFinal();
};

// Greeting ‚Äî appel√© depuis le showClientInterface unifi√©
window._updateGreeting = function() {
    const greeting = getGreeting();
    const welcomeEl = document.getElementById('welcomeMsg');
    if (welcomeEl && window.currentUser) {
        const firstName = window.currentUser.firstName || window.currentUser.name.split(' ')[0];
        welcomeEl.innerHTML = `${greeting}, <span id="userName">${firstName}</span> üëã`;
    }
    resetInactivityTimer();
};

// ============================================
// 8. SPINNER pendant le login
// ============================================
document.getElementById('loginForm').addEventListener('submit', function() {
    showSpinner('Connexion en cours...');
    setTimeout(hideSpinner, 3000);
}, true);

console.log('‚úÖ Toutes les fonctionnalit√©s avanc√©es charg√©es');

// ============================================
// DASHBOARD MODERNE
// ============================================

// Badge derni√®re connexion
function updateLastLoginBadge() {
    const key = 'vantex_last_login_' + (window.currentUser ? window.currentUser.email : '');
    const prev = localStorage.getItem(key);
    const now  = new Date();
    const badge = document.getElementById('lastLoginBadge');
    if (badge) {
        if (prev) {
            const d = new Date(prev);
            const dateStr = d.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit', year:'numeric' });
            const timeStr = d.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
            badge.textContent = 'Derni√®re activit√© : ' + dateStr + ' √† ' + timeStr;
        } else {
            badge.textContent = 'Premi√®re connexion';
        }
    }
    localStorage.setItem(key, now.toISOString());
}

// Num√©ro de compte masqu√©
function updateAccountMeta() {
    if (!window.currentUser) return;
    const id = String(window.currentUser.id || '0');
    const masked = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + id.slice(-4).padStart(4, '0');
    const el = document.getElementById('accountNumMasked');
    if (el) el.textContent = masked;
}

// R√©sum√© financier du mois courant
function updateFinanceSummary() {
    if (!window.currentUser) return;

    const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
    const freshAccount = accounts.find(a => a.email === window.currentUser.email);
    if (!freshAccount) return;

    const capsuleCurrency = freshAccount.summaryCurrency || freshAccount.currency || 'GNF';
    const mainCurrency = freshAccount.currency || 'GNF';
    window.currentUser = { ...window.currentUser, ...freshAccount };

    const transactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
    const transfers    = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
    const now = new Date();
    const thisMonth = now.getMonth();
    const thisYear  = now.getFullYear();

    let income = 0, expense = 0;

    const myTx = transactions.filter(t => {
        if (t.accountEmail !== freshAccount.email) return false;
        const note = (t.note || '').toLowerCase();
        return !note.includes('echec du virement') && !note.includes('remboursement:');
    });

    const myTr = transfers.filter(t => t.accountEmail === freshAccount.email && t.status !== 'failed');

    // Essayer d'abord le mois courant
    myTx.forEach(t => {
        const d = new Date(t.date);
        if (d.getMonth() === thisMonth && d.getFullYear() === thisYear) {
            const amt = Number(t.amount) || 0;
            if (t.type === 'credit') income += amt;
            else expense += amt;
        }
    });
    myTr.forEach(t => {
        const d = new Date(t.date);
        if (d.getMonth() === thisMonth && d.getFullYear() === thisYear) {
            expense += Number(t.amount) || 0;
            if (t.fee) expense += Number(t.fee) || 0;
        }
    });

    // Si rien ce mois-ci, prendre tout l'historique
    if (income === 0 && expense === 0) {
        myTx.forEach(t => {
            const amt = Number(t.amount) || 0;
            if (t.type === 'credit') income += amt;
            else expense += amt;
        });
        myTr.forEach(t => {
            expense += Number(t.amount) || 0;
            if (t.fee) expense += Number(t.fee) || 0;
        });
    }

    const iEl  = document.getElementById('monthIncome');
    const eEl  = document.getElementById('monthExpense');
    const netEl = document.getElementById('monthNet');
    const totEl = document.getElementById('monthTotal');

    if (iEl)  { iEl.textContent  = '+' + formatCurrency(income) + ' ' + capsuleCurrency; iEl.style.color = '#00e5a0'; }
    if (eEl)  { eEl.textContent  = '‚Äî ' + formatCurrency(expense) + ' ' + capsuleCurrency; eEl.style.color = '#ff6b6b'; }

    const net = income - expense;
    if (netEl) {
        netEl.textContent = (net >= 0 ? '+ ' : '‚Äî ') + formatCurrency(Math.abs(net)) + ' ' + capsuleCurrency;
        netEl.style.color = net >= 0 ? '#00e5a0' : '#ff6b6b';
    }
    if (totEl) {
        totEl.textContent = '‚Äî ' + formatCurrency(expense) + ' ' + capsuleCurrency;
        totEl.style.color = expense > 0 ? '#ff6b6b' : 'white';
    }

    const wpEl = document.getElementById('weekPercent');
    if (wpEl) {
        if (income === 0 && expense === 0) {
            wpEl.textContent = '+0% cette semaine';
            wpEl.style.color = '#00e5a0';
        } else {
            const pct = expense > 0 ? (((income - expense) / expense) * 100).toFixed(1) : '100';
            wpEl.textContent = (parseFloat(pct) >= 0 ? '+' : '') + pct + '% cette semaine';
            wpEl.style.color = parseFloat(pct) >= 0 ? '#00e5a0' : '#ff6b6b';
        }
    }

    const balanceEl = document.getElementById('clientBalance');
    if (balanceEl && window.balanceVisible !== false) {
        balanceEl.textContent = formatCurrency(freshAccount.balance) + ' ' + mainCurrency;
    }
}

// Forcer une mise √† jour du r√©sum√© apr√®s tout rechargement Firebase
window._refreshFinanceSummary = async function() {
    if (!window.currentUser) return;
    try {
        // Re-sync Firebase ‚Üí localStorage
        const fbTx = await window.getFromFirebase('transactions');
        if (fbTx && fbTx.length > 0) {
            const local = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
            const localIds = new Set(local.map(t => String(t.id)));
            const merged = [...local, ...fbTx.filter(t => !localIds.has(String(t.id)))];
            localStorage.setItem('vantex_transactions', JSON.stringify(merged));
        }
    } catch(e) {}
    updateFinanceSummary();
    if (typeof drawSparkline === 'function') drawSparkline();
};

// Sparkline 7 jours
function drawSparkline() {
    const canvas = document.getElementById('sparklineCanvas');
    if (!canvas || !window.currentUser) return;

    const transactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
    const userTx = transactions.filter(t => t.accountEmail === window.currentUser.email);

    // Construire les 7 derniers jours
    const days = [];
    const labels = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        days.push(d);
        labels.push(d.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit' }));
    }

    const dayTotals = days.map(day => {
        const dayStr = day.toDateString();
        let net = 0;
        userTx.forEach(t => {
            if (new Date(t.date).toDateString() === dayStr) {
                net += t.type === 'credit' ? t.amount : -t.amount;
            }
        });
        return net;
    });

    // Dessiner
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 300;
    const H = 50;
    canvas.width  = W * dpr;
    canvas.height = H * dpr;
    canvas.style.width  = W + 'px';
    canvas.style.height = H + 'px';
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);

    const max = Math.max(...dayTotals.map(Math.abs), 1);
    const mid = H / 2;
    const stepX = W / (days.length - 1);

    // Points
    const pts = dayTotals.map((v, i) => ({
        x: i * stepX,
        y: mid - (v / max) * (mid - 8)
    }));

    // Gradient fill
    const grad = ctx.createLinearGradient(0, 0, 0, H);
    grad.addColorStop(0, 'rgba(255,255,255,0.25)');
    grad.addColorStop(1, 'rgba(255,255,255,0.02)');

    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    pts.forEach((p, i) => {
        if (i > 0) {
            const cp1x = pts[i-1].x + stepX * 0.4;
            const cp2x = p.x - stepX * 0.4;
            ctx.bezierCurveTo(cp1x, pts[i-1].y, cp2x, p.y, p.x, p.y);
        }
    });
    ctx.lineTo(W, H);
    ctx.lineTo(0, H);
    ctx.closePath();
    ctx.fillStyle = grad;
    ctx.fill();

    // Ligne
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    pts.forEach((p, i) => {
        if (i > 0) {
            const cp1x = pts[i-1].x + stepX * 0.4;
            const cp2x = p.x - stepX * 0.4;
            ctx.bezierCurveTo(cp1x, pts[i-1].y, cp2x, p.y, p.x, p.y);
        }
    });
    ctx.strokeStyle = 'rgba(255,255,255,0.8)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Points
    pts.forEach((p, i) => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
        ctx.fillStyle = 'white';
        ctx.fill();
    });

    // Labels
    ctx.font = '9px sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.textAlign = 'center';
    labels.forEach((l, i) => ctx.fillText(l, i * stepX, H - 2));
}

// Transactions group√©es par date
const _origRenderTxList = window.renderTransactionList;
window.renderTransactionList = function(list, currency) {
    const listDiv = document.getElementById('transactionsList');
    if (!list || list.length === 0) {
        listDiv.innerHTML = `<div class="no-transactions"><div class="no-transactions-icon">üìã</div><p>Aucune transaction effectu√©e.</p></div>`;
        return;
    }

    // Grouper par date
    const groups = {};
    list.forEach((t, idx) => {
        const d    = new Date(t.date);
        const now  = new Date();
        const yesterday = new Date(); yesterday.setDate(now.getDate() - 1);
        let groupKey;
        if (d.toDateString() === now.toDateString())       groupKey = "Aujourd'hui";
        else if (d.toDateString() === yesterday.toDateString()) groupKey = 'Hier';
        else groupKey = d.toLocaleDateString('fr-FR', { weekday:'long', day:'2-digit', month:'long' });
        if (!groups[groupKey]) groups[groupKey] = [];
        groups[groupKey].push({ t, realIdx: allHistoryCache.indexOf(t) });
    });

    let html = '';
    Object.entries(groups).forEach(([groupLabel, items]) => {
        html += `<div class="tx-date-group">${groupLabel}</div>`;
        items.forEach(({ t, realIdx }) => {
            const color = t.type === 'credit' ? '#27ae60' : '#e74c3c';
            const bg    = t.type === 'credit' ? '#e8f5e9' : '#ffebee';
            let icon = t.type === 'credit' ? '‚Üì' : '‚Üë';
            let label = t.type === 'credit' ? 'Re√ßu' : 'Envoy√©';
            if (t.sourceType === 'transfer') { icon = '‚Üí'; label = 'Virement'; }
            if (t.note && t.note.toLowerCase().includes('frais')) { icon = '%'; label = 'Frais'; }
            if (t.note && t.note.toLowerCase().includes('recharge')) { icon = 'üè¶'; label = 'Virement re√ßu'; }
            const timeStr = new Date(t.date).toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
            const sign    = t.type === 'credit' ? '+' : '-';
            const statusBadge = t.sourceType === 'transfer' && t.status ?
                `<span style="font-size:9px;padding:1px 6px;border-radius:4px;background:${t.status==='completed'?'#d4edda':t.status==='failed'?'#f8d7da':'#fff3cd'};color:${t.status==='completed'?'#155724':t.status==='failed'?'#721c24':'#856404'};">${t.status==='completed'?'‚úì':'‚è≥'}</span>` : '';
            html += `
            <div class="transaction-item" style="border-left:3px solid ${color}; cursor:pointer;" onclick="showTxDetail(${realIdx})">
                <div style="display:flex;align-items:center;gap:12px;flex:1;min-width:0;">
                    <div style="width:38px;height:38px;border-radius:50%;background:${bg};display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:800;font-size:16px;color:${color};">${icon}</div>
                    <div style="min-width:0;">
                        <div style="font-weight:700;font-size:13px;color:#222;display:flex;align-items:center;gap:5px;">${label} ${statusBadge}</div>
                        <div style="font-size:11px;color:#aaa;margin-top:1px;">${timeStr}${t.note ? ' ¬∑ ' + t.note.substring(0,28) + (t.note.length>28?'‚Ä¶':'') : ''}</div>
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0;">
                    <div style="font-weight:800;font-size:14px;color:${color};">${sign}${formatCurrency(t.amount)} ${currency}</div>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#ddd" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
                </div>
            </div>`;
        });
    });
    listDiv.innerHTML = html;
};

// ============================================
// OVERRIDE UNIQUE showClientInterface ‚Äî TOUT ICI
// ============================================
const _origSCI_base = window.showClientInterface;
window.showClientInterface = function() {
    // 1. R√©initialiser le bouton ≈ìil et l'√©tat du solde
    window.balanceVisible = true;
    const balanceEl = document.getElementById('clientBalance');
    const eyeOpen   = document.getElementById('eyeOpenIcon');
    const eyeClosed = document.getElementById('eyeClosedIcon');
    if (balanceEl)  { balanceEl.style.filter = 'none'; balanceEl.style.opacity = '1'; }
    if (eyeOpen)    eyeOpen.style.display  = 'block';
    if (eyeClosed)  eyeClosed.style.display = 'none';

    // 2. Appeler la fonction originale
    if (_origSCI_base) _origSCI_base();

    // 3. Greeting + inactivit√©
    window._updateGreeting && window._updateGreeting();

    // 4. Notifications
    window._startNotifLoop && window._startNotifLoop();

    // 5. Dashboard moderne
    updateLastLoginBadge();
    updateAccountMeta();
    setTimeout(() => {
        updateFinanceSummary();
        drawSparkline();
    }, 300);
};

// Redessiner le sparkline si la fen√™tre change de taille
window.addEventListener('resize', () => {
    if (window.currentUser) drawSparkline();
});
</script>
<script>
function generateCardNumber(){const p='4532';let n=p;for(let i=0;i<12;i++)n+=Math.floor(Math.random()*10);return n.match(/.{1,4}/g).join(' ')}function generateExpirationDate(){const now=new Date();const y=now.getFullYear()+Math.floor(Math.random()*3)+2;const m=Math.floor(Math.random()*12)+1;return(m<10?'0':'')+m+'/'+y.toString().slice(-2)}function generateCVV(){return Math.floor(Math.random()*900)+100}function initializeVirtualCards(){const accounts=JSON.parse(localStorage.getItem('vantex_accounts')||'[]');let updated=false;accounts.forEach(account=>{if(!account.virtualCard){account.virtualCard={number:generateCardNumber(),expiration:generateExpirationDate(),cvv:generateCVV(),createdAt:new Date().toISOString()};updated=true}});if(updated){localStorage.setItem('vantex_accounts',JSON.stringify(accounts))}}function showVirtualCard(){
const existing=document.getElementById('virtualCardModal');
if(existing)existing.remove();
const modal=document.createElement('div');
modal.id='virtualCardModal';
modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;display:flex;flex-direction:column;overflow-y:auto;background:radial-gradient(ellipse at 20% 20%,#0d1b4b 0%,#050d2e 40%,#020818 100%);';

const card=currentUser.virtualCard||{number:generateCardNumber(),expiration:generateExpirationDate(),cvv:generateCVV()};

modal.innerHTML=`
<div style="min-height:100vh;padding:24px 20px 40px;display:flex;flex-direction:column;gap:20px;position:relative;">

  <!-- Lueurs d√©coratives -->
  <div style="position:absolute;top:-60px;left:-60px;width:300px;height:300px;background:radial-gradient(circle,rgba(0,80,255,0.18) 0%,transparent 70%);pointer-events:none;"></div>
  <div style="position:absolute;top:40%;right:-80px;width:250px;height:250px;background:radial-gradient(circle,rgba(100,0,255,0.12) 0%,transparent 70%);pointer-events:none;"></div>

  <!-- Header -->
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="color:white;font-size:22px;font-weight:700;margin:0;letter-spacing:0.3px;">Ma carte virtuelle</h2>
    <button onclick="document.getElementById('virtualCardModal').remove()" style="width:38px;height:38px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);border-radius:50%;color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);">√ó</button>
  </div>

  <!-- Ligne s√©paratrice lumineuse -->
  <div style="height:1px;background:linear-gradient(90deg,transparent,rgba(100,160,255,0.5),transparent);"></div>

  <!-- CARTE BANCAIRE VISUELLE -->
  <div style="position:relative;border-radius:22px;padding:24px 22px 22px;overflow:hidden;border:1px solid rgba(100,160,255,0.25);box-shadow:0 0 40px rgba(0,80,255,0.2),0 0 80px rgba(0,40,180,0.1),inset 0 1px 0 rgba(255,255,255,0.1);min-height:210px;background:linear-gradient(135deg,#0e2060 0%,#1a3a8f 30%,#2541a8 55%,#1a2d7a 80%,#0e1a5e 100%);">

    <!-- Cercles d√©co internes -->
    <div style="position:absolute;bottom:-40px;right:-40px;width:200px;height:200px;border-radius:50%;background:rgba(120,80,255,0.25);filter:blur(10px);"></div>
    <div style="position:absolute;top:-30px;left:50%;width:160px;height:160px;border-radius:50%;background:rgba(0,100,255,0.2);filter:blur(14px);"></div>

    <!-- Ligne lumineuse en haut -->
    <div style="position:absolute;top:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,rgba(180,210,255,0.7),transparent);"></div>
    <div style="position:absolute;top:0;left:30%;right:30%;height:1px;background:rgba(255,255,255,0.5);"></div>

    <!-- Contenu carte -->
    <div style="position:relative;z-index:1;">
      <!-- Logo + r√©seau -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <!-- Puce dor√©e style grille -->
          <div style="width:38px;height:30px;background:linear-gradient(135deg,#c8922a,#f4d03f,#c8922a);border-radius:6px;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:2px;padding:4px;box-shadow:0 2px 8px rgba(200,146,42,0.6);">
            <div style="background:rgba(160,100,10,0.6);border-radius:2px;"></div>
            <div style="background:rgba(160,100,10,0.6);border-radius:2px;"></div>
            <div style="background:rgba(160,100,10,0.6);border-radius:2px;"></div>
            <div style="background:rgba(160,100,10,0.6);border-radius:2px;"></div>
          </div>
          <span style="color:white;font-size:20px;font-weight:800;letter-spacing:1px;text-shadow:0 2px 6px rgba(0,0,0,0.4);">VANTEX</span>
        </div>
        <!-- Logo Mastercard -->
        <div style="display:flex;align-items:center;">
          <div style="width:34px;height:34px;border-radius:50%;background:#eb001b;opacity:0.92;box-shadow:0 2px 8px rgba(235,0,27,0.5);"></div>
          <div style="width:34px;height:34px;border-radius:50%;background:#f79e1b;opacity:0.92;margin-left:-14px;box-shadow:0 2px 8px rgba(247,158,27,0.5);"></div>
        </div>
      </div>

      <!-- Num√©ro -->
      <div style="font-size:20px;font-weight:600;letter-spacing:4px;color:rgba(255,255,255,0.92);margin-bottom:22px;font-family:'Courier New',monospace;text-shadow:0 1px 4px rgba(0,0,0,0.4);">${card.number}</div>

      <!-- Titulaire + expiration -->
      <div style="display:flex;justify-content:space-between;align-items:flex-end;">
        <div>
          <div style="font-size:9px;color:rgba(255,255,255,0.5);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;">Titulaire</div>
          <div style="font-size:15px;font-weight:700;color:white;letter-spacing:0.5px;">${currentUser.name.toUpperCase()}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:9px;color:rgba(255,255,255,0.5);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;">Expir√© fin</div>
          <div style="font-size:18px;font-weight:700;color:white;">${card.expiration}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Connecteur -->
  <div style="display:flex;justify-content:center;">
    <div style="width:30px;height:6px;background:linear-gradient(90deg,transparent,rgba(100,160,255,0.6),transparent);border-radius:3px;"></div>
  </div>

  <!-- PANNEAU INFOS -->
  <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(100,160,255,0.2);border-radius:18px;padding:18px;backdrop-filter:blur(8px);box-shadow:0 4px 20px rgba(0,0,0,0.3);">
    <!-- Num√©ro + bouton copier -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid rgba(255,255,255,0.08);">
      <div>
        <div style="font-size:9px;color:rgba(255,255,255,0.4);letter-spacing:2px;text-transform:uppercase;margin-bottom:5px;">Num√©ro de carte</div>
        <div style="font-size:15px;font-weight:600;color:white;font-family:'Courier New',monospace;letter-spacing:2px;">${card.number}</div>
      </div>
      <button id="copyCardBtn" onclick="copyToClipboard('${card.number.replace(/ /g,'')}');this.innerHTML='‚úÖ Copi√©!';this.style.background='linear-gradient(135deg,#27ae60,#2ecc71)';setTimeout(()=>{this.innerHTML='üìã Copier';this.style.background='linear-gradient(135deg,#1a3abf,#2550e8)'},2000)"
        style="padding:10px 18px;background:linear-gradient(135deg,#1a3abf,#2550e8);color:white;border:1px solid rgba(100,160,255,0.3);border-radius:12px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 4px 14px rgba(0,60,220,0.4);white-space:nowrap;">üìã Copier</button>
    </div>

    <!-- Expiration + CVV -->
    <div style="display:grid;grid-template-columns:1fr 1px 1fr;gap:16px;align-items:center;">
      <div>
        <div style="font-size:9px;color:rgba(255,255,255,0.4);letter-spacing:2px;text-transform:uppercase;margin-bottom:5px;">Date d'expiration</div>
        <div style="font-size:20px;font-weight:700;color:white;">${card.expiration}</div>
      </div>
      <div style="background:rgba(255,255,255,0.1);height:40px;"></div>
      <div style="padding-left:16px;">
        <div style="font-size:9px;color:rgba(255,255,255,0.4);letter-spacing:2px;text-transform:uppercase;margin-bottom:5px;">CVV</div>
        <div style="font-size:20px;font-weight:700;color:white;">${card.cvv}</div>
      </div>
    </div>
  </div>

  <!-- Avertissement -->
  <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(200,160,20,0.3);border-radius:16px;padding:14px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 12px rgba(0,0,0,0.2);">
    <span style="font-size:22px;">üîí</span>
    <span style="color:rgba(255,220,80,0.9);font-size:13px;font-weight:600;">Ne partagez jamais vos informations de carte.</span>
  </div>

  <!-- Bouton fermer -->
  <button onclick="document.getElementById('virtualCardModal').remove()" style="width:100%;padding:16px;background:linear-gradient(135deg,#1a3abf,#2550e8);color:white;border:1px solid rgba(100,160,255,0.3);border-radius:16px;font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(0,60,220,0.4);letter-spacing:0.5px;">Fermer</button>
</div>
`;

document.body.appendChild(modal);
modal.addEventListener('click',function(e){if(e.target===modal)modal.remove()});
}

function copyToClipboard(text){const t=document.createElement('textarea');t.value=text;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);alert('‚úÖ Copi√©!')}function editVirtualCard(accountId){const accounts=JSON.parse(localStorage.getItem('vantex_accounts'));const account=accounts.find(acc=>acc.id===accountId);if(!account)return;const card=account.virtualCard||{number:generateCardNumber(),expiration:generateExpirationDate(),cvv:generateCVV()};const modal=document.createElement('div');modal.className='modal active';modal.id='editCardModal';modal.innerHTML=`<div class="modal-content"><div class="modal-header"><h3>üí≥ Carte de ${account.name}</h3><button class="close-modal" onclick="closeEditCardModal()">√ó</button></div><form onsubmit="saveVirtualCard(${accountId});return false"><div class="form-group"><label>Num√©ro de carte</label><input type="text" id="cardNumber" value="${card.number}" maxlength="19" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px"><button type="button" onclick="document.getElementById('cardNumber').value=generateCardNumber()" style="margin-top:8px;padding:8px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer">üé≤ G√©n√©rer</button></div><div class="form-row"><div class="form-group"><label>Expiration (MM/AA)</label><input type="text" id="cardExpiration" value="${card.expiration}" maxlength="5" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px"><button type="button" onclick="document.getElementById('cardExpiration').value=generateExpirationDate()" style="margin-top:8px;padding:6px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer">üé≤</button></div><div class="form-group"><label>CVV</label><input type="text" id="cardCVV" value="${card.cvv}" maxlength="3" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px"><button type="button" onclick="document.getElementById('cardCVV').value=generateCVV()" style="margin-top:8px;padding:6px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer">üé≤</button></div></div><button type="submit" class="btn btn-primary" style="margin-top:15px">üíæ Enregistrer</button></form></div>`;document.body.appendChild(modal)}function saveVirtualCard(accountId){const cardNumber=document.getElementById('cardNumber').value.trim();const expiration=document.getElementById('cardExpiration').value.trim();const cvv=document.getElementById('cardCVV').value.trim();if(!cardNumber||cardNumber.replace(/\s/g,'').length!==16){alert('16 chiffres requis');return}if(!expiration.match(/^\d{2}\/\d{2}$/)){alert('Format: MM/AA');return}if(!cvv||cvv.length!==3){alert('CVV: 3 chiffres');return}const accounts=JSON.parse(localStorage.getItem('vantex_accounts'));const account=accounts.find(acc=>acc.id===accountId);account.virtualCard={number:cardNumber,expiration:expiration,cvv:cvv,updatedAt:new Date().toISOString()};localStorage.setItem('vantex_accounts',JSON.stringify(accounts));closeEditCardModal();loadAccountsTable();alert('‚úÖ Carte mise √† jour!')}function closeEditCardModal(){const modal=document.getElementById('editCardModal');if(modal)modal.remove()}initializeVirtualCards();console.log('‚úÖ Cartes virtuelles activ√©es');
</script>

<!-- ‚îÄ‚îÄ Modal confirmation custom ‚îÄ‚îÄ -->
<div id="vxConfirmModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:999998;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;">
    <!-- Fond flou -->
    <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(2,8,24,0.75);backdrop-filter:blur(6px);" onclick="closeConfirmModal()"></div>
    <!-- Carte -->
    <div style="position:relative;width:100%;max-width:340px;background:linear-gradient(145deg,#0d1b3e,#0a1628);border:1px solid rgba(100,160,255,0.2);border-radius:22px;padding:28px 24px 22px;box-shadow:0 24px 80px rgba(0,0,80,0.6);animation:vxModalIn 0.25s ease;">
        <style>@keyframes vxModalIn{from{opacity:0;transform:scale(0.92) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}</style>
        <!-- Ic√¥ne -->
        <div style="width:52px;height:52px;background:rgba(231,76,60,0.15);border:1.5px solid rgba(231,76,60,0.3);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;margin:0 auto 16px;">‚ö†Ô∏è</div>
        <!-- Titre -->
        <h3 id="vxConfirmTitle" style="color:white;font-size:17px;font-weight:800;text-align:center;margin:0 0 10px;"></h3>
        <!-- Message -->
        <p id="vxConfirmMsg" style="color:rgba(255,255,255,0.55);font-size:13px;line-height:1.6;text-align:center;margin:0 0 24px;"></p>
        <!-- Boutons -->
        <div style="display:flex;flex-direction:column;gap:10px;">
            <button id="vxConfirmOk" style="width:100%;padding:14px;background:linear-gradient(135deg,#c0392b,#e74c3c);border:none;border-radius:14px;color:white;font-size:14px;font-weight:700;cursor:pointer;letter-spacing:0.3px;box-shadow:0 6px 20px rgba(231,76,60,0.35);">Oui, annuler</button>
            <button onclick="closeConfirmModal()" id="vxConfirmCancel" style="width:100%;padding:14px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);border-radius:14px;color:rgba(255,255,255,0.75);font-size:14px;font-weight:600;cursor:pointer;">Continuer</button>
        </div>
    </div>
</div>

<script>
// closeConfirmModal ‚Äî modal confirmation
function closeConfirmModal() {
    document.getElementById('vxConfirmModal').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYST√àME DE TH√àME CLIENT PAR COMPTE ‚Äî VANTEX
// Cl√© Firebase : settings/theme_{email}  ou  settings/client_theme (global)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const THEME_DEFAULTS = {
    bg:'#0a0e1a', card:'#0d1b3e', card2:'#0a2a6e',
    accent:'#1a3abf', accent2:'#2550e8',
    green:'#00e5a0', red:'#ff6b6b', nav:'#0a0e1a'
};

const THEME_PRESETS = {
    'dark-blue':   { bg:'#0a0e1a', card:'#0d1b3e', card2:'#0a2a6e', accent:'#1a3abf', accent2:'#2550e8', green:'#00e5a0', red:'#ff6b6b', nav:'#0a0e1a' },
    'dark-green':  { bg:'#0a1a0f', card:'#0d3320', card2:'#0a3e1b', accent:'#1a7a3a', accent2:'#22a84e', green:'#00e5a0', red:'#ff6b6b', nav:'#0a1a0f' },
    'dark-purple': { bg:'#100a2e', card:'#1e0d4e', card2:'#2d0a6e', accent:'#6a1abf', accent2:'#8b2ee8', green:'#c084fc', red:'#ff6b6b', nav:'#100a2e' },
    'dark-red':    { bg:'#1a0a0a', card:'#3e0d0d', card2:'#5a1010', accent:'#bf1a1a', accent2:'#e82525', green:'#00e5a0', red:'#ff8c8c', nav:'#1a0a0a' },
    'dark-gold':   { bg:'#1a1500', card:'#3e3000', card2:'#5a4500', accent:'#a07800', accent2:'#c8922a', green:'#f4d03f', red:'#ff6b6b', nav:'#1a1500' },
    'light':       { bg:'#f0f4ff', card:'#ffffff', card2:'#e8ecff', accent:'#1a3abf', accent2:'#2550e8', green:'#00b894', red:'#e74c3c', nav:'#ffffff' }
};

// ‚îÄ‚îÄ Cl√© Firebase selon la cible ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _themeDocId(target) {
    // target = 'ALL' ‚Üí 'client_theme_ALL'
    // target = 'user@mail.com' ‚Üí 'client_theme_user@mail.com' (on encode @)
    return 'client_theme_' + (target === 'ALL' ? 'ALL' : target.replace(/[@.]/g, '_'));
}

// ‚îÄ‚îÄ Remplir le select avec les comptes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateThemeAccountSelect() {
    const sel = document.getElementById('themeTargetAccount');
    if (!sel) return;
    const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
    // Garder l'option ALL
    sel.innerHTML = '<option value="ALL">üì¢ Tous les comptes</option>';
    accounts.forEach(acc => {
        const opt = document.createElement('option');
        opt.value = acc.email;
        opt.textContent = 'üë§ ' + acc.name + ' ‚Äî ' + acc.email;
        sel.appendChild(opt);
    });
}

// ‚îÄ‚îÄ Quand on change la cible, charger son th√®me actuel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function onThemeTargetChange() {
    const target = document.getElementById('themeTargetAccount')?.value || 'ALL';
    const badge = document.getElementById('themeTargetBadge');
    const info = document.getElementById('currentThemeInfo');
    const label = document.getElementById('currentThemeLabel');

    if (target === 'ALL') {
        if (badge) { badge.textContent = 'Tous les comptes'; badge.style.background = '#fff3e0'; badge.style.color = '#e67e22'; }
    } else {
        const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
        const acc = accounts.find(a => a.email === target);
        if (badge && acc) { badge.textContent = acc.name; badge.style.background = '#e8f4fd'; badge.style.color = '#1a73e8'; }
    }

    // Charger le th√®me actuel de cette cible
    try {
        const docId = _themeDocId(target);
        const doc = await db.collection('settings').doc(docId).get();
        if (doc.exists) {
            const t = doc.data();
            setInputsFromTheme(t);
            if (info) info.style.display = 'block';
            if (label) label.textContent = '‚úÖ Th√®me personnalis√© existant charg√©';
        } else {
            // Pas de th√®me sp√©cifique ‚Üí charger d√©fauts
            setInputsFromTheme(THEME_DEFAULTS);
            if (info) info.style.display = 'block';
            if (label) label.textContent = '‚ö™ Aucun th√®me personnalis√© ‚Äî valeurs par d√©faut';
        }
    } catch(e) {
        setInputsFromTheme(THEME_DEFAULTS);
    }
}

// ‚îÄ‚îÄ Appliquer CSS (uniquement si c'est le bon compte connect√©) ‚îÄ
function applyThemeToCss(t) {
    const root = document.documentElement;
    root.style.setProperty('--cl-bg',      t.bg);
    root.style.setProperty('--cl-card',    t.card);
    root.style.setProperty('--cl-card2',   t.card2);
    root.style.setProperty('--cl-accent',  t.accent);
    root.style.setProperty('--cl-accent2', t.accent2);
    root.style.setProperty('--cl-green',   t.green);
    root.style.setProperty('--cl-red',     t.red);
    root.style.setProperty('--cl-nav',     t.nav);
    const ci = document.getElementById('clientInterface');
    if (ci) ci.style.background = t.bg;
    const nav = document.querySelector('.bottom-nav');
    if (nav) nav.style.background = t.nav;
    updateThemePreview(t);
}

function updateThemePreview(t) {
    const set = (id, prop, val) => { const el = document.getElementById(id); if (el) el.style[prop] = val; };
    set('pvBg',   'background', t.bg);
    set('pvCard', 'background', `linear-gradient(135deg,${t.card},${t.card2})`);
    set('pvBtn',  'background', `linear-gradient(135deg,${t.accent},${t.accent2})`);
    set('pvBtn2', 'background', `linear-gradient(135deg,${t.accent},${t.accent2})`);
    set('pvGreen','color', t.green);
    set('pvRed',  'color', t.red);
    set('pvNav',  'background', t.nav);
}

function getThemeFromInputs() {
    const v = id => document.getElementById(id)?.value || THEME_DEFAULTS[id.replace('th_','')];
    return { bg:v('th_bg'), card:v('th_card'), card2:v('th_card2'), accent:v('th_accent'), accent2:v('th_accent2'), green:v('th_green'), red:v('th_red'), nav:v('th_nav') };
}

function setInputsFromTheme(t) {
    ['bg','card','card2','accent','accent2','green','red','nav'].forEach(f => {
        const col = document.getElementById('th_' + f);
        const hex = document.getElementById('th_' + f + '_hex');
        if (col) col.value = t[f] || THEME_DEFAULTS[f];
        if (hex) hex.value = t[f] || THEME_DEFAULTS[f];
    });
    updateThemePreview(t);
}

function syncColorInput(colorId, hexId) {
    const hex = document.getElementById(hexId);
    const col = document.getElementById(colorId);
    if (hex && col && /^#[0-9a-fA-F]{6}$/.test(hex.value)) {
        col.value = hex.value;
        updateThemePreview(getThemeFromInputs());
    }
}

document.addEventListener('input', function(e) {
    if (e.target?.type === 'color' && e.target.id?.startsWith('th_')) {
        const hexInput = document.getElementById(e.target.id + '_hex');
        if (hexInput) hexInput.value = e.target.value;
        updateThemePreview(getThemeFromInputs());
    }
});

function applyThemePreset(name) {
    const t = THEME_PRESETS[name];
    if (!t) return;
    setInputsFromTheme(t);
}

// ‚îÄ‚îÄ Sauvegarder selon la cible s√©lectionn√©e ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveClientTheme() {
    const target = document.getElementById('themeTargetAccount')?.value || 'ALL';
    const t = { ...getThemeFromInputs(), updatedAt: new Date().toISOString(), target };

    const btn = document.querySelector('[onclick="saveClientTheme()"]');
    if (btn) { btn.innerHTML = '‚è≥ Sauvegarde...'; btn.disabled = true; }

    try {
        if (target === 'ALL') {
            // Sauver dans 'client_theme_ALL'
            await db.collection('settings').doc('client_theme_ALL').set(t);
            // Aussi dans l'ancien doc pour r√©trocompat
            await db.collection('settings').doc('client_theme').set(t);
        } else {
            // Sauver uniquement pour ce compte
            await db.collection('settings').doc(_themeDocId(target)).set(t);
        }

        // Si le compte connect√© est concern√©, appliquer imm√©diatement
        if (window.currentUser && (target === 'ALL' || target === window.currentUser.email)) {
            applyThemeToCss(t);
            localStorage.setItem('vantex_client_theme_' + window.currentUser.email, JSON.stringify(t));
        }

        if (btn) { btn.innerHTML = '‚úÖ Appliqu√© !'; btn.style.background = 'linear-gradient(135deg,#27ae60,#2ecc71)'; }
        setTimeout(() => {
            if (btn) { btn.innerHTML = 'üíæ Sauvegarder & Appliquer'; btn.disabled = false; btn.style.background = ''; }
        }, 2500);
    } catch(e) {
        alert('‚ùå Erreur : ' + e.message);
        if (btn) { btn.innerHTML = 'üíæ Sauvegarder & Appliquer'; btn.disabled = false; }
    }
}

// ‚îÄ‚îÄ R√©initialiser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetClientTheme() {
    setInputsFromTheme(THEME_DEFAULTS);
}

// ‚îÄ‚îÄ Charger le th√®me au login client (priorit√© : compte > global > d√©faut) ‚îÄ
async function loadClientThemeFromFirebase() {
    if (!window.currentUser) return;
    const email = window.currentUser.email;
    try {
        // 1. D'abord localStorage pour affichage imm√©diat
        const localKey = 'vantex_client_theme_' + email;
        const local = localStorage.getItem(localKey);
        if (local) applyThemeToCss(JSON.parse(local));

        // 2. Th√®me sp√©cifique au compte
        const docSpecific = await db.collection('settings').doc(_themeDocId(email)).get();
        if (docSpecific.exists) {
            const t = docSpecific.data();
            applyThemeToCss(t);
            localStorage.setItem(localKey, JSON.stringify(t));
            return;
        }

        // 3. Th√®me global (ALL)
        const docAll = await db.collection('settings').doc('client_theme_ALL').get();
        if (docAll.exists) {
            const t = docAll.data();
            applyThemeToCss(t);
            localStorage.setItem(localKey, JSON.stringify(t));
            return;
        }

        // 4. Ancien doc r√©trocompat
        const docOld = await db.collection('settings').doc('client_theme').get();
        if (docOld.exists) {
            applyThemeToCss(docOld.data());
        }
    } catch(e) { console.log('Theme load:', e.message); }
}

// ‚îÄ‚îÄ Peupler le select quand l'onglet th√®me s'ouvre ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// (hook√©e dans switchTab via le code existant)
window._onThemeTabOpen = function() {
    populateThemeAccountSelect();
    onThemeTargetChange();
};

// ‚îÄ‚îÄ Charger au d√©marrage DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', function() {
    // Charger th√®me apr√®s connexion Firebase
    setTimeout(loadClientThemeFromFirebase, 500);
});

// ‚îÄ‚îÄ Poll : appliquer les changements de th√®me aux clients connect√©s (10s) ‚îÄ
setInterval(async function() {
    if (!window.currentUser) return;
    const email = window.currentUser.email;
    const localKey = 'vantex_client_theme_' + email;
    try {
        // V√©rifier d'abord le th√®me sp√©cifique
        const docS = await db.collection('settings').doc(_themeDocId(email)).get();
        if (docS.exists) {
            const t = docS.data();
            const prev = localStorage.getItem(localKey);
            if (!prev || JSON.parse(prev).updatedAt !== t.updatedAt) {
                applyThemeToCss(t);
                localStorage.setItem(localKey, JSON.stringify(t));
            }
            return;
        }
        // Sinon th√®me global
        const docA = await db.collection('settings').doc('client_theme_ALL').get();
        if (docA.exists) {
            const t = docA.data();
            const prev = localStorage.getItem(localKey);
            if (!prev || JSON.parse(prev).updatedAt !== t.updatedAt) {
                applyThemeToCss(t);
                localStorage.setItem(localKey, JSON.stringify(t));
            }
        }
    } catch(e) {}
}, 10000);
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHAT MODAL ‚Äî C√îT√â CLIENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="clientChatModal" style="display:none;position:fixed;inset:0;z-index:99999;background:rgba(2,8,24,0.85);backdrop-filter:blur(6px);align-items:flex-end;justify-content:center;padding:0;">
    <div style="width:100%;max-width:480px;height:92vh;background:#0d1b3e;border-radius:24px 24px 0 0;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 -8px 40px rgba(0,0,80,0.6);">
        <!-- Header -->
        <div style="padding:16px 20px;background:linear-gradient(135deg,#1a3abf,#0d1b3e);display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.08);">
            <div style="width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#00e5a0,#00b894);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">üõ°Ô∏è</div>
            <div style="flex:1;">
                <div style="color:white;font-weight:700;font-size:15px;">Support VANTEX</div>
                <div id="clientChatStatusBar" style="color:#00e5a0;font-size:11px;display:flex;align-items:center;gap:4px;">
                    <span style="width:6px;height:6px;background:#00e5a0;border-radius:50%;display:inline-block;"></span> En ligne
                </div>
            </div>
            <button onclick="closeClientChat()" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);border-radius:50%;width:34px;height:34px;color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;">√ó</button>
        </div>

        <!-- Messages -->
        <div id="clientChatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth;">
            <!-- Message de bienvenue auto -->
            <div style="display:flex;gap:10px;align-items:flex-end;">
                <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#00e5a0,#00b894);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">üõ°Ô∏è</div>
                <div style="max-width:78%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);border-radius:18px 18px 18px 4px;padding:12px 14px;">
                    <div style="color:white;font-size:13px;line-height:1.5;">Bonjour üëã Bienvenue sur le support VANTEX. Comment puis-je vous aider ?</div>
                    <div style="color:rgba(255,255,255,0.35);font-size:10px;margin-top:4px;">Support</div>
                </div>
            </div>
        </div>

        <!-- Input client -->
        <div style="padding:12px 14px;background:#0a0e1a;border-top:1px solid rgba(255,255,255,0.07);display:flex;gap:10px;align-items:flex-end;">
            <textarea id="clientChatInput" placeholder="√âcrire un message..." rows="1"
                style="flex:1;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);border-radius:14px;padding:10px 14px;color:white;font-size:14px;resize:none;outline:none;font-family:inherit;max-height:90px;line-height:1.4;"
                onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();clientSendMessage();}"
                oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,90)+'px'"></textarea>
            <button onclick="clientSendMessage()" style="padding:10px 18px;background:linear-gradient(135deg,#1a3abf,#2550e8);color:white;border:none;border-radius:14px;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 4px 14px rgba(0,60,220,0.4);white-space:nowrap;">
                ‚Üë
            </button>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYST√àME DE MESSAGERIE VANTEX ‚Äî Firebase Firestore
// Collection : "support_messages"
// Document   : { id, fromEmail, fromName, toAdmin, message, date, read, side }
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _chatAdminEmail = null;   // email du client s√©lectionn√© c√¥t√© admin
let _chatPollInterval = null; // polling client
let _adminPollInterval = null;// polling admin

// ‚îÄ‚îÄ Utilitaires ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function _chatFmt(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
}

function _chatDateLabel(dateStr) {
    const d = new Date(dateStr);
    const now = new Date();
    const today = now.toDateString();
    const yesterday = new Date(now - 864e5).toDateString();
    if (d.toDateString() === today) return "Aujourd'hui";
    if (d.toDateString() === yesterday) return "Hier";
    return d.toLocaleDateString('fr-FR', { day:'2-digit', month:'long' });
}

// ‚îÄ‚îÄ C√îT√â CLIENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openClientChat() {
    const modal = document.getElementById('clientChatModal');
    modal.style.display = 'flex';
    loadClientChatMessages();
    // Poll toutes les 4 secondes
    if (_chatPollInterval) clearInterval(_chatPollInterval);
    _chatPollInterval = setInterval(loadClientChatMessages, 4000);
    // Effacer le point rouge et la notif Firebase
    const dot = document.getElementById('clientUnreadDot');
    if (dot) dot.style.display = 'none';
    _clearClientChatNotif();
}

function closeClientChat() {
    document.getElementById('clientChatModal').style.display = 'none';
    if (_chatPollInterval) { clearInterval(_chatPollInterval); _chatPollInterval = null; }
}

async function loadClientChatMessages() {
    if (!window.currentUser) return;
    const email = window.currentUser.email;
    try {
        // ‚úÖ Pas de orderBy combin√© √† where ‚Üí pas d'index composite requis
        const snap = await db.collection('support_messages')
            .where('fromEmail', '==', email)
            .get();
        const msgs = [];
        snap.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));

        // Tri c√¥t√© JS
        msgs.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Marquer les messages admin comme lus
        const batch = db.batch();
        snap.forEach(doc => {
            if (doc.data().side === 'admin' && !doc.data().read) {
                batch.update(doc.ref, { read: true });
            }
        });
        try { await batch.commit(); } catch(e) {}

        renderClientMessages(msgs);
    } catch(e) { console.error('Chat load error:', e); }
}

function renderClientMessages(msgs) {
    const container = document.getElementById('clientChatMessages');
    if (!msgs.length) return;

    let html = '';
    let lastDate = '';
    msgs.forEach(m => {
        const dLabel = _chatDateLabel(m.date);
        if (dLabel !== lastDate) {
            html += `<div style="text-align:center;margin:8px 0;"><span style="background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.4);font-size:11px;padding:3px 12px;border-radius:20px;">${dLabel}</span></div>`;
            lastDate = dLabel;
        }
        if (m.side === 'client') {
            html += `<div style="display:flex;justify-content:flex-end;">
                <div style="max-width:78%;background:linear-gradient(135deg,#1a3abf,#2550e8);border-radius:18px 18px 4px 18px;padding:10px 14px;">
                    <div style="color:white;font-size:13px;line-height:1.5;">${escapeHtml(m.message)}</div>
                    <div style="color:rgba(255,255,255,0.5);font-size:10px;margin-top:4px;text-align:right;">${_chatFmt(m.date)} ‚úì</div>
                </div>
            </div>`;
        } else {
            html += `<div style="display:flex;gap:10px;align-items:flex-end;">
                <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#00e5a0,#00b894);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">üõ°Ô∏è</div>
                <div style="max-width:78%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);border-radius:18px 18px 18px 4px;padding:10px 14px;">
                    <div style="color:white;font-size:13px;line-height:1.5;">${escapeHtml(m.message)}</div>
                    <div style="color:rgba(255,255,255,0.35);font-size:10px;margin-top:4px;">Support ¬∑ ${_chatFmt(m.date)}</div>
                </div>
            </div>`;
        }
    });

    // Ajouter le message de bienvenue au d√©but
    const welcome = `<div style="display:flex;gap:10px;align-items:flex-end;">
        <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#00e5a0,#00b894);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">üõ°Ô∏è</div>
        <div style="max-width:78%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);border-radius:18px 18px 18px 4px;padding:12px 14px;">
            <div style="color:white;font-size:13px;line-height:1.5;">Bonjour üëã Bienvenue sur le support VANTEX. Comment puis-je vous aider ?</div>
            <div style="color:rgba(255,255,255,0.35);font-size:10px;margin-top:4px;">Support</div>
        </div>
    </div>`;
    container.innerHTML = welcome + html;
    container.scrollTop = container.scrollHeight;
}

async function clientSendMessage() {
    if (!window.currentUser) return;
    const input = document.getElementById('clientChatInput');
    const text = input.value.trim();
    if (!text) return;

    // D√©sactiver le bouton pendant l'envoi
    const btn = input.nextElementSibling;
    const origText = btn.textContent;
    btn.textContent = '...';
    btn.disabled = true;
    input.value = '';
    input.style.height = 'auto';

    const msg = {
        fromEmail: window.currentUser.email,
        fromName: window.currentUser.name,
        message: text,
        date: new Date().toISOString(),
        side: 'client',
        read: false
    };

    try {
        const ref = await db.collection('support_messages').add(msg);
        console.log('‚úÖ Message envoy√©:', ref.id);
        await loadClientChatMessages();
        // Notifier l'admin (badge)
        updateAdminUnreadBadge();
    } catch(e) {
        console.error('‚ùå Send error:', e);
        // Remettre le texte en cas d'erreur
        input.value = text;
        alert('‚ùå Erreur envoi message: ' + e.message + '\n\nV√©rifiez les r√®gles Firestore.');
    } finally {
        btn.textContent = origText;
        btn.disabled = false;
    }
}

function escapeHtml(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ C√îT√â ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadAdminConversations() {
    try {
        // ‚úÖ Simple get() sans orderBy ‚Üí aucun index requis
        const snap = await db.collection('support_messages').get();
        const byEmail = {};
        snap.forEach(doc => {
            const d = doc.data();
            if (!byEmail[d.fromEmail]) {
                byEmail[d.fromEmail] = { email: d.fromEmail, name: d.fromName, messages: [], unread: 0 };
            }
            byEmail[d.fromEmail].messages.push({ id: doc.id, ...d });
            if (d.side === 'client' && !d.read) byEmail[d.fromEmail].unread++;
        });

        // Trier les messages de chaque conv par date (c√¥t√© JS)
        Object.values(byEmail).forEach(c => {
            c.messages.sort((a, b) => new Date(b.date) - new Date(a.date));
        });

        // Trier les convs par dernier message
        const convs = Object.values(byEmail).sort((a, b) => {
            const aLast = a.messages[0]?.date || '';
            const bLast = b.messages[0]?.date || '';
            return bLast.localeCompare(aLast);
        });

        renderAdminConvList(convs);

        // Badge global non lus
        const totalUnread = convs.reduce((s, c) => s + c.unread, 0);
        const badge = document.getElementById('adminUnreadBadge');
        if (badge) {
            badge.textContent = totalUnread;
            badge.style.display = totalUnread > 0 ? 'inline' : 'none';
        }

        // Si un client est s√©lectionn√©, rafra√Æchir ses messages
        if (_chatAdminEmail) {
            const conv = convs.find(c => c.email === _chatAdminEmail);
            if (conv) renderAdminMessages(conv.messages.slice().reverse());
        }
    } catch(e) { console.error('Admin conv load error:', e); }
}

function renderAdminConvList(convs) {
    const list = document.getElementById('adminConvList');
    if (!list) return;
    if (!convs.length) {
        list.innerHTML = '<div style="text-align:center;padding:30px 16px;color:#bbb;font-size:13px;"><div style="font-size:32px;margin-bottom:8px;">üí¨</div>Aucune conversation</div>';
        return;
    }
    list.innerHTML = convs.map(c => {
        const last = c.messages[0];
        const initials = (c.name || '?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
        const isSelected = c.email === _chatAdminEmail;
        return `<div onclick="selectAdminConv('${c.email}','${escapeHtml(c.name)}')"
            style="padding:12px;border-radius:12px;cursor:pointer;display:flex;align-items:center;gap:10px;margin-bottom:4px;background:${isSelected ? 'linear-gradient(135deg,#1a73e8,#0d47a1)' : 'white'};transition:all 0.2s;border:1px solid ${isSelected ? 'transparent' : '#f0f0f0'};">
            <div style="width:40px;height:40px;border-radius:50%;background:${isSelected ? 'rgba(255,255,255,0.2)' : 'linear-gradient(135deg,#1a73e8,#0d47a1)'};color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;">${initials}</div>
            <div style="flex:1;min-width:0;">
                <div style="font-weight:700;font-size:13px;color:${isSelected ? 'white' : '#1a1a2e'};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(c.name)}</div>
                <div style="font-size:11px;color:${isSelected ? 'rgba(255,255,255,0.7)' : '#999'};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${last ? escapeHtml(last.message) : '‚Äî'}</div>
            </div>
            ${c.unread > 0 ? `<span style="background:#e74c3c;color:white;border-radius:10px;padding:2px 7px;font-size:11px;font-weight:700;flex-shrink:0;">${c.unread}</span>` : ''}
        </div>`;
    }).join('');
}

async function selectAdminConv(email, name) {
    _chatAdminEmail = email;
    // Update header
    const initials = name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
    const avatar = document.getElementById('adminChatAvatar');
    if (avatar) avatar.textContent = initials;
    const nameEl = document.getElementById('adminChatName');
    if (nameEl) nameEl.textContent = name;
    const statusEl = document.getElementById('adminChatStatus');
    if (statusEl) statusEl.textContent = email;

    // Charger messages de ce client
    try {
        // ‚úÖ Sans orderBy ‚Üí pas d'index requis, tri c√¥t√© JS
        const snap = await db.collection('support_messages')
            .where('fromEmail', '==', email)
            .get();
        const msgs = [];
        const batch = db.batch();
        snap.forEach(doc => {
            msgs.push({ id: doc.id, ...doc.data() });
            if (doc.data().side === 'client' && !doc.data().read) {
                batch.update(doc.ref, { read: true });
            }
        });
        try { await batch.commit(); } catch(e) {}
        // Trier c√¥t√© JS
        msgs.sort((a, b) => new Date(a.date) - new Date(b.date));
        renderAdminMessages(msgs);
        loadAdminConversations(); // Refresh liste pour enlever badges
    } catch(e) { console.error(e); }
}

function renderAdminMessages(msgs) {
    const container = document.getElementById('adminChatMessages');
    if (!container) return;
    if (!msgs.length) {
        container.innerHTML = '<div style="text-align:center;color:#bbb;font-size:13px;margin:auto;">Aucun message</div>';
        return;
    }
    let html = '';
    let lastDate = '';
    msgs.forEach(m => {
        const dLabel = _chatDateLabel(m.date);
        if (dLabel !== lastDate) {
            html += `<div style="text-align:center;margin:8px 0;"><span style="background:#e8ecf4;color:#999;font-size:11px;padding:3px 12px;border-radius:20px;">${dLabel}</span></div>`;
            lastDate = dLabel;
        }
        if (m.side === 'client') {
            html += `<div style="display:flex;gap:8px;align-items:flex-end;">
                <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#1a73e8,#0d47a1);color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;">${(m.fromName||'?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase()}</div>
                <div style="max-width:70%;background:white;border:1px solid #e8e8e8;border-radius:18px 18px 18px 4px;padding:10px 14px;box-shadow:0 1px 4px rgba(0,0,0,0.06);">
                    <div style="color:#1a1a2e;font-size:13px;line-height:1.5;">${escapeHtml(m.message)}</div>
                    <div style="color:#bbb;font-size:10px;margin-top:4px;">${_chatFmt(m.date)}</div>
                </div>
            </div>`;
        } else {
            html += `<div style="display:flex;justify-content:flex-end;">
                <div style="max-width:70%;background:linear-gradient(135deg,#1a73e8,#0d47a1);border-radius:18px 18px 4px 18px;padding:10px 14px;">
                    <div style="color:white;font-size:13px;line-height:1.5;">${escapeHtml(m.message)}</div>
                    <div style="color:rgba(255,255,255,0.5);font-size:10px;margin-top:4px;text-align:right;">Vous ¬∑ ${_chatFmt(m.date)} ‚úì</div>
                </div>
            </div>`;
        }
    });
    container.innerHTML = html;
    container.scrollTop = container.scrollHeight;
}

async function adminSendMessage() {
    if (!_chatAdminEmail) { alert('S√©lectionnez d\'abord une conversation'); return; }
    const input = document.getElementById('adminChatInput');
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    input.style.height = 'auto';

    const msg = {
        fromEmail: _chatAdminEmail,
        fromName: document.getElementById('adminChatName')?.textContent || 'Client',
        message: text,
        date: new Date().toISOString(),
        side: 'admin',
        read: false
    };

    try {
        await db.collection('support_messages').add(msg);
        // Notif client (badge point rouge)
        notifyClientNewMessage(_chatAdminEmail);
        selectAdminConv(_chatAdminEmail, document.getElementById('adminChatName')?.textContent || '');
    } catch(e) { console.error('Admin send error:', e); alert('Erreur envoi'); }
}

async function notifyClientNewMessage(email) {
    // Stocker une notification l√©g√®re pour le client
    try {
        await db.collection('chat_notifications').doc(email).set({
            hasNew: true,
            date: new Date().toISOString()
        });
    } catch(e) {}
}

async function updateAdminUnreadBadge() {
    try {
        // ‚úÖ Un seul where, filtre read=false c√¥t√© JS
        const snap = await db.collection('support_messages')
            .where('side', '==', 'client')
            .get();
        let unread = 0;
        snap.forEach(doc => { if (!doc.data().read) unread++; });
        const badge = document.getElementById('adminUnreadBadge');
        if (badge) {
            badge.textContent = unread;
            badge.style.display = unread > 0 ? 'inline' : 'none';
        }
    } catch(e) {}
}

// V√©rifier les nouveaux messages admin pour le client (point rouge)
async function checkClientNewMessages() {
    if (!window.currentUser) return;
    try {
        const doc = await db.collection('chat_notifications').doc(window.currentUser.email).get();
        if (doc.exists && doc.data().hasNew) {
            const dot = document.getElementById('clientUnreadDot');
            if (dot) dot.style.display = 'block';
        }
    } catch(e) {}
}

// Reset la notification client quand il ouvre le chat
const _origOpenClientChat = openClientChat;
// (openClientChat d√©j√† d√©finie plus haut, on ajoute le reset)
async function _clearClientChatNotif() {
    if (!window.currentUser) return;
    try {
        await db.collection('chat_notifications').doc(window.currentUser.email).set({ hasNew: false });
    } catch(e) {}
}

// Hook sur switchTab pour d√©marrer le poll admin
const _origSwitchTab = window.switchTab || function(){};

// ‚îÄ‚îÄ D√©marrage des polls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', function() {
    // Poll admin badge toutes les 5s
    setInterval(updateAdminUnreadBadge, 5000);
    // Poll client point rouge toutes les 5s
    setInterval(checkClientNewMessages, 5000);
});

// D√©marrer le poll admin quand l'onglet support est ouvert
function _startAdminChatPoll() {
    if (_adminPollInterval) clearInterval(_adminPollInterval);
    console.log('üîÑ Poll admin chat d√©marr√©');
    // Test de lecture imm√©diat
    db.collection('support_messages').limit(1).get()
        .then(s => console.log('‚úÖ Firestore support_messages accessible, docs:', s.size))
        .catch(e => console.error('‚ùå Firestore support_messages INACCESSIBLE:', e.message));
    _adminPollInterval = setInterval(loadAdminConversations, 4000);
    loadAdminConversations();
}

function _stopAdminChatPoll() {
    if (_adminPollInterval) { clearInterval(_adminPollInterval); _adminPollInterval = null; }
}

// Patcher switchTab pour d√©marrer/arr√™ter le poll admin
(function() {
    const origSwitchTab = window.switchTab;
    if (typeof origSwitchTab === 'function') {
        window.switchTab = function(tabName, el) {
            origSwitchTab(tabName, el);
            if (tabName === 'support') _startAdminChatPoll();
            else _stopAdminChatPoll();
        };
    }
})();

// Pour le client : d√©marrer le check des notifs d√®s la connexion
const _origShowClientInterface = window.showClientInterface;
// Ajout dans le polling global client
setInterval(function() {
    if (window.currentUser) checkClientNewMessages();
}, 6000);
</script>

<!-- ‚îÄ‚îÄ Modal Admin Login S√©curis√© ‚îÄ‚îÄ -->
<div id="vxAdminModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:999997;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;">
    <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(2,8,24,0.85);backdrop-filter:blur(8px);"></div>
    <div style="position:relative;width:100%;max-width:360px;background:linear-gradient(145deg,#0d1b3e,#060e22);border:1px solid rgba(100,160,255,0.2);border-radius:24px;padding:28px 24px;box-shadow:0 30px 100px rgba(0,0,80,0.7);">
        <!-- Bouton fermer -->
        <button onclick="closeAdminLoginModal()" style="position:absolute;top:14px;right:14px;background:rgba(255,255,255,0.08);border:none;border-radius:50%;width:30px;height:30px;color:rgba(255,255,255,0.5);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;">‚úï</button>
        <!-- Contenu dynamique -->
        <div id="vxAdminModalBody"></div>
    </div>
</div>

<!-- ‚îÄ‚îÄ Section config TOTP dans panneau admin ‚îÄ‚îÄ -->


<script>
// ‚îÄ‚îÄ S√©curit√© admin : fonctions de configuration ‚îÄ‚îÄ
function loadSecurityTab() {
    const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');

    // Pr√©-remplir les champs avec les valeurs actuelles
    const pw2El = document.getElementById('sec_pw2');
    const qEl   = document.getElementById('sec_q');
    const ansEl = document.getElementById('sec_ans');
    if (pw2El) pw2El.placeholder = admin.password2 ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (d√©fini)' : 'D√©finir un 2√®me mot de passe';
    if (qEl)   qEl.value  = admin.securityQuestion || '';
    if (ansEl) ansEl.placeholder = admin.securityAnswer ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (d√©fini)' : 'Votre r√©ponse secr√®te';

    // Afficher la cl√© TOTP actuelle
    const secret = admin.totpSecret || 'JBSWY3DPEHPK3PXP';
    const secretEl = document.getElementById('totp_secret_display');
    if (secretEl) secretEl.textContent = secret;

    // QR code via balise <img> directe (fonctionne partout)
    const qrContainer = document.getElementById('totp_qr_container');
    if (qrContainer) {
        const email = admin.email || 'admin@vantex.com';
        const uri = encodeURIComponent('otpauth://totp/VANTEX:' + email + '?secret=' + secret + '&issuer=VANTEX');
        const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + uri;
        qrContainer.innerHTML = `
            <img src="${qrUrl}" width="200" height="200" style="border-radius:10px;border:3px solid #e8ecf0;" onerror="this.outerHTML='<p style=\'color:#e74c3c;font-size:12px;\'>‚ùå Impossible de charger le QR. Utilisez la cl√© manuelle ci-dessous.</p>'">
            <p style="color:#555;font-size:11px;margin:10px 0 4px;">Cl√© √† saisir manuellement dans l'app :</p>
            <p id="totp_secret_display" style="font-family:monospace;font-size:15px;font-weight:800;color:#1a56db;letter-spacing:3px;word-break:break-all;">${secret}</p>
            <p style="color:#888;font-size:11px;margin:6px 0 0;">Ouvrez Google Authenticator ‚Üí Ôºã ‚Üí Cl√© manuelle</p>
        `;
    }

    // Compteur appareils de confiance
    const devCountEl = document.getElementById('trusted_devices_count');
    if (devCountEl) {
        const trusted = admin.trustedDevices || [];
        devCountEl.textContent = trusted.length === 0
            ? 'üì± Aucun appareil de confiance enregistr√©'
            : 'üì± ' + trusted.length + ' appareil(s) de confiance enregistr√©(s)';
    }

    // Statut blocage
    const statusEl = document.getElementById('secBlockStatus');
    const msgEl = document.getElementById('secBlockMsg');
    if (statusEl && msgEl) {
        if (admin.blockedUntil && Date.now() < admin.blockedUntil) {
            const mins = Math.ceil((admin.blockedUntil - Date.now()) / 60000);
            statusEl.style.display = 'block';
            msgEl.textContent = 'üîí Acc√®s admin bloqu√© ‚Äî ' + mins + ' minute(s) restante(s)';
        } else {
            statusEl.style.display = 'none';
        }
    }

    // Badge TOTP configur√©
    const totpBadge = document.getElementById('totp_status_badge');
    if (totpBadge) {
        totpBadge.textContent = admin.totpConfigured ? '‚úÖ Configur√©' : '‚ö†Ô∏è Non configur√©';
        totpBadge.style.color = admin.totpConfigured ? '#10b981' : '#f59e0b';
    }
}

function saveSecuritySettings() {
    const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');
    const pw2 = (document.getElementById('sec_pw2')?.value || '').trim();
    const q   = (document.getElementById('sec_q')?.value || '').trim();
    const ans = (document.getElementById('sec_ans')?.value || '').trim();

    let changed = [];
    if (pw2) { admin.password2 = pw2; changed.push('2√®me mot de passe'); }
    if (q)   { admin.securityQuestion = q; changed.push('question secr√®te'); }
    if (ans) { admin.securityAnswer = ans; changed.push('r√©ponse secr√®te'); }

    if (changed.length === 0) {
        alert('‚ÑπÔ∏è Aucune modification. Remplissez au moins un champ.');
        return;
    }

    // Sauvegarder localement
    localStorage.setItem('vantex_admin', JSON.stringify(admin));

    // Sync Firebase avec gestion d'erreur
    if (window.db) {
        const { id, ...adminData } = admin;
        window.db.collection('settings').doc('admin-security').set({ id: 'admin', ...admin })
            .then(() => console.log('‚úÖ S√©curit√© sync Firebase'))
            .catch(e => console.warn('‚ö†Ô∏è Firebase sync:', e));
    }

    // Vider les champs sensibles
    if (document.getElementById('sec_pw2')) document.getElementById('sec_pw2').value = '';
    if (document.getElementById('sec_ans')) document.getElementById('sec_ans').value = '';

    alert('‚úÖ Enregistr√© avec succ√®s !

Modifications : ' + changed.join(', '));
    loadSecurityTab();
}

function generateNewTOTPSecret() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let secret = '';
    for (let i = 0; i < 16; i++) secret += chars[Math.floor(Math.random() * chars.length)];

    // Sauvegarder directement
    const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');
    admin.totpSecret = secret;
    admin.totpConfigured = true;
    localStorage.setItem('vantex_admin', JSON.stringify(admin));
    if (window.db) {
        window.db.collection('settings').doc('admin-security').set({ id: 'admin', ...admin })
            .catch(e => console.warn('Firebase:', e));
    }

    // Recharger le tab pour afficher le nouveau QR code
    loadSecurityTab();
    alert('‚úÖ Nouvelle cl√© TOTP g√©n√©r√©e et enregistr√©e !

Scannez maintenant le nouveau QR code avec Google Authenticator.

Cl√© : ' + secret);
}

function resetAdminBlock() {
    const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');
    admin.loginAttempts = 0;
    admin.blockedUntil = null;
    localStorage.setItem('vantex_admin', JSON.stringify(admin));
    if (window.db) window.db.collection('settings').doc('admin-security').set({ id: 'admin', ...admin }).catch(()=>{});
    alert('‚úÖ Blocage lev√©. L'acc√®s admin est de nouveau disponible.');
    loadSecurityTab();
}

function revokeAllTrustedDevices() {
    if (!confirm('R√©voquer tous les appareils de confiance ? Tous les appareils devront repasser par les 3 √©tapes de s√©curit√©.')) return;
    const admin = JSON.parse(localStorage.getItem('vantex_admin') || '{}');
    admin.trustedDevices = [];
    localStorage.setItem('vantex_admin', JSON.stringify(admin));
    if (window.db) window.db.collection('settings').doc('admin-security').set({ id: 'admin', ...admin }).catch(()=>{});
    alert('‚úÖ Tous les appareils r√©voqu√©s. Les 3 √©tapes seront requises √† la prochaine connexion.');
    loadSecurityTab();
}

// Charger la section s√©curit√© quand on clique sur l'onglet
const _origSwitchTab = window.switchTab;
window.switchTab = function(tabName, el) {
    if (typeof _origSwitchTab === 'function') _origSwitchTab(tabName, el);
    if (tabName === 'security') setTimeout(loadSecurityTab, 100);
};
</script>
</body>
</html>